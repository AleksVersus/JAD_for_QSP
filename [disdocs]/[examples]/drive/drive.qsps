# !--tester--!
!"<h1>игровая механика для игр на платформе QSP.</h1>
для нормального функционирования требуется подключение бибилотеки <font color=#880000>easy.math.qsp</font>"
"Благодарности:
Nex, Olegus, MasterSet - большая часть созданных здесь систем работает только благодаря их вольному или невольному участию.
Dower.Hollower	-	благодаря которому я нашёл ошибку в календаре."
addqst	'bases.qsp'
addqst	'intro.qsp'
addqst	'lib/easy.titles.qsp'
addqst	'lib/easy.math.qsp'
usehtml=0
$usercom='inputText'
$GAME_INTERFACE['обучение']="show"
$GAME_INTERFACE['подсказки']="show"
$GAME_INTERFACE['show.input']="show"
$GAME_INTERFACE['show.acts']="hide"
$GAME_INTERFACE['show.stat']="hide"
$GAME_INTERFACE['maintxt']="horizonta"
gs 'setScreen'
$property['hero.sex']='мужской'
time['month']=13
time['hour']=4
$repetition[0]="fuck"
'Вы запустили тестовую локацию движка MAGICON.FB. Если вы искали игру, может быть она называется как-то иначе.'
$lvar['локация.исходник'] = {
1[th]Стояло прекрасное [ty]летнее|осеннее|зимнее|весеннее[/ty] утро.
2|Стоял замечательный [ty]летний|осенний|+зимний|весенний[/ty] день.|Стоял необычайно тихий 
3[ty]летний|о+сенний|зимний|весенний[/ty] вечер.|Тиха [ty]летняя|осенняя|зимняя|весенняя
4[/ty] украин+ +ская ночь.[/th]

5Внешней гра=ницы пуст+ые обещания. (Дорогой/Дорогая), ты помнишь, о чём мы говорили? (Мальчик Мой/Девочка Моя), кто шёлковыми пальцами расчёсывает твои золотые кудри?
6[var]time|Январь|Февраль|Март|Апрель|Май|Июнь|Июль|Август|Сентябрь|Октябрь|Ноябрь|Декабрь[/var]
7[var]$repetition|Январь|Февраль|Март| " 9 " ;;Апрель|Май|-9;;Июнь|Июль|3;;Август| " fuck" ;;Сентябрь|Октябрь|Ноябрь|Декабрь[/var]
8[var]time;;hour|ночь|5;;6;;7;;8;;9;;10;;утро|11;;12;;13;;14;;15;;16;;17;;день|18;;19;;20;;21;;22;;вечер[/var]
9====Заголовок 1=======Заго=+ловок 2=====За+=го=ловок 3==++++За=головок 4+++++++Заголовок 5+++++Загол+овок 6++<br>
}
$lvar['qut']={Адское Пекло и Небеса -
Я весь мир мечтаю продать.
Время - деньги. Пусть стрелки бегут на часах -
И мне нечего больше желать.}
$func('#str.inArray#',$lvar['qut'],'$mass','("|'+"'"+'|!|\?|-|,|;|:|\.| |
)','NOTSPACE REGULAR LCASE')
$func('inputText','arr $mass')
$func('get.tag.num','color="ff8899"[rem:zzzfff]','color')+'-1'
$func('get.tag.num',"color=#uuuhhh",'color\h')+'-2'
$func('get.tag.num','color:66ff88
  8','color')+'-3'
$func('get.tag.cont','[name:Дублоны:name] <nocount><!-- [color:888800] <num:</nocount><nocount>-!><!--дублон|дублона|дублонов:num></noco-->unt>','<!--!>')+'-4'
$func('get.tag.num','<font color=#88ff88>Какой-то текст</font>','color')
func('get.tag.num','[stoim:561] [color:008800]','stoim')
--- !--tester--! ---------------------------------

# onObjSel
killvar '$menu_OOS'
killvar '$tempOOS_id'
killvar 'OOS'
killvar '$OOS'
$OOS['oid']=$func('get.tag.cont',$selobj,'oid')	&	!	получаем ай-ди выделенного объекта. Айди хранится в виде html тега <oid: :oid>
OOS['pos']=arrpos('$id_array',$OOS['oid'])	&	!	получаем его позицию в базе
$OOS['obj']=$object_array[OOS['pos']]	&	!	получаем его тело
$OOS['np']=$func('get.tag.cont',$OOS['obj'],'np')	&	!	набор признаков
$OOS['short_word']=$func('get.tag.cont',$OOS['obj'])	&	!	ключевое слово, ай-ди вида
! В зависимости от класса, производим операции
if instr($OOS['obj'],'[nocount]')!0:
! неисчислимый предмет, помещённый в панель инвентаря!!!
	!заменяем данные на данные кошелька.
	if $func('get.daughter.obj','INVENTORY','<money>','$tempOOS_id')='true': $OOS['oid']=$tempOOS_id[]
	killvar '$tempOOS_id'
	OOS['pos']=arrpos('$id_array',$OOS['oid'])	&	!	получаем его позицию в базе
	$OOS['obj']=$object_array[OOS['pos']]
	! отправляемся к выводу содержимого кошелька. {Заменить на подпрограмму.}
	jump 'money_print'
elseif instr($OOS['obj'],'<body>')!0:
! если объект является "частью тела" в дополнительное окно описания выводятся все имеющиеся "предметы",
! которые можно надеть на указанную часть тела.
	! Вычисляем часть тела:
	$OOS['pos_list']=$func('get.tag.cont',$OOS['obj'])
	!	1	производим поиск дочерних объектов в инвентаре по классу <bag> и <obj>
	killvar '$tempOOS_id'
	gs 'get.daughter.obj.all','INVENTORY','(<bag>|<obj>)+','$tempOOS_id'
	! Теперь у нас есть все предметы, какие только возможны. Из них мы отсеиваем все, которые невозможно одеть на нашу часть тела.
		OOS['p']=arrsize('$tempOOS_id')-1
		:while1
		if OOS['p']>-1:
			killvar '$array_body_part'
			if $func('prv.pos.inObj',$tempOOS_id[OOS['p']])='empty':
				OOS['t']=0
				:mass
				$array_body_part_pos[OOS['t']]=$func('get.tag.cont',$object_array[arrpos('$id_array',$array_body_part[OOS['t']])])
				OOS['t']+=1
				if OOS['t']<arrsize('$array_body_part'):jump 'mass'
				if arrcomp('$array_body_part_pos','[\s\S]*'+$OOS['pos_list']+'[\s\S]*')!-1: $print['obj_in_pos']+=$func('gen.ahref.actObj',$tempOOS_id[OOS['p']])+'<br>'
			end
			killvar '$array_body_part_pos'
			killvar '$array_body_part'
			OOS['p']-=1
			jump 'while1'
		end
	killvar '$tempOOS_id'
	!	1	список дочерних объектов уничтожается
	if $print['obj_in_pos']!'': $print['obj_in_pos']=$func('b.w.s','obj.inPos')+'<br>'+$print['obj_in_pos'] else $print['obj_in_pos']=$func('b.w.s','none.obj.inPos')
elseif instr($OOS['obj'],'<obj>')!0:
! если объект является "предметом"
	$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.property')+':menu.obj.property'
	$menu_OOS[arrsize('$menu_OOS')]='-:-'
	! действия над типовыми объектами:
	if instr($OOS['np'],'[книга]')!0: $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.read')+':menu.obj.read'
	if instr($OOS['np'],'[огнестрельное]')!0:
		$args['daughters.arm']=$func('get.daughter.obj',$OOS['oid'],'','$id_arm_temp')
		if $args['daughters.arm']='true': $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.disCharge')+':menu.obj.disCharge'
		killvar '$id_arm_temp'
	end
	if instr($OOS['np'],'[еда]')!0: $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.eat')+':menu.obj.eat'
	if instr($OOS['np'],'[свиток]')!0:
		$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.spell.read')+':menu.obj.spell.read'
		$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.spell.teach')+':menu.obj.spell.teach'
	end
	if $strfind($func('get.loc.id'),'(\[с:[\d]+\]_[\S\s]+|сундук;|chest;)')<>'':
		$args['loc.id.13']=$func('get.obj.id',$cvar['loc_id'+$cvar['chest']])
		$args['spec.head']=$func('get.tag.cont',$args['loc.id.13'],'spec')
		if instr($args['spec.head'],'[smithing]')!0 and instr($object_array[arrpos('$id_array',$position_array[OOS['pos']])],'<body>')=0:
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.unmount')+':menu.obj.unmount'
		end
		if instr($args['spec.head'],'[altar]')!0 and instr($OOS['np'],'[посох]')!0:
		! специальные качества локации - алтарь, и предмет заряжаемый
			! получаем дочерние объекты алтаря
			$args['onAltar']=$func('get.daughter.obj',$cvar['loc_id'+$cvar['chest']],'','$id_obj_onaltar','!<onALTAR>[\s\S]*!</onALTAR>')
			killvar '$id_obj_onaltar'
			if $args['onAltar']<>'true': $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put.onAltar')+':menu.obj.put.onAltar'
		end
	end
	if instr($OOS['np'],'[патроны]')!0: $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.inCharge')+':menu.obj.inCharge'
	! действия над типовыми объектами
	gs 'int.menu.obj',$OOS['obj']	&	!	вытаскивает  меню из тегов menu::menu
	$OOS['bdy']=$func('prv.str.inObj',$position_array[OOS['pos']],'<body>')
	$OOS['inv']=$func('prv.str.inObj',$position_array[OOS['pos']],'<inventory>')
	$OOS['bag']=$func('prv.str.inObj',$position_array[OOS['pos']],'<bag>')
	if $OOS['bdy']='true' or $OOS['inv']='true':
	! если предмет находится в позиции части тела или инвентаре, действие меню "убрать в сумку"
		killvar '$tempOOS_id'
		if $func('get.daughter.obj','INVENTORY','<bag>','$tempOOS_id')='true': $menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.in.bag')+':menu.in.bag'
		killvar '$tempOOS_id'
	end
	if ($OOS['bag']='true' or $OOS['inv']='true') and (instr($OOS['obj'],'[оружие]')!0 or instr($OOS['obj'],'[доспех]')!0 or instr($OOS['obj'],'[стрелы]')!0 or instr($OOS['obj'],'[болты]')!0):
	! если предмет находится непосредственно в инвентаре, или сумке, действие "использовать" (одеть)
		$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.in.body')+':menu.in.body'
	end
	if $OOS['bag']='true' or $OOS['bdy']='true':
	! если предмет находится непосредственно на теле, или сумке, действие "убрать в инвентарь"
		$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.in.inventory')+':menu.in.inventory'
	end
	OOS['heading_n']=arrpos('$id_array',$func('get.loc.id'))
	if $strfind($object_array[OOS['heading_n']],'\[put.stop\]')='':
		$menu_OOS[arrsize('$menu_OOS')]='-:-'
		if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'':
			args['stoim']=func('get.tag.num',$OOS['obj'],"stoim")
			$args['stoimost']=$func('#indiv#',func('obj.sale.cost',args['stoim'],$func('get.loc.id')),100,1)
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put','sale',$args['stoimost'])+':menu.obj.put'
		elseif $strfind($func('get.loc.id'),'(\[м:[\d]+\]_[\S\s]+|place;|место;)')!'':
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put','put')+':menu.obj.put'
		elseif instr($args['spec.head'],'[smithing]')!0:
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put','smithing')+':menu.obj.put'
		elseif instr($args['spec.head'],'[altar]')!0:
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put','altar')+':menu.obj.put'
		else
			$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.put','chest')+':menu.obj.put'
		end
	end
elseif instr($OOS['obj'],'<money>')!0:
! если выделенным объектом является кошелёк
	:money_print
	$args['color']=$func('get.tag.num',$OOS['obj'],'color')
	$args['name']=$func('get.tag.cont',$OOS['obj'],'name')
	$args['name']=$func('get.word.padez',$args['name'],'И')
	$print['money']+='<font color=#'+$args['color']+' face="CyrillicOld" size=+1><b>'+$args['name']+':</b></font><br>'
	$args['gdo.money']=$func('get.daughter.obj',$OOS['oid'],'','$tempOOS_id')
	if $args['gdo.money']='true':
		! находим все объекты в кошельке и выводим информацию:
		:for2
		if arrsize('$tempOOS_id')>0:
			OOS['pos1']=arrpos('$id_array',$tempOOS_id[0])
			$args['name_obj']=$func('get.tag.cont',$object_array[OOS['pos1']],'name')
			$args['name_obj']=$func('get.word.padez',$args['name_obj'],'И')
			$print['money']+='<font color=#'+$func('get.tag.num',$object_array[OOS['pos1']],'color')+'><b>'+$args['name_obj']+':</b></font> <font color=#666600><b>'+str(kolvo_array[OOS['pos1']])+'</b></font><br>'
			killvar '$tempOOS_id',0
			jump 'for2'
		end
	end
elseif instr($OOS['obj'],'<keys>')!0:
! если выделенным объектом является связка ключей
	$args['color']=$func('get.tag.num',$OOS['obj'],'color')
	$args['name']=$func('get.tag.cont',$OOS['obj'],'name')
	$args['name']=$func('get.word.padez',$args['name'],'И')
	$print['key.table']+='<font color=#'+$args['color']+' face="CyrillicOld" size=+1><b>'+$args['name']+':</b></font><br>'
	if $func('get.daughter.obj',$OOS['oid'],'<key>','$tempOOS_id')='true':
		$print['key.table']+= '<table cellspacing=0 cellpadding=5 bgcolor=#ffff88><tr><td align=left bgcolor=#bbbb44><font size=-3>'+$func('b.d.t','table.key')+':</font></td><td align=center bgcolor=#cccc55><font size=-3>'+$func('b.d.t','table.iner')+':</font></td><td align=center bgcolor=#bbbb44><font size=-3>'+$func('b.d.t','table.open')+':</font></td><td align=center bgcolor=#cccc55><font size=-3>'+$func('b.d.t','table.level')+':</font></td></tr>'
		:new
		if arrsize('$tempOOS_id')>0:
			OOS['pos1']=arrpos('$id_array',$tempOOS_id[0])
			$OOS['key'] = $func('get.tag.cont',$object_array[OOS['pos1']],'name')
			$OOS['key'] = $func('get.word.padez',$OOS['key'],'И')
			if $OOS['key']='': $OOS['key'] = $func('b.d.t','table.noname')
			if $func('get.tag.num',$object_array[OOS['pos1']],'open')!'':	$OOS['open']	=	$func('get.tag.num',$object_array[OOS['pos1']],'open')
			if kolvo_array[OOS['pos1']]!0:	$OOS['count']	=	str(kolvo_array[OOS['pos1']])
			if $func('get.tag.num',$object_array[OOS['pos1']],'breake')!'':	$OOS['breake']=	$func('get.tag.num',$object_array[OOS['pos1']],'breake')
			$print['key.table']+= '<tr><td align=left bgcolor=#dddd66><font size=-3>'+$OOS['key']+'</font></td><td align=center bgcolor=#eeee77><font size=-3>'+$OOS['count']+'</font></td><td align=center bgcolor=#dddd66><font size=-3>'+$OOS['open']+'</font></td><td align=center bgcolor=#eeee77><font size=-3>'+$OOS['breake']+'</font></td></tr>'
			killvar '$tempOOS_id',0
			jump 'new'
		end
		$print['key.table']+='</table>'
	end
elseif instr($OOS['obj'],'<diary>')!0:
! если выделенным объектом является дневник
	gs 'int.diary',$OOS['oid']
	killvar '$result'
	killvar '$menu_OOS'
	killvar '$tempOOS_id'
	killvar 'OOS'
	killvar '$OOS'
	unselect
	exit
	! Выведение записей дневника, в т.ч. подзаданий, стадий задания и пр.
elseif instr($OOS['obj'],'<hero>')!0:
! если выделенным объектом является герой
	! Выводятся свойства героя
	killvar '$tempOOS_id'
	! выводит все свойства героя, кроме скрытых
	if $func('get.daughter.obj',$OOS['oid'],'<property>','$tempOOS_id')='true':
		:property
		if arrsize('$tempOOS_id')>0:
			if $func('prv.str.inObj',$tempOOS_id[0],'\[hide\]')='false': $print['hero.property']+=$func('int.hero.property',$tempOOS_id[0])
			killvar '$tempOOS_id',0
			jump 'property'
		end
		killvar '$tempOOS_id'
	end
	! происходит вход в тело героя.
	$GAME_VALUE['inventory.floor'] = $OOS['oid']
	
	! Возможно организовать через меню было бы интереснее.
elseif instr($OOS['obj'],'<bag>')!0:
! если выделенным объектом является рюкзак
	! Производится выведение всех дочерних объектов рюкзака.
	$GAME_VALUE['inventory.floor'] = $OOS['oid']
	
	if $GAME_INTERFACE['подсказки']='show': $print['help']+=$func('game.help','предметы')+$func('b.w.s','help')
elseif instr($OOS['obj'],'<magic>')!0:
! если выделенным объектом является книга магии
	$GAME_VALUE['inventory.floor'] = $OOS['oid']
	
	if $GAME_INTERFACE['подсказки']='show': $print['help']+=$func('game.help','магия')+$func('b.w.s','help')
elseif instr($OOS['obj'],'<gate-stone>')!0:
! если выделенным объектом является ожерелье гроз
	$print['gs.table']+='<font color=#'+$func('get.tag.num',$object_array[OOS['pos']],'color')+' face="CyrillicOld" size=+1><b>'+$func('b.d.t','gate-stone')+':</b></font><br>'
	if $func('get.daughter.obj',$OOS['oid'],'<g-s>','$tempOOS_id')='true':
		$print['gs'] = '<table cellspacing=0 cellpadding=5 bgcolor=#ffff88><tr><td align=left bgcolor=#bbbb44><font size=-3>'+$func('b.d.t','target-point')+':</font></td><td align=center bgcolor=#cccc55><font size=-3>'+$func('b.d.t','table.iner')+':</font></td><td align=center bgcolor=#bbbb44><font size=-3>'+$func('b.d.t','table.charge')+':</font></td><td align=center bgcolor=#cccc55><font size=-3>'+$func('b.d.t','table.move')+':</font></td></tr>'
		:new1
		if arrsize('$tempOOS_id')>0:
			OOS['pos1']=arrpos('$id_array',$tempOOS_id[0])
			$OOS['key'] = $func('get.tag.cont',$object_array[OOS['pos1']],'name')
			if $OOS['key']='': $OOS['key'] = $func('b.d.t','g-s.neverland')
			if instr($object_array[OOS['pos1']],'[charge:')!0:	$OOS['open']	=	str(charge_array[OOS['pos1']])+'/'+$func('get.tag.num',$object_array[OOS['pos1']],'charge') else $OOS['open']=''
			if kolvo_array[OOS['pos1']]!0: $OOS['count']	=	str(kolvo_array[OOS['pos1']])
			if ($OOS['open']!'' and charge_array[OOS['pos1']]!0) or $OOS['open']='': $OOS['breake']='<a href="exec:gs '+"'int.act.goto','"+$tempOOS_id[0]+"','"+$OOS['oid']+"'"+'">&#8594;</a>' else $OOS['breake']='<font color=#ff0000>'+$func('b.d.t','g-s.imposible')+'</font>'
			$print['gs.table'] += '<tr><td align=left bgcolor=#dddd66><font size=-3>'+$OOS['key']+'</font></td><td align=center bgcolor=#eeee77><font size=-3>'+$OOS['count']+'</font></td><td align=center bgcolor=#dddd66><font size=-3>'+$OOS['open']+'</font></td><td align=center bgcolor=#eeee77><font size=-3>'+$OOS['breake']+'</font></td></tr>'
			killvar '$tempOOS_id',0
			jump 'new1'
		end
		$print['gs.table']+='</table>'
	end
elseif instr($OOS['obj'],'<property>')!0:
! если выделенным объектом является свойство
	! Производится интерпретация свойства. В т.ч. если предусмотрено ссылка для прокачки.
	$print['hero.property']+=$func('int.hero.property',$OOS['oid'])
elseif instr($OOS['obj'],'<spell>')!0:
! если выделенным объектом является заклинание
	$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.spell.read')+':menu.obj.spell.read'
	$menu_OOS[arrsize('$menu_OOS')]=$func('b.d.t','menu.obj.read')+':menu.obj.read'
	gs 'int.menu.obj',$OOS['obj']
elseif $OOS['oid']='back':
! если выделенным объектом является возвратный объект
	$GAME_VALUE['inventory.floor'] = $func('get.tag.cont',$selobj,'back')
end
! скрипт, выполняемый при выделении объекта. Можно добить, например, меню, или что ещё
if $strfind($run_array[OOS['pos']],'!onObjSel!')!'': $args['doc']=$func('run.dynamic.script','!onObjSel!',$OOS['oid'])
! если присутствует скрипт
if arrsize('$menu_OOS')>0 and instr($OOS['obj'],'[lock.obj]')=0: menu "$menu_OOS"
killvar '$result'
killvar '$menu_OOS'
killvar '$tempOOS_id'
killvar 'OOS'
killvar '$OOS'
unselect
gs 'int.inventory'
gs 'true.goto.curloc',$curloc
--- onObjSel ---------------------------------

# onNewLoc
! Выполняется при посещении новой локации
! Для правильной работы интерпретатора требуется заблаговременное заполнение переменных:
!	$object_array[$curloc] - хранит заголовок локации, идентифицируется по её имени
!	$lvar['локация.исходник'] - хранит исходный текст локации, обрабатываемый различными интерпретаторами с текущей локации
!   ---------------- Используемые функции -------------------
!		int.loc.head - обрабатывает заголовок
!		int.din.text - обрабатывает описание локации
!		int.loc.obj - воспроизводит, сброшенные на локации объекты.
! Удаляем временные переменные
killvar '$int_act_goto'	&	!	поскольку переход совершён, этот массив нам больше не нужен

! ----------------- работа с полем "базовое описание локации" ------------------
	$SQUARE['SQUARE.loc.maintxt']=$MAINTXT
	$SQUARE['SQUARE.loc.curacts']=$CURACTS
	*clr
	cla
! ----------------- работа с полем "описание локации" ------------------

! определяем ай-ди текущей локации
$args['LID']=$func('get.loc.id')

	! -------------------- переход на новую локацию -----------
		if $id_watch[]<>$args['LID']: $id_watch[] = $args['LID']
		if arrsize('$id_watch')>100: killvar '$id_watch',0
	! -------------------- переход на новую локацию -----------

	! -------------------- переход на любую локацию -----------
		$refresh_watch[]=$args['LID']
		if arrsize('$refresh_watch')>9999: killvar '$refresh_watch',0
	! -------------------- переход на любую локацию -----------
	
if $refresh_watch[]<>$refresh_watch[arrsize('$refresh_watch')-2]:
	killvar '$dvar'
	gosub 'kill.var.olegus','$tvar','приветствие.'+$refresh_watch[arrsize('$refresh_watch')-2]
end

$GAME_VALUE['way.lock.by.enemy']=''	&	!	новая локация. Мы ещё не знаем заблокирована ли она врагом
! Передвигаем стрелки часов
if GAME_VALUE['goto'] = 1:
! запоминаем предыдущие показатели времени. Т.е. до изменения календарём
	time['last.sec']	=	time['sec']
	time['last.minute']	=	time['minute']
	time['last.hour']	=	time['hour']
	time['last.day']	=	time['day']
	time['last.date']	=	time['date']
	time['last.weekday']=	time['weekday']
	time['last.month']	=	time['month']
	time['last.year']	=	time['year']
	! генерация календаря
	gs 'int.time.calendar',$time['goto']
	! скрипты воздействий. Выполняются до генерации основного описания локации. Это позволяет дополнить исходник локации
	! каким-нибудь текстом, или вовсе подменить его на другой, если по выполнении скрипта должен проигрываться определённый сюжет.
	gs 'int.influence.scripts','!onNewLoc.property!',$time['goto']
end

! ------------------------------------------ эффекты, наложенные на локацию - предобработка -----------------------------------------------
	! предобработка позволяет добавить к исходнику локации дополнительный текст, а так же посчитать разные эффекы локации до обнуления переменных
	if $strfind($run_array[arrpos('$id_array',$args['LID'])],'!onNewLoc.pre!')!'': $args['run_array']=$func('run.dynamic.script','!onNewLoc.pre!',$args['LID'])
! ------------------------------------------ эффекты, наложенные на локацию - предобработка -----------------------------------------------

! Генерируется описание локации
! Для локаций всех типов описание из исходника:
$SQUARE['SQUARE.loc.fromSource']=$lvar['локация.исходник']

if $strfind($args['LID'],'(\[м:[\d]+\]_[\s\S]+|место;|place;)')!'':
! путём синтаксического разбора ай-ди локации установлено, что это локация места.

	! ----------- переход на новую локацию места -----------
		if $logist[]<>$args['LID']:
			$logist[]=$args['LID']	&	!	массив, где хранятся последние сто мест, где побывал герой
			! поскольку это новая локация места:
			$light_array[$args['LID']]=$func('int.lighting')		&	!	устанавливаем освещённость
			gosub 'magic.menergy.spell',$args['LID'],'','respawn'	&	!	респавним магическую энергию пространства
		end
		if arrsize('$logist')>100: killvar '$logist',0	&	!	если размер массива превышает 100 элементов, удаляем нулевой
	! ----------- переход на новую локацию места -----------

	if здесь_был[$args['LID']]<1:
	! метка о посещении выставляется при первом посещении
		здесь_был[$args['LID']]+=1
		! устанавливаем дефолтное значение магической энергии места:
		gosub 'magic.menergy.spell',$args['LID'],'','set'
	end
	
	$args['тип локации']='location'
	$SQUARE['SQUARE.loc.type']='место'	
	$args['действия на локации']=$func('int.loc.obj',$args['LID'],'','href','[count][weight][take:lift]')
	$SQUARE['SQUARE.location.obj.inActs']=$func('int.loc.obj',$args['LID'],'','acts','[count][weight][take:lift]')
	$SQUARE['SQUARE.location.obj.inHREF']=$func('int.loc.obj',$args['LID'],'','href','[count][weight][take:lift]')
	
	! выставляем настройки экрана в соответствии с освещением:
elseif $curloc='[chest]' and $strfind($args['LID'],'(\[с:[\d]+\]_[\s\S]+|сундук;|chest;)')<>'':
! путём синтаксического разбора установлено, что айди принадлежит локации-хранилищу
	! получаем заголовок:
	$args['head.chest']=$func('get.obj.id',$args['LID'])
	if $args['head.chest']='':
		! если заголовок не был создан
		! создаём заголовок и возвращаем его значение
		gosub 'gen.loc.head',$cvar['loc_id'+$cvar['chest']],$cvar['manage'+$cvar['chest']]
		$args['head.chest']=$func('get.obj.id',$args['LID'])
	end
	! получаем специализацию локации
	$args['spec.chest']=$func('get.tag.cont',$args['head.chest'],'spec')
	
	if здесь_смотрел[$args['LID']]<1:
	! метка о посещении выставляется при первом посещении
		здесь_смотрел[$args['LID']]+=1
	end
	
	if $strfind($cvar['back'+$cvar['chest']],'(\[м:[\d]+\]_[\s\S]+|место;|place;)')!'':
	! если предыдущая локация была 
		$SQUARE['SQUARE.chest.closeAct']='<a class="plain" href="exec:killvar '+"'$cvar' & killvar 'smithing' & GOTO '"+$cvar['back'+$cvar['chest']]+"'"+'"><font color=#ff8800><b>'+$func('b.d.t','close','chest')+'</b></font></a>'
	elseif $strfind($cvar['back'+$cvar['chest']],'(\[с:[\d]+\]_[\s\S]+|сундук;|chest;)')!'' or $strfind($cvar['back'+$cvar['chest']],'(\[т:[\d]+\]_[\s\S]+|торговец;|seller;)')<>'':
		$SQUARE['SQUARE.chest.closeAct']='<a class="plain" href="exec:GOTO '+"'[chest]','"+$cvar['back'+$cvar['chest']]+"'"+'"><font color=#ff8800><b>'+$func('b.d.t','close','chest')+'</b></font></a>'
	end
	! Заметьте, удаление $cvar происходит только при активации ссылки "Закрыть", выбрасывающей на локацию места
	! Это связано с тем, что при удалении предмета из сундука происходит повторное обращение к локации сундука,
	! и исходные данные в этом случае должны быть сохранены. Так же на локации сундука могут быть другие локации сундука
	if instr($args['spec.chest'],'[smithing]')!0:
		$SQUARE['SQUARE.smithing.obj.inActs']=$func('int.loc.obj',$args['LID'],'','acts','[count][weight][take:take]')
		$SQUARE['SQUARE.smithing.obj.inHREF']=$func('int.loc.obj',$args['LID'],'','href','[count][weight][take:take]')
		$SQUARE['SQUARE.smithing.craftObjs']=$func('base.smithing',$cvar['loc_id'+$cvar['chest']])
		$SQUARE['SQUARE.loc.type']='кузница'
	elseif instr($args['spec.chest'],'[altar]')!0:
		$SQUARE['SQUARE.loc.type']='алтарь'
		$SQUARE['SQUARE.altar.sacrifice']=$func('int.altar',$cvar['loc_id'+$cvar['chest']])
	else
		$SQUARE['SQUARE.chest.obj.inHREF']=$func('int.loc.obj',$args['LID'],'','href','[count][weight][take:take]')	&	!	интерпретатор объектов на локации использует в данном случае не ай-ди локации, а ай-ди сундука.
		$SQUARE['SQUARE.loc.type']='хранилище'
	end
	$args['тип локации']='chest'
elseif $curloc='[chest]' and $strfind($args['LID'],'(\[т:[\d]+\]_[\s\S]+|торговец;|seller;)')<>'':
	! локация торговли
	$args['тип локации']='seller'
	$SQUARE['SQUARE.loc.type']='seller'
	
	args['$']=arrpos('$id_array',$args['LID'])
	if здесь_торговал[$args['LID']]<1:
		здесь_торговал[$args['LID']]+=1
	end
	! респавн торговца
		if $func('sim.time',$respawn_array[args['$']])!'first':
		! если подошло время респавна
			args['$bank']=func('get.tag.num',$object_array[args['$']],'bank')	&	!	вычисляем каков банк торговца
			if args['$bank']=0: args['$bank']=1000
			$args['$respawn']=$func('get.tag.cont',$object_array[args['$']],'respawn')	&	!	получаем время респавна
			if $args['$respawn']='': $args['$respawn']='[day:7]'
			if charge_array[args['$']]<=args['$bank']:
			!	если денег в банке меньше либо равно, чем должно быть, накидываем денег
				charge_array[args['$']]=args['$bank']
			else
			! если денег в банке больше, чем должно быть, вычитаем якобы растраченную часть. Для этого:
				args['$respawn.time']=$func('get.tag.num',$func('conv.time',$args['$respawn'],'minute'),'minute')	&	!	вычисляем период респавнинга в минутах
				args['$time.now']=$func('get.tag.num',$func('conv.time',$func('get.time.now'),'minute'),'minute')	&	!	вычисляем текущее время в минутах
				args['$respawn.last']=$func('get.tag.num',$func('conv.time',$respawn_array[args['$']],'minute'),'minute')	&	!	вычисляем время последнего респавна
				charge_array[args['$']]-=(args['$time.now']-args['$respawn.last'])*(charge_array[args['$']]-args['$bank'])/args['$respawn.time']
			end
			$respawn_array[args['$']]=$func('summ.time',$func('get.time.now'),$args['$respawn'])
		end
	! респавн торговца
	if $strfind($cvar['back'+$cvar['chest']],'(\[м:[\d]+\]_[\s\S]+|место;|place;)')!'':
		$SQUARE['SQUARE.seller.closeAct']='&nbsp;&nbsp;&nbsp;&nbsp;<div align=left><a class="plain" href="exec:killvar '+"'$cvar' & GOTO '"+$cvar['back'+$cvar['chest']]+"'"+'"><font color=#ff8800><b>.'+$func('b.d.t','close','seller')+'</b></font></a></div>'
	elseif $strfind($cvar['back'+$cvar['chest']],'(\[т:[\d]+\]_[\s\S]+|торговец;|seller;)')<>'' or $strfind($cvar['back'+$cvar['chest']],'(\[с:[\d]+\]_[\s\S]+|сундук;|chest;)')!'':
		$SQUARE['SQUARE.seller.closeAct']='&nbsp;&nbsp;&nbsp;&nbsp;<div align=left><a class="plain" href="exec:GOTO '+"'[chest]','"+$cvar['back'+$cvar['chest']]+"'"+'"><font color=#ff8800><b>'+$func('b.d.t','close','seller')+'</b></font></a></div>'
	end
	$SQUARE['SQUARE.seller.obj.inActs']=$func('int.loc.obj',$args['LID'],'','acts','[count][take:buy][weight][cost]')
	$SQUARE['SQUARE.seller.obj.inHREF']=$func('int.loc.obj',$args['LID'],'','href','[count][take:buy][weight][cost]')
end
! ----- динамические скрипты локации. Поствыполнение ------
	if $strfind($run_array[arrpos('$id_array',$args['LID'])],'!onNewLoc.post!')!'': $args['кккккк2139']=$func('run.dynamic.script','!onNewLoc.post!',$args['LID'])
! ----- динамические скрипты локации. Поствыполнение ------

! ------------------------------ заносим в основное описание дополнительные тексты ----------------------------
$SQUARE['SQUARE.loc.hallow']=$tvar['приветствие.'+$args['LID']]
$SQUARE['SQUARE.loc.plustext']=$lvar['локация.дополнительные тексты']
! -массив $dvar
$SQUARE['SQUARE.loc.dvar']=''
args['d']=0
:print_Dvar
if args['d']<arrsize('$dvar'):
	if $dvar[args['d']]<>'':
		$SQUARE['SQUARE.loc.dvar']+=$dvar[args['d']]+'<br>'
	end
	args['d']+=1
	jump 'print_Dvar'
end
! ------------------------------ заносим в основное описание дополнительные тексты ----------------------------

if $GAME_INTERFACE['обучение']='show' and $func('[help]',$args['LID'])!'': $print['help']+="<br>"+$func('[help]',$args['LID'])
$SQUARE['SQUARE.loc.acts.inActs']=$func('int.loc.act','acts')
$SQUARE['SQUARE.loc.acts.inHREF']=$func('int.loc.act','href')
$SQUARE['SQUARE.head']=$func('int.loc.head',$args['LID'],$args['тип локации'])	&	!	интерпретатор заголовков локаций
$SQUARE['SQUARE.stat']=$func('print.word')
! теперь когда получены все возможные данные, запускаем интерпретатор интерфейса
gosub 'int.loc.interface',$args['LID'],$args['тип локации']
! "---- 
	Вставить здесь задержку и вывод пустой строки для случаев, когда мы посещаем одну и ту же локацию и нам не нужно читать описание по-новой.
!"
! ----- обнуление данных --------------------------------------------------------------------------------------------------------
$time['goto']=''
GAME_VALUE['goto'] = 0
$kolvo_array[arrpos('$id_array',$args['LID'])]=$time['new.all']
killvar '$result'
killvar '$lvar'
killvar '$avar'
killvar 'time_goto'
--- onNewLoc ---------------------------------

# inputText
! читкоды ! ОТЛАДЧИК!
$args[0] = $args[0]
if $args[0]!'':
	$args['user_text'] = $args[0]
	$args['use']='func'
else
	$args['user_text'] = $user_text
	$args['use']='print'
end

! ------------------------------------- парсер строки ввода ----------------------------------
	killvar '$input_text_word'
	$args['string']=$args['user_text']
	:BALOON
	if len($args['string'])>0:
		$input_text_word[]=$TRIM($strfind($args['string'],'\s*\S+\s*'))
		$args['string']=$TRIM($replace($args['string'],$strfind($args['string'],'\s*\S+\s*')))
		jump 'BALOON'
	end
! ------------------------------------- парсер строки ввода ----------------------------------

if $input_text_word[0] = 'run':
	$args['res.021213']=dyneval($mid($args['user_text'],5))
	jump 'end_keep'
end
if $input_text_word[0] = 'arr':
! выводит содержимое массивов
	$args['res.021213']=$func('#array.prnt#',$input_text_word[1])
	jump 'end_keep'
end
if $input_text_word[0] = 'obj':
! выводит содержимое предмета по числу или ай-ди
	if isnum($input_text_word[1])=-1:
		$args['res.021213']+=$func('inputText.obj',val($input_text_word[1]))
	elseif $input_text_word[1]!'':
		$args['res.021213']+=$func('inputText.obj',arrpos('$id_array',$input_text_word[1]))
	end
end
if $input_text_word[0]='all':
	if $input_text_word[1]='objects':
		if $input_text_word[2]='table':
			args['moment1']=MSECSCOUNT
			$args['res.021213']='<table width=100% cellpadding=0 cellspacing=2 border=1><tr><td>№П.П.</td><td>ID</td><td>Тело объекта</td><td>расположение</td><td>Дочерний:</td><td>кол-во</td><td>заряд</td></tr>'
			args['i_inputText'] = 0
			:new2
			$args['res.021213']=$args['res.021213']+'<tr><td>['+str(args['i_inputText'])+']</td><td>'+$id_array[args['i_inputText']]+'</td><td>'+$replace($replace($object_array[args['i_inputText']],'<','&lt;'),'>','&gt;')+'</td><td>{'+$position_array[args['i_inputText']]+'}</td><td>^'+$include_array[args['i_inputText']]+'^</td><td>'+str(kolvo_array[args['i_inputText']])+'</td><td>'+str(charge_array[args['i_inputText']])+'</td></tr>'
			args['i_inputText']+=1
			if arrsize('$id_array')>args['i_inputText']: jump 'new2'
			$args['res.021213']+='<tr><td>№П.П.</td><td>ID</td><td>Тело объекта</td><td>расположение</td><td>Дочерний:</td><td>кол-во</td><td>заряд</td></tr></table>'
		elseif $input_text_word[2]='dialog':
			$args['res.021213']=$func('#array.prnt.few#','$easy_dialog_base_ID','$easy_dialog_base_SC','$easy_dialog_base_ST','$easy_dialog_base_PS','easy_dialog_base_KOL')
			jump 'end_keep'
		elseif $input_text_word[2]='':
			args['i_inputText'] = 0
			:new1
			$args['res.021213']+='<br>['+str(args['i_inputText'])+'] '+$id_array[args['i_inputText']]+' '+$object_array[args['i_inputText']]+' {'+$position_array[args['i_inputText']]+'} количество:'+str(kolvo_array[args['i_inputText']])+' заряд:'+str(charge_array[args['i_inputText']])
			args['i_inputText']+=1
			if arrsize('$id_array')>args['i_inputText']: jump 'new1'
		end
	end
end
if $input_text_word[0] = 'daughters':
	if isnum($input_text_word[1])=-1:
		$input_text_word[1]=$id_array[val($input_text_word[1])]
	end
	if $func('get.daughter.obj',$input_text_word[1],'','$temp_id_input_text')='true':
		args['i_inputText'] = 0
		$args['res.021213']+='<br><b>Объект:</b> '+$func('inputText.obj',arrpos('$id_array',$input_text_word[1]))
		$args['res.021213']+='<br><b>Список id дочерних объектов:</b> '
		:new3
		if arrsize('$temp_id_input_text')>0: 
			$args['res.021213']+='<br>['+str(arrpos('$id_array',$temp_id_input_text[0]))+']'+$temp_id_input_text[0]
			args['i_inputText']+=1
			killvar '$temp_id_input_text',0
			jump 'new3'
		end
	else
		$args['res.021213']+='<br><b>Дочерних объектов нет.</b>'
	end
	killvar '$temp_id_input_text'
end
if $input_text_word[0]='goto':
	$args['location']=$TRIM($replace($args['user_text'],'goto '))
	if $strfind($args['location'],'(\[м:[\d]+\]_[\s\S]+|место;|place;)')<>'' and loc $args['location']:
		$lvar['локация.дополнительные тексты']+="<br><br><b>Ты премести(лся/лась) на локацию '<<$args['location']>>'</b><br>"
		goto $args['location']
	elseif $strfind($args['location'],'(\[с:[\d]+\]_[\s\S]+|сундук;|chest;)')<>'' or $strfind($args['location'],'(\[т:[\d]+\]_[\s\S]+|торговец;|seller;)')<>'':
		$lvar['локация.дополнительные тексты']+="<br><br><b>Ты премести(лся/лась) на локацию '<<$args['location']>>'</b><br>"
		goto '[chest]',$args['location'],'',$func('get.loc.id')
	else
		$args['res.021213']='Сообщение отладчика: локация с id "'+$args['location']+'" не существует, или является служебной.'
	end
end
if $args['user_text']='main html':
	$args['res.021213'] = $replace($maintxt,'<','&lt;')
	$args['res.021213'] = $replace($args['res.021213'],'>','&gt;')
end
if $input_text_word[0]='logs':
	if $input_text_word[1]<>'error':
		$args['res.021213']+='Лог дополнительного описания (последние сто записей):<br>'
		$args['res.021213']+=$func('#array.prnt#','$log_print')+'<br>'
	end
	$args['res.021213']+='Лог движка:<br>'
	args['i']=0
	:error_log_m
	if args['i']<arrsize('$error_log'):
		$args['res.021213']+=$error_log[args['i']]+'<br>'
		args['i']+=1
		jump 'error_log_m'
	end
	$args['res.021213']+='<br>'
	$args['res.021213']+='Лог ошибок движка:<br>'
	$args['res.021213']+=$func('#array.prnt#','$log_error','')+'<br>'
end
:end_keep
args['moment2']=MSECSCOUNT
if	$args['use']='func':	$result=$args['res.021213']+'<br>Вывод таблицы объектов занял мсек: '+str(args['moment2']-args['moment1'])
if	$args['use']='print' and $input_text_word[0]!'run': *pl $args['res.021213']
killvar '$input_text_word'
--- inputText ---------------------------------

# inputText.obj
args[0] = args[0]
$result = ''
$result  +='
Предмет номер <<args[0]>>:'
$result  +='<font color=#888888>
ID[<<args[0]>>]	=	'+$id_array[args[0]]
$result  +='</font>
OBJ[<<args[0]>>]	=	'+$replace($object_array[args[0]],'<','&lt;')
$result  +='<font color=#888888>
POS[<<args[0]>>]	=	'+$position_array[args[0]]
$result  +='</font>
количество: <<kolvo_array[args[0]]>>, заряд: <<charge_array[args[0]]>>'
$result  +='<font color=#888888>
респавнится в <<$respawn_array[args[0]]>>'
$result += '</font>
RUN:
'+$replace($run_array[args[0]],'<','&lt;')
--- inputText.obj ---------------------------------

# get.word.padez
! функция получает падеж из строки вида Именительныq|Родительный|Дательный|Винительный|Творительный|Предложный
$args[0] = $args[0]	&	!	строка
$args[1] = $args[1]	&	!	падеж
if $args[1]='И' or $args[1]='':
	$args['gwp']=$func('get.word.inPos',$args[0],1)
elseif $args[1]='Р':
	$args['gwp']=$func('get.word.inPos',$args[0],2)
elseif $args[1]='Д':
	$args['gwp']=$func('get.word.inPos',$args[0],3)
elseif $args[1]='В':
	$args['gwp']=$func('get.word.inPos',$args[0],4)
elseif $args[1]='Т':
	$args['gwp']=$func('get.word.inPos',$args[0],5)
elseif $args[1]='П':
	$args['gwp']=$func('get.word.inPos',$args[0],6)
end
$result=$args['gwp']
--- get.word.padez ---------------------------------

# get.word.end
! вычисляет окончание по числу.
! args[0] - число
! $args[1] - окончания в формате a|b|c
! можно писать окончание для нулевого варианта отдельно! 1 очко|2 очка|0 или 5 очков|ноль
args[0] = args[0]
if args[0]<0: args[0] = -args[0]
$args[1] = $args[1]
! деньги
args[2] = args[0] mod 10
args[3] = args[0] mod 100
$args['gwenda']='gwe_error'
if args[2]=1 and args[3]!11:
	$args['gwenda']=$func('get.word.inPos',$args[1],1)
end
if args[2]>1 and args[2]<5 and (args[3]<5 or args[3]>20):
	$args['gwenda']=$func('get.word.inPos',$args[1],2)
end
if args[2]=0 or args[2]>4 or (args[3]>10 and args[3]<21):
	$args['gwenda']=$func('get.word.inPos',$args[1],3)
end
if args[0]=0 and $func('get.word.inPos',$args[1],4)!'' and $func('get.word.inPos',$args[1],4)!$args['gwenda']:
	$args['gwenda']=$func('get.word.inPos',$args[1],4)
end
$result=$args['gwenda']
--- get.word.end ---------------------------------

# remastering.tag.number
! Локация склеивает две строки с числовыми тегами.
$args[0] = $args[0]
$args[1] = $args[1]
args['u']=1
args['a']=0
:for2
if args['a']<2:
	args['i']=1
	:for1
	if strfind($args[args['a']],"\[[\d]+:[\s\S]*:[\d]+\]")!'':
		$args['str']=$replace($replace($strfind($args[args['a']],"\[<<args['i']>>:[\s\S]+:<<args['i']>>\]"),"[<<args['i']>>:"),":<<args['i']>>]")
		if $args['str']!'':
			$args['res.021213']+="[<<args['u']>>:"+$args['str']+":<<args['u']>>]"
			args['u']+=1
		end
		$args[args['a']]=TRIM($replace($args[args['a']],"[<<args['i']>>:"+$args['str']+":<<args['i']>>]"))
		args['i']+=1
		jump 'for1'
	end
	args['a']+=1
	if args['a']<2: jump 'for2'
end
$result=$args['res.021213']
--- remastering.tag.number ---------------------------------

# get.loc.id
if $curloc='[chest]' or ($cvar['loc_id'+$cvar['chest']]!'' and $strfind($curloc,'(\[м:[\d]+\]_[\s\S]+|место;|place;)')!''):
	$result=$cvar['loc_id'+$cvar['chest']]
else
	$result=$curloc
end
--- get.loc.id ---------------------------------

# int.din.text
! интерпретатор динамических конструкций
$args[0] = $args[0]	&	!	исходный динамический текст
$args[1] = $args[1]	&	!	дополнительные данные
! поддерживаемые теги
! [th: :th]
! [tm: :tm]
! [td: :td]
! [ty: :ty]
:next_str
! проверка на наличие динамических конструкций
if $strfind($args[0],'<DIN(\d+):[\s\S]*?:\1DIN>')!'':
	$args['sup']=$args[0]	&	!	запоминаем текущее положение дел
	:still_DIN
	! получаем строку, в которой должен присутствовать <DIN1::1DIN>
	$args['sup']=$strfind($args['sup'],'<DIN(\d+):[\s\S]*?:\1DIN>')
	if $args['sup']!"":
		! если подобная строка получена, убираем концы
		$args['sup.mem'] = $args['sup']	&	!	запоминаем, как выглядела строка до отбрасывания концов
		$args['sup']=$strfind($args['sup'],'<DIN(\d+):([\s\S]*?):\1DIN>',2)
		! когда концы убраны, проверяем вновь
		jump 'still_DIN'
	else
		!если подобная строка больше не получена, значит найденная строка - искомая(самый внутренний уровень)
		$args['sup.new']=$func('int.DIN',$args['sup.mem'])	&	!	выполняем динамический код строки
		! заменяем в исходном тексте вычлененную строку на результат
		$args[0] = $replace($args[0],$args['sup.mem'],$args['sup.new'])
	end
	jump 'next_str'
elseif $strfind($args[0],'\[(\D+)\][\s\S]*?\[\/\1\]')!'':
	$args['new.text'] = $strfind($args[0],'\[(\D+)\][\s\S]*?\[\/\1\]')	&	!	получаем тегированную строку
	$args['tag'] = $strfind($args[0],'\[(\D+)\][\s\S]*?\[\/\1\]',1)	&	!	получаем тег
	$args['string']=$func('get.tag.cont',$args['new.text'],$args['tag'])	&	!	извлекаем строку из тегов
	! внимание. Далее следует рекурсивное обращение к текущей локации!!!
	!*pl 'Уровень рекурсии: <<args[1]>>'
	!*pl 'Строка без тегов: '+$args['string']
	if $strfind($args['string']+'[/'+$args['tag']+']','\[(\D+)\][\s\S]*?\[\/\1\]')!'':
		!*pl 'Поскольку текущая строка содержит вложенный тег, вызываем процедуру снова.'
		$args['new.str']=$replace($args['new.text'],$args['string']+'[/'+$args['tag']+']',$func('int.din.text',$args['string']+'[/'+$args['tag']+']',args[1]))
		$args[0]=$replace($args[0],$args['new.text'],$args['new.str'])
		$args['new.text']=$args['new.str']
		!*pl 'полученная строка: '+$args['new.text']
	end
	$args[0] = $replace($args[0],$args['new.text'],$func('int.DIN',$args['new.text']))
	jump 'next_str'
elseif $strfind($args[0],'\([^([]*?\/\/[^])]*?\)')!'':
	$args['new.text']=$strfind($args[0],'\([^([]*?\/\/[^])]*?\)')
	$args['sex']=$func('get.tag.num',$args[1],'sex')
	$args[0] = $replace($args[0],$args['new.text'],$func('int.DIN',$args['new.text'],$args['sex']))
	jump 'next_str'
elseif $strfind($args[0],'(\+{2,4})[^+]+(\+?[^+]+)*\1')<>'':
	$args['sup.mem']=$strfind($args[0],'(\+{2,4})[^+]+(\+?[^+]+)*\1')	&	!	запоминаем, как выглядит разбираемая строка
	$args['new.text']=$func('int.DIN',$args['sup.mem'])
	$args[0]=$replace($args[0],$args['sup.mem'],$args['new.text'])
	jump 'next_str'
elseif $strfind($args[0],'(={2,4})[^=]+(=?[^=]+)*\1')!'':
	$args['sup.mem']=$strfind($args[0],'(={2,4})[^=]+(=?[^=]+)*\1')	&	!	запоминаем, как выглядит разбираемая строка
	$args['new.text']=$func('int.DIN',$args['sup.mem'])
	$args[0]=$replace($args[0],$args['sup.mem'],$args['new.text'])
	jump 'next_str'
else
	$result=$replace($args[0],'--','—')
end
--- int.din.text ---------------------------------

# int.DIN
! Интерпретатор получает текст, преобразует текст в код и выдаёт на гора результат.
! Если в интерпретатор попадает неизвестная конструкция, интерпретатор херит текст к чертям
$args[0] = $args[0]	&	!	-	динамический текст
$args[1] = $args[1]	&	!	-	дополнительные данные
if $strfind($args[0],'\[th\][\s\S]*?\[\/th\]')!'' and instr($args[0],'[th]')=1:
	$args['int.DIN']=$func('int.time.hours',$func('get.tag.cont',$args[0],'th'))
elseif $strfind($args[0],'\[ty\][\s\S]*?\[\/ty\]')!'' and instr($args[0],'[ty]')=1:
	$args['int.DIN']=$func('int.time.years',$func('get.tag.cont',$args[0],'ty'))
elseif $strfind($args[0],'\[tm\][\s\S]*\[\/tm\]')!'' and instr($args[0],'[tm]')=1:
	$args['int.DIN']=$func('int.time.month',$func('get.tag.cont',$args[0],'tm'))
elseif $strfind($args[0],'\[td\][\s\S]*\[\/td\]')!'' and instr($args[0],'[td]')=1:
	$args['int.DIN']=$func('int.time.days',$func('get.tag.cont',$args[0],'td'))
elseif $strfind($args[0],'\[chestname\][\s\S]+\[\/chestname\]')!'' and instr($args[0],'[chestname]')=1:
	$args['int.DIN']=$func('int.chest.name',$func('get.tag.cont',$args[0],'chestname'))
elseif $strfind($args[0],'\[var\][\s\S]+\[\/var\]')!'' and instr($args[0],'[var]')=1:
	$args['int.DIN']=$func('int.var',$func('get.tag.cont',$args[0],'var'))
elseif $strfind($args[0],'\[lnk\][\s\S]+\[\/lnk\]')!'' and instr($args[0],'[lnk]')=1:
	$args['int.DIN']=$func('int.link',TRIM($func('get.tag.cont',$args[0],'lnk')))
elseif $strfind($args[0],'\[goto\][\s\S]+\[\/goto\]')!'' and instr($args[0],'[goto]')=1:
	$args['int.DIN']=$func('int.dyn.goto',TRIM($func('get.tag.cont',$args[0],'goto')))
elseif $strfind($args[0],'\[back\][\s\S]+\[\/back\]')!'' and instr($args[0],'[back]')=1:
	$args['int.DIN']=$func('int.dyn.back',TRIM($func('get.tag.cont',$args[0],'back')))
elseif $strfind($args[0],'\[[\s\S]*?\/\/[\s\S]*?\]')!'' or $strfind($args[0],'\([\s\S]*?\/\/[\s\S]*?\)')!'':
	$args['int.DIN']=$func('int.word.SEX',$args[0])
elseif $strfind($args[0],'<DIN(\d+):[\s\S]*:\1DIN>')!0:
	args['num.sup']=val($strfind($strfind($args[0],'<DIN\d+:'),'\d+'))
	$args[0]=$replace($replace($args[0],"<DIN<<args['num.sup']>>:"),":<<args['num.sup']>>DIN>")
	$args['int.DIN']=DYNEVAL($args[0])
elseif $strfind($args[0],'(\+{2,4})[^+]+(\+?[^+]+)*\1')=$args[0] or $strfind($args[0],'(={2,4})[^=]+(=?[^=]+)*\1')=$args[0]:
	$args['int.DIN']=$func('int.html.Hn',$args[0])
else
	$args['int.DIN']=$args[0]
end
$result=TRIM($args['int.DIN'])
--- int.DIN ---------------------------------

# int.var
! Интерпретатор получает строку вида
! ИМЯ_ПЕРЕМЕННОЙ;;Индекс|строка 1|строка 2|строка 3|строка 4 и т.д.
! в зависимости от состояния переменной возвращает строку, между ||
! if ИМЯ_ПЕРЕМЕННОЙ[индекс] = 0: $result ='строка 1' и т.д.
$args[0] = $args[0]
! первой частью идут имя и индекс переменной - отделяем их от прочей строки
$args['var']=TRIM(mid($args[0],1,instr($args[0],'|')-1))
if $args['var']='': $result ='Ошибка использования динамической записи &#91;var&#93;&#91;/var&#93;!! Не указано  имя переменной' & exit	&	!	pfobnf от дурака
$args[0]=TRIM(mid($args[0],instr($args[0],'|')))+'|'
! выделяем переменную и индекс:
if instr($args['var'],';;')=0:
	$args['var.name']=$args['var']
	$args['var.index']='0'
else
	$args['var.name']=TRIM(mid($args['var'],1,instr($args['var'],';;')-1))
	$args['var.index']=TRIM(mid($args['var'],instr($args['var'],';;')+2))
	! преобразуем индекс в удобоваримый вид.
	if strcomp($args['var.index'],'("|'+"'"+').*\1')=0 and ISNUM($args['var.index'])=0: $args['var.index']="'"+$replace($args['var.index'],'''','"')+"'" 
end
$log_error[]='n:'+$args['var.name']
$log_error[]='i:'+$args['var.index']
! получаем результат по-умолчанию. Это первая строка, которой не приписаны значения.
! Если результат по-умолчанию должен быть пустым, его можно опустить, a не писать ||
$args['text.null']=$replace($strfind($args[0],'(\|([^;|]+(;|[^|])[^;|]*)+\|)'),'|')
$log_error[]='0:'+$args['text.null']
! получаем значение переменной
$args['var.num']=$DYNEVAL("$result = <<$args['var.name']>>[<<$args['var.index']>>]")
$log_error[]='v:'+$args['var.num']
! ищем среди строк ту, которой соответствует наше значение:
$args['find.str']=$strfind($args[0],'\|([^|]*;;)?\s*(('+"'"+'|")?)\s*'+$args['var.num']+'\s*\2\s*;;[^|]*\|')
$log_error[]="f:"+$args['find.str']
if arrsize($args['var.name'])=0:
	jump 'null'
elseif $args['find.str']!'':
! если значение найдено, возвращаем в результат ту строку, которую отыскали
	$args['result']=$replace($replace($args['find.str'],$mid($args['find.str'],1,instr($args['find.str'],';;')+1)),'|')
elseif isnum($args['var.num'])=-1 and val($args['var.num'])>=0 and instr($args[0],';;')=0:
! если прямо указанное значение не найдено, но оно является не отрицательным числом, получаем строку по этому числу:
	$args['wip']=$func('get.word.inPos',mid($args[0],2,len($args[0])-2),val($args['var.num']))
	if instr($args['wip'],';;')!0:
		$args['result']=$replace($strfind($args['wip'],'([^;]+(\|)*)'),'|')
	else
		$args['result']=$replace($args['wip'],'|')
	end
else
! если прямо указанное значение не найдено, и оно не является числом, или число меньше нуля, возвращаем значение по-умолчанию
	:null
	$args['result']=$args['text.null']
end
$result = $args['result']
--- int.var ---------------------------------

# int.word.SEX
if $mid($args[0],1,1)='[' and $args[1]='': $args[1]=$tvar['personage.sex']
if $args[1] = '': $args[1] = 'мужской'

if $args[1]='мужской':
	$args['int.res']=$mid($args[0],2,instr($args[0],'//')-2)
elseif $args[1]='женский':
	$args['int.res']=$mid($args[0],instr($args[0],'//')+2,len($args[0])-instr($args[0],'//')-2)
end
$result = $args['int.res']
--- int.word.SEX ---------------------------------

# int.loc.head
! интерпретатор заголовков по исходному содержимому заголовков
$args[0] = $args[0]	&	!	ай-ди локации
$args[1] = $args[1]	&	!	управляющее слово
$args['obj']=$func('get.obj.id',$args[0])
$args['name'] = $func('get.tag.cont',$args['obj'],'name')
$args['spec'] = $func('get.tag.cont',$args['obj'],'spec')
if $args['name'] = '':
	if $args[1]='location': $args['name'] = $func('b.d.t','place.neverland')
	if $args[1]='chest':
		if TRIM($args['spec'])='[smithing]':
			$args['name'] = $func('b.d.t','place.smithing')
		elseif TRIM($args['spec'])='[altar]':
			$args['name'] = $func('b.d.t','place.altar')
		elseif TRIM($args['spec'])='[alchemic]':
			$args['name'] = $func('b.d.t','place.alchemic')
		elseif $strfind($args['spec'],'(\[altar\][\s\S]*\[smithing\]|\[smithing\][\s\S]*\[altar\])+')!'':
			$args['name'] = $func('b.d.t','place.smithal')
		elseif $strfind($args['spec'],'(\[alchemic\][\s\S]*\[smithing\]|\[smithing\][\s\S]*\[alchemic\])+')!'':
			$args['name'] = $func('b.d.t','place.alsmith')
		elseif $strfind($args['spec'],'(\[alchemic\][\s\S]*\[altar\]|\[smithing\][\s\S]*\[altar\])+')!'':
			$args['name'] = $func('b.d.t','place.alal')
		else
			$args['name'] = $func('b.d.t','place.chest')
		end
	end
	if $args[1]='seller': $args['name'] = $func('b.d.t','place.seller')
end
$args['type'] = $func('get.tag.cont',$args['obj'],'type')
if $func('get.tag.num',$args['obj'],'color')!'':
	$args['color'] = $func('get.tag.num',$args['obj'],'color')
	if $args[1]='seller': $cvar['seller.color']=$args['color']
elseif $args[1]='location':
	if $args['type']='строение':	
		$args['color']='994099' & ! здания вне городов
	elseif $args['type']='принадлежит игроку':
		$args['color']='880055'	&	!	любое помещение, которое стало собственностью героя
	elseif $args['type']='город':
		$args['color']='004477' & ! открытая местность в городе
	elseif $args['type']='здание':
		$args['color']='550088' & ! здания в городах
	elseif $args['type']='просторы':
		$args['color']='007799' & ! открытая местность вне городов
	else
		$args['color']='007799'
	end
elseif $args[1]='chest':
	if TRIM($args['spec'])='[smithing]':
		$args['color']='dd6600' & ! кузница
	elseif TRIM($args['spec'])='[altar]':
		$args['color']='ff4400' & ! алтарь
	elseif TRIM($args['spec'])='[alchemic]':
		$args['color']='667733' & ! алхимический стол
	elseif $strfind($args['spec'],'(\[altar\][\s\S]*\[smithing\]|\[smithing\][\s\S]*\[altar\])+')!'':
		$args['color']='ff4466' & ! волшебная кузница
	elseif $strfind($args['spec'],'(\[alchemic\][\s\S]*\[smithing\]|\[smithing\][\s\S]*\[alchemic\])+')!'':
		$args['color']='663377' & ! алхимическая кузница
	elseif $strfind($args['spec'],'(\[alchemic\][\s\S]*\[altar\]|\[smithing\][\s\S]*\[altar\])+')!'':
		$args['color']='336677' & ! алхимический алтарь
	else
		$args['color']='663300' & ! прочие хранилища
	end
elseif $args[1]='seller':
	$args['color']	=	'006600' & ! локации торговли
	$cvar['seller.color']	=	'006600'
	args['колво']	=	charge_array[arrpos('$id_array',$args[0])]
	$args['bank']	=	$func('b.d.t','place.bank',$args['color'],args['колво'])
else
	$args['color']='007799'
end
$args['time']=$func('b.d.t','time.calendar',time['date'],time['year'],$time['hour.onClock'],$time['minute.onClock'])
$result = '<table width=90% border=0 cellpadding=2 cellspacing=0><tr><td align=left><font color=#' +$args['color']+ ' face="CyrillicOld" size=6>' + $args['name'] + '</font>' +$args['bank'] + '</td><td align=right><font color=#' + $args['color'] + ' face="CyrillicOld" size=6>' + $args['time'] + ':' + $func('int.time.days') +'</font></td></tr></table>'
--- int.loc.head ---------------------------------

# int.loc.act
! восстанавливает действия из массива $avar[]
! массив $avar[] заполняется следующим образом: "
$avar[]={! <act:[name:Название действия:name]:act> - закоментированная строка
Тело действия - весь код, который будет выполняться при выборе действия
}
!"
$args[0]=$args[0]
killvar '$reserve_acts'
args['i']=0
:create_acts
if arrsize('$avar')>args['i']:
	$args['obj']=$func('get.tag.cont',$avar[args['i']],'act')
	$args['name']=$func('get.tag.cont',$args['obj'],'name')
	if $args[0]='acts':
		$args['acts']="
		act '"+$args['name']+"':
		"
		$args['acts']+=$avar[args['i']]+"
		"
		$args['acts']+="end
		"
		$args['res.021213']+=$args['acts']
	elseif $args[0]='href':
		$args['res.021213']+='<a href="exec:dynamic $reserve_acts['+str(args['i'])+']">'+$args['name']+'</a><br>'
		$reserve_acts[args['i']]=$avar[args['i']]
	end
	args['i']+=1
	jump 'create_acts'
end
$result=$args['res.021213']
--- int.loc.act ---------------------------------

# int.loc.obj
! Интерпретатор Объектов на локации
$args[0] = $args[0]	&	!	ай-ди локации
$args[1] = $args[1]	&	!	регулярное выражение для поиска определённых объектов
$args[2] = $args[2]	&	!	режим получения объектов acts - в виде действий href - в виде гиперссылок
$args[3] = $args[3]	&	!	дополнительные команды
args['moment1']=MSECSCOUNT
if $func('get.daughter.obj',$args[0],$args[1],'$temp_id_ilo')='true':
! первая строка условия находит все объекты
	:for1
	if arrsize('$temp_id_ilo')>0:
	! перебираются все объекты, стоящие в начале списка
		$args['obj']=$func('get.obj.id',$temp_id_ilo[0])
		if instr($args['obj'],'[hide]')=0:
		! если это не скрытый объект
			if instr($args['obj'],'<obj>')!0: $args['res.int']+=$func('gen.act.obj',$temp_id_ilo[0],$args[0],$args[2],$args[3])
			if instr($args['obj'],'<goto>')!0: $args['res.int']+=$func('gen.act.goto',$temp_id_ilo[0],$args[0],$args[2],$args[3])
			if instr($args['obj'],'<act>')!0: $args['res.int']+=$func('gen.act.act',$temp_id_ilo[0],$args[0],$args[2],$args[3])
		end
		killvar '$temp_id_ilo',0	&	!	удаляем первый объект списка
		jump 'for1'
	end
end
args['moment2']=MSECSCOUNT
$log_error[]='<br>Генерация выводимых на локации объектов заняла мсек: '+str(args['moment2']-args['moment1'])
killvar '$temp_id_ilo'
killvar '$result'
$result=$args['res.int']
--- int.loc.obj ---------------------------------

# int.act.goto
! Интерпретатор, работающий с действиями переходов, дверей
! $args[0] - ай-ди обусловленного перехода
! используются вспомогательные функции, а так же функции работы с объектами
$args[0] = $args[0]
$args[1] = $args[1]	&	!	дополнительные ай-ди. Например родительского объекта.
$args[2] = $args[2] &	!	управляющая конструкция

killvar '$int_act_goto',0	&	!	по идее должно быть очищено на локации onNewLoc, однако может случиться так, что переход не будет осуществлён.
killvar '$menu_iag'
$int_act_goto[0]=$args[0]

$args['link']=$func('get.obj.id',$args[0])	&	!	! Получаем исходное тело ссылки, перехода
$args['goto']=$func('get.tag.cont',$args['link'],'goto')	&	!	! Исходник перехода
$args['loc_ID']=$func('get.tag.cont',$args['goto'],'loc')	&	!	! ID целевой локации
! проверяются
$args['manage.word']=$func('get.tag.cont',$args['goto'],'spec')	&	! управляющее слово
if $args['loc_ID']='[chest]':
! если целевая локация сундук
	$args['DID']=$func('get.tag.cont',$args['goto'],'did')
	$args['head']=$func('get.obj.id',$args['DID'])
else
	$args['head']=$func('get.obj.id',$args['loc_ID'])	&	!	получаем заголовок локации места
end
! Для этого получаем заголовок локации
clear	&	! очищаем экран дополнительного описания
! Удаляем старое меню
killvar '$menu_iag'
! Проверяем наличие локации
if instr($args['head'],'[destroyed]')!0 and $light_array[$args['loc_ID']]!'темно':
	! если в заголовке локации стоит этот тег, значит локация уничтожена
	*pl $func('base.word.screen','017.1')
	pl $func('base.word.screen','017.2')
	exit
elseif instr($args['head'],'[destroyed]')!0 and $light_array[$args['loc_ID']]='темно':
	! если локация уничтожена, а текущая не освещена
	*pl $func('base.word.screen','017.3')
	exit
elseif $GAME_VALUE['way.lock.by.enemy']='true' and $logist[arrsize('$logist')-2]!$args['loc_ID']:
	! если локация не уничтожена, освещена, но заблокирована персонажем или врагом
	
end
if instr($args['link'],'<g-s>')!0:
! если исходное тело содержит тег телепортационного камня
	if (instr($args['link'],'[charge')!0 and charge_array[arrpos('$id_array',$args[0])]!0) or instr($args['link'],'[charge')=0:
	! если камень должен быть заряжен и заряд не на нуле, или заряд камня не требуется
		if instr($args['link'],'[charge')!0: gs 'redo.obj.inCharge',$args[0],$args[1],1
		! если камень должен быть заряжен
		*pl ''
		*pl $func('base.word.screen','018','[color:008888]')
		pl $func('base.word.screen','018','[color:0088cc]')
		gs 'waiting.string','',500,10000,'0088cc','cccc00',2	&	!	выводим визуальную задержку
		nl "<font color=#0088cc>Осуществлено перемещение в </font>"+$func('get.tag.cont',$args['head'],'name')
		$time['goto'] = ''	&	!	нужно ли затрачивать время на телепортацию?????
		GAME_VALUE['goto'] = 1
		GOTO $args['loc_ID'],$args['DID'],$args['manage.word'],$func('get.loc.id')	&	!	осуществляем переход
	else
	! в любом другом случае, хотя такого случая нет!
		exit
	end
end
! Проверяем закрыта ли дверь
if $strfind($args['goto'],'\[key:[\s\S]+:key\]')='':
! если для перехода не требуется ключ, осуществляется непосредственный переход
	$time['goto'] = $func('get.tag.cont',$args['goto'],'time')
	GAME_VALUE['goto'] = 1
	GOTO $args['loc_ID'],$args['DID'],$args['manage.word'],$func('get.loc.id')
elseif $light_array[$func('get.loc.id')]!'темно':
! если ключ нужен. Производится поиск среди ключей на совпадение короткого имени
	$args['key'] = $func('get.tag.cont',$args['goto'],'key')
	$args['open'] = $func('get.key.inOpen',$args['key'])
	if $args['open']!'':
	! Если есть подходящий ключ
		pl 'Дверь открыта ключом "'+$func('get.tag.cont',$func('get.obj.id',$args['open']),'name')+'".'
		if instr($args['link'],'[locked]')=0: gs 'rpl.str.inObj.id',$args[0],$strfind($args['goto'],'key:[\s\S]+:key')
		$time['goto'] = $func('get.tag.cont',$args['goto'],'time')
		GAME_VALUE['goto'] = 1
		GOTO $args['loc_ID'],$args['DID'],$args['manage.word'],$func('get.loc.id')
	else
	! Если нет подходящего ключа
		pl $func('base.word.screen','017.5')
		if instr($args['link'],'[health:')!0:
		! Если дверь можно сломать
			if instr($args['link'],'[uron:')!0:
				killvar '$shell_iag'
				killvar '$arm_iag'
				gs 'get.shell.inOpen',$func('get.tag.cont',$args['link'],'uron')
				if arrsize('$shell_iag')>0: $menu_iag[arrsize("$menu_iag")]='Использовать снаряды:use.shell.inDoor'
				gs 'get.arm.inOpen',$func('get.tag.cont',$args['link'],'uron')
				if arrsize('$arm_iag')>0: $menu_iag[arrsize("$menu_iag")]='Использовать оружие:use.arm.inDoor'
			end
		end
		if instr($args['link'],'[breake:')!0:
		! Если дверь можно взломать
			killvar '$key_iag'
			! Поиск наиболее подeходящей отмычки!
			$key_iag[arrsize('$key_iag')]='get.key.inBreake',func('get.tag.num',$args['link'],'breake')
			if arrsize('$key_iag')>0: $menu_iag[arrsize("$menu_iag")]='Попытаться вскрыть замок:use.key.inDoor'
		end
		
	end
elseif $light_array[$func('get.loc.id')]='темно':
	*pl $func('base.word.screen','017.4')
	exit
end
--- int.act.goto ---------------------------------

# int.chest.name
! получает информацию о дочерних предметах сундука и преобразует имя сундука
$args[0] = $args[0]	&	!	строка вида		Название сундука[did:[с:1]_ай-ди_сундука:did]
$args['id']=$func('get.tag.cont',$args[0],'did')
$args['name']=$replace($args[0],$strfind($args[0],'.did:'+$args['id']+':did.'))
if здесь_смотрел[$args['id']]<1:
	$result=$args['name']+$func('b.d.t','chest.dont_know')
else
	if $func('get.daughter.obj',$args['id'],'<obj>')='false':
		$result=$args['name']+$func('b.d.t','chest.nope')
	else
		$result=$args['name']+$func('b.d.t','chest.yep')
	end
	killvar '$temp_id'
end
--- int.chest.name ---------------------------------

# int.link
! Интерпретатор ссылок
! Воспроизводит ту или инную ссылку из объекта
! $args[0] - строка вида SHORT_WORD|Первый вариант|Второй вариант|...|Последний вариант
$args[0] = $args[0]
! получаем короткое слово - часть идентификатора ссылки
$args['short_word']=TRIM($func('get.word.inPos',$args[0],1))
! получаем объект по ай-ди
$args['link']=$func('get.obj.id','link.'+$args['short_word'])
if $strfind($args['link'],'<goto:[\s\S]+:goto>')!'':
! если гиперссылка является объектом-переходом:
	! получаем текст по-умолчанию. Этот текст будет выводиться во всех случаях, когда не найден иной текст
	$args['name']=TRIM($func('get.word.inPos',$args[0],2))
	$result='<a class="plain" href="exec:gs '+"'int.act.goto','"+'link.'+$args['short_word']+"'"+'"><font color=#009988>'+$args['name']+'</font></a>'
	exit
elseif $strfind($args['link'],'<obj:[\s\S]+:obj>')!'':
	$args['outObj']=$replace($args['link'],$strfind($args['link'],'<obj:[\s\S]+:obj>'))
	$args['name']=TRIM($func('get.word.inPos',$args[0],3))
	$args['other']=TRIM($func('get.word.inPos',$args[0],2))
	args['pos']	= arrpos('$id_array','link.'+$args['short_word'])
	if $func('sim.time',$respawn_array[args['pos']])!'first':
	! если время респавна меньше или равно текущему.
	! есть два варианта: ссылка спавнится несколько раз
	! (устанавливается значением [repeat:1] Необходимо учитывать,
	! что 0 - это нулевой спавн, то есть, когда игрок первый раз натыкается на ссылку)
	! второй вариант: ссылка спавнится постоянно
	! в charge_array[] производится отсчёт, сколько раз заспавнена ссылка
		args['repeat']=func('get.tag.num',$args['outObj'],'repeat')	&	!	получаем, сколько раз должна спавниться ссылка
		if (instr($args['link'],'[respawn:')=0 and no charge_array[args['pos']]>args['repeat']) or (instr($args['link'],'[respawn:')!0):
			charge_array[args['pos']]+=1	&	!	сколько раз спавнилась ссылка
			kolvo_array[args['pos']]=0	&	!	играет роль метки. 0 - предметы в ссылке полностью респавнятся
			if instr($args['link'],'[respawn:')!0:
				$args['now']=$func('get.time.now')
				$args['new']=$func('get.tag.cont',$args['outObj'],'respawn')
				$respawn_array[args['pos']]=$func('summ.time',$args['now'],$args['new'])
			end
		end
	end
	if kolvo_array[args['pos']]=0 or kolvo_array[args['pos']]=1:
	! если ссылка только что отспавнилась, или спавнилась недавно, но предметы взяты не все.
		$result='<a class="plain" href="exec:gs '+"'int.link.obj','"+'link.'+$args['short_word']+"'"+'"><font color=#009966>'+$args['name']+'</font></a>'
		exit
	elseif kolvo_array[args['pos']]=2:
	! если ссылка недавно спавнилась и выбраны все предметы
		$result='<font color=#009966>'+$args['other']+'</font>'
		exit
	end
end
--- int.link ---------------------------------

# int.dyn.goto
! локация интерпретации безусловных переходов в динамическом тексте:
! текст ссылки, выводимый на экран|название_локации|идентификатор_локации|время|управляющая конструкция|идентификатор исходной локации
$args[0] = $args[0]
$args['text'] = TRIM($func('get.word.inPos',$args[0],1))
$args['last']=$args['text']
$args['loc.name'] = TRIM($func('get.word.inPos',$args[0],2))
if $args['last']=$args['loc.name']: $args['loc.name']='' else $args['last']=$args['loc.name']
$args['loc.id'] = TRIM($func('get.word.inPos',$args[0],3))
if $args['loc.id']='': $args['loc.id']=$args['loc.name']
if $args['last']=$args['loc.id']: $args['loc.id']=$args['loc.name'] else $args['last']=$args['loc.id']
$args['time']=TRIM($func('get.word.inPos',$args[0],4))
if $args['last']=$args['time']: $args['time']='' else $args['last']=$args['time']
$args['manage'] = TRIM($func('get.word.inPos',$args[0],5))
if $args['last']=$args['manage']: $args['manage']='' else $args['last']=$args['manage']
$args['back'] = TRIM($func('get.word.inPos',$args[0],6))
if $args['last']=$args['back']: $args['back']='' else $args['last']=$args['back']
$log_error[]="
text:<<$args['text']>>
name:<<$args['loc.name']>>
id:<<$args['loc.id']>>
manage:<<$args['manage']>>
back:<<$args['back']>>
"
$result = "<a class='plain' href=""exec:$time['goto']='<<$args['time']>>' & GAME_VALUE['goto'] = 1"
$result+= " & goto '<<$args['loc.name']>>','<<$args['loc.id']>>','<<$args['manage']>>','<<$args['back']>>'"">"
$result+="<font color=#009988><<$args['text']>></font></a>"
--- int.dyn.goto ---------------------------------

# int.dyn.back
! Локация получает текст в зависимости от того, какую локацию игрок посетил последней.
! конструкция для передачи
! "локация_1;;текст, выводимый, если предыдущая локация была локация 1|...|локация_N;;текст, выводимый, если предыдущая локация была локация N"
$args[0] = $args[0]
$args[0]='|'+TRIM($args[0])+'|'
! получаем значение по умолчанию
$args['text.null']=$replace($strfind($args[0],'(\|([^;|]+(;|[^|])[^;|]*)+\|)'),'|')
! получаем имя предыдущей локации
$args['back.loc']=$logist[arrsize('$logist')-2]
! ищем имя этой локации в строке
if instr($args[0],$args['back.loc'])!0:
! если в строке имя локации присутствует
	! ищем среди строк ту, которой соответствует наше значение:
	$args['find.str']=$strfind($args[0],'\|([^|]*;;)?\s*(('+"'"+'|")?)\s*'+$args['back.loc']+'\s*\2\s*;;[^|]*\|')
	! возвращаем результат
	$args['result']=$replace($replace($args['find.str'],$mid($args['find.str'],1,instr($args['find.str'],';;')+1)),'|')
else
! если имя локации не присутствует в строке
	!возвращаем результат по умолчанию
	$args['result']=$args['text.null']
end
$result = $args['result']

--- int.dyn.back ---------------------------------

# int.link.obj
! Локация обрабатывает гиперссылку поднятия предмета
! Если есть тег [respawn:] и текущее время превышает время респауна, в kolvo_array восстанавливается количество из тела ссылки.
! Ссылку с таким тегом невозможно удалить с текущей локации.
$args[0] = $args[0]	&	!	id ссылки
args['pos.link'] = arrpos('$id_array',$args[0])	&	!	получаем позицию ссылки в базе
$args['link'] = $object_array[args['pos.link']]	&	!	получаем тело ссылки
if kolvo_array[args['pos.link']]=0:
! kolvo_array[] - используется в качестве метки респавна. 0 - означает, что можно респавнить объект
	! спавн представляет собой следующее:
	! Все дочерние объекты ссылки удаляются
	gosub 'del.obj',$args[0],'not parent'
	! генерируются новые объекты
	! внимание: для генерации объектов, не внесённых в базу, используйте короткое слово пустого объекта [:?:]
	$args['objs.inLink']=$TRIM($func('get.tag.cont',$args['link'],'obj'))	&	!	получаем все объекты, какие есть в ссылке
	args['i']=1
	! начинаем генерацию объектов
	:Game_Adventure_Master
	if $strfind($args['objs.inLink'],'\[io[\d]+:[\s\S]*:io[\d]+\]')!'' and args['i']<999:
	! пока в строке присутствует запись \[io[\d]+:[\s\S]*:io[\d]+\] делаем
		$args['io']=$func('get.tag.cont',$args['objs.inLink'],"io<<args['i']>>")	&	!	вычленяем тело объекта
		args['kolvo']=DYNEVAL($func('get.tag.cont',$args['io'],'kolvo'))	&	!	получаем количество
		args['charge']=DYNEVAL($func('get.tag.cont',$args['io'],'hapj'))	&	!	получаем заряд. Помните: если не указать заряд, он будет равным максимальному значению для предмета или 0
		$args['dyn']=$func('get.tag.cont',$args['io'],'dynamic')	&	!	получаем динамический код. Подробнее смотри в спецификации
		$args['for base']=$replace($args['io'],$strfind($args['io'],'\[kolvo:[\s\S]*:kolvo\]'))	&	!	удаляем количество из тела
		$args['for base']=$replace($args['for base'],$strfind($args['io'],'\[hapj:[\s\S]*:hapj\]'))	&	!	удаляем заряд из тела
		$args['for base']=$replace($args['for base'],$strfind($args['io'],'\[dynamic:[\s\S]*:dynamic\]'))	&	!	удаляем заряд из тела
		gosub 'base.new.obj',$args['for base'],'',$args[0],args['kolvo'],args['charge'],$args['dyn']	&	!	добавляем новый объект
		$args['objs.inLink']=$TRIM($replace($args['objs.inLink'],"[io<<args['i']>>:"+$args['io']+":io<<args['i']>>]"))	&	!	вырезаем из списка исходников обработанный исходник
		args['i']+=1
		jump 'Game_Adventure_Master'
	end
	kolvo_array[args['pos.link']]=1	&	!	объекты респавнились
end
$args['get.daughters']=$func('get.daughter.obj',$args[0],'','$temp_iliob')	&	!	получаем список дочерних объектов ссылки
if $args['get.daughters']='true':
! если дочерние объекты у ссылки существуют
! поочерёдно поднимаем каждый из них
	args['i']=arrsize('$temp_iliob')
	:AVS_int_link_obj
	if arrsize('$temp_iliob')>0:
		! -----------здесь будет проверка на удачу и всё такое----------
		
		! -----------здесь будет проверка на удачу и всё такое----------
		$args['take']=$func('take.obj',$temp_iliob[0])
		! В результате получаем одно из ключевых слов, но нас интересует только одно
		! если объект взят полностью уменьшаем args['i']
		if $args['take']='taken': args['i']-=1
		killvar '$temp_iliob',0
		jump 'AVS_int_link_obj'
	end
	if args['i']=0: kolvo_array[args['pos.link']]=2
else
	! в случае, когда дочерних объектов у ссылки нет, выставляем метку
	kolvo_array[args['pos.link']]=2
	! однако такая ситуация теоретически невозможна, поэтому необходимо пополнить лог ошибок
	$error_log += 'location name: "int.link.obj" ERROR!: Link do not have a daughter.<br>'
end
:print
gs 'true.goto.curloc',$curloc
--- int.link.obj ---------------------------------

# int.inventory
! Интерпретатор инвентаря.
! Выводит список объектов, находящихся в позиции $GAME_VALUE['inventory.floor']
! используется функция get.daughter.obj
if $GAME_VALUE['inventory.floor'] = '':
	$GAME_VALUE['inventory.floor']='INVENTORY'
else
	$GAME_VALUE['inventory.floor'] = $GAME_VALUE['inventory.floor']
end
killobj
killvar '$infop'
if $GAME_INTERFACE['hero.stat']='inventory':
	args['back.number']=2
	$args['interface']+=$replace($replace($func('get.scale.hero'),'<center>'),'</center>')
	addobj $args['interface']
else
	args['back.number']=1
end
args['pos']=arrpos('$id_array',$GAME_VALUE['inventory.floor'])	&	!	вычисляем позицию объекта, дочерние объекты которого мы воспроизводим.
$args['name']=$func('get.tag.cont',$object_array[args['pos']],'name') 
if $position_array[args['pos']]!"":
	! Если объект, который мы выводим, принадлежит другому объекту, первый предмет в инвентаре должен возвращать нас на предыдущий уровень.
	addobj '<table width=100% cellpadding=0 cellspacing=0 border=0><tr><td align=left><img src="'+$func('base.img','back')+'"></td><td align=left><font color=#ff0000><b>&nbsp;&nbsp;&nbsp;'+$args['name']+'</b><font><oid:back:oid><back:'+$position_array[args['pos']]+':back></td></tr></table>','',args['back.number']
end
killvar '$temp_id'	&	! защита от дурака
if $func('get.daughter.obj',$GAME_VALUE['inventory.floor'])='true':
	args['i']=0
	:for
	$args['obj']=$object_array[arrpos('$id_array',$temp_id[args['i']])]
	if instr($args['obj'],'[hide]')=0 and instr($args['obj'],'<property>')=0: gs 'int.inventory.obj',$temp_id[args['i']]
	! если вы хотите, чтобы свойства выводились вместе с основными частями тела, удалите из четырнадцатой строки - and instr($args['obj'],'<property>')=0
	args['i']+=1
	if args['i']<arrsize('$temp_id'): jump 'for'
end
killvar '$temp_id'
--- int.inventory ---------------------------------

# int.inventory.obj
! интерпретатор воссоздаёт предмет в инвентаре по ай-ди.
$args[0] = $args[0] 	&	!	id предмета
args['pit']=arrpos('$id_array',$args[0])
if instr($object_array[args['pit']],'<body>')!0:
! Если объект является "частью тела":
	if $include_array[args['pit']]!'':
	! если часть тела имеет дочерний объект
		args['pos']=arrpos('$id_array',$include_array[args['pit']])	&	!	вычисляем позицию дочернего объекта
		$args['oid']=$id_array[args['pos']]
		jump 'incl'
	else
		$args['empty'] = $func('get.tag.cont',$object_array[args['pit']],'empty')
		addobj $args['empty']+'<oid:'+$args[0]+':oid>' & exit
	end
else
	args['pos']=args['pit']
	$args['oid']=$args[0]
	:incl
	$args['name'] = $func('get.tag.cont',$object_array[args['pos']],'name')
	$args['name'] = $func('get.word.padez',$args['name'],'И')
	if instr($object_array[args['pos']],'[lock.obj]')!0:
		$args['color']='888888'	&	!	цвет залоченых предметов
	else
		$args['color'] = $func('get.tag.num',$object_array[args['pos']],'color')
		if $args['color']='': $args['color']='449900'	&	!	цвет предметов по умолчанию
	end
	if instr($object_array[args['pos']],'<obj>')!0 and kolvo_array[args['pos']]!0: $args['kolvo']=' ('+str(kolvo_array[args['pos']])+')'
end
if $args['name']!'': addobj '<font color=#'+$args['color']+'><b>'+$args['name']+'</b>'+$args['kolvo']+'</font><oid:'+$args['oid']+':oid>'
--- int.inventory.obj ---------------------------------

# int.obj.property
! интерпретатор выводит свойства предмета. ака browzer предметов
! 	"используемые функции:

		get.tag.cont
		get.tag.num
		get.word.end
		
! $args['obj'] - предмет."
$args[0] = $args[0]
$args['obj']=$object_array[arrpos('$id_array',$args[0])]
! [::] [name::name] [st::st] [stoim:176] [weight:50][color:663300][uron: u1:удар u2:пуля p1:1000 p2:125 :uron]
$args['marker'] = $func('get.tag.cont',$args['obj'],"")
$args['name'] = $func('get.tag.cont',$args['obj'],"name")
$args['name'] = $func('get.word.padez',$args['name'],'И')
$args['np'] = $func('get.tag.cont',$args['obj'],"np")
args['stoim']=func('get.tag.num',$args['obj'],"stoim")
if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\s\S]+|торговец;|seller;)')<>'': args['stoim']=func('obj.sale.cost',args['stoim'],$func('get.loc.id'))
args['weight']=func('get.tag.num',$args['obj'],"weight")
$args['stoimost'] = $func('#indiv#',args['stoim'],100,1)
if $args['stoimost']='0': $args['stoimost']=$func('#indiv#',args['stoim'],100,10)
$args['weight'] = $func('#indiv#',args['weight'],100,10)
$args['weight.all']=$func('#indiv#',args['weight']*kolvo_array[arrpos('$id_array',$args[0])],100,10)
$args['color'] = $func('get.tag.num',$args['obj'],"color")
$args['pos'] = $func('get.tag.cont',$args['obj'],"pos")
! название предмета
$args['res.021213'] = '<font color=#'+$args['color']+' face="CyrillicOld" size=+2><b>'+$args['name']+'</b></font><br>'
! краткое описание предмета
if $func('get.tag.cont',$args['obj'],'text')='': $args['text']=$func('base.new.obj',$args['obj'],'text') else $args['text']=$func('get.tag.cont',$args['obj'],'text')
$args['res.021213'] = $args['res.021213'] + $args['text']+' '+$func('get.tag.cont',$args['obj'],'end')+'<br><br>'
! основные и дополнительные свойства предмета
if instr($args['np'],'[оружие]')!0 or instr($args['np'],'[снаряды]')!0 or instr($args['np'],'[заряд]')!0 or instr($args['np'],'[перчатки]')!0:
	$args['uron'] = $func('get.tag.cont',$args['obj'],"uron")
	if $args['uron']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Возможный урон:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','uron',$args['uron'],$args['color'])
	end
	$args['uron_absorb'] = $func('get.tag.cont',$args['obj'],"uron_absorb")
	if $args['uron_absorb']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Свойства поглощения:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','uron_absorb',$args['uron_absorb'],$args['color'])
	end
	if $strfind($args['obj'],'\[DU:[\d\-]+\]')!'':
		args['DU'] = func('get.tag.num',$args['obj'],'DU')
		$args['res.021213'] = $args['res.021213'] + '<br><br><b>Дальность удара: </b>'+$func('#indiv#',args['DU'],100,10)+'<br>'
	end
end
if instr($args['np'],'[доспех]')!0:
	$args['block'] = $func('get.tag.cont',$args['obj'],"block")
	if $args['block']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Свойства защиты:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','block',$args['block'],$args['color'])
	end
	$args['block_absorb'] = $func('get.tag.cont',$args['obj'],"block_absorb")
	if $args['block_absorb']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Свойства поглощения:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','block_absorb',$args['block_absorb'],$args['color'])
	end
	$args['block_repulse'] = $func('get.tag.cont',$args['obj'],"block_repulse")
	if $args['block_repulse']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Отражение урона:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','block_repulse',$args['block_repulse'],$args['color'])
	end
	$args['block_recieve'] = $func('get.tag.cont',$args['obj'],"block_recieve")
	if $args['block_recieve']!'':
		$args['res.021213'] = $args['res.021213'] + '<font color=#000088><b>Рикошет:</b></font><br>'
		$args['res.021213'] = $args['res.021213'] + $func('get.uron.list','block_recieve',$args['block_recieve'],$args['color'])
	end
end
! конец сообщения тип вес стоимость количество в рюкзаке
if $strfind($args['obj'],'\[calibr:[\d]+\]')!'': $args['res.021213'] = $args['res.021213'] +"<b>Калибр: </b>"+$func('base.calibr',$func('get.tag.num',$args['obj'],"calibr"))+'<br>'
if instr($args['np'],'[огнестрельное]')!0:
	$args['daut']=$func('get.daughter.obj',$args[0],'','$id_temp')
	if $args['daut']='true':
		args['maxcharge']=func('get.tag.num',$args['obj'],'maxchrg')
		$args['res.021213']+="<b>Зарядов <<charge_array[arrpos('$id_array',$args[0])]>>/<<args['maxcharge']>>:</b><br>"
		:for_patron
		if arrsize('$id_temp')>0:
			$args['patron.obj']=$object_array[arrpos('$id_array',$id_temp[0])]
			$args['res.021213']+="&nbsp;&nbsp;&bull;&nbsp;&nbsp;<a href='exec:clr & pl $func(""int.obj.property"",""<<$id_temp[0]>>"")'>"+$func('get.word.padez',$func('get.tag.cont',$args['patron.obj'],'name'),'И')+"</a>: <<kolvo_array[arrpos('$id_array',$id_temp[0])]*charge_array[arrpos('$id_array',$id_temp[0])]>>/"+str(func('get.tag.num',$args['patron.obj'],'maxchrg')*kolvo_array[arrpos('$id_array',$id_temp[0])])+'<br>'
			killvar '$id_temp',0
			jump 'for_patron'
		end
	end
end
if instr($args['np'],'[посох]')!0:
	args['maxcharge']=func('get.tag.num',$args['obj'],'maxchrg')
	$args['res.021213']+="<b>Заряд: "+str($func('#indiv#',charge_array[arrpos('$id_array',$args[0])],100,10))+"/"+str($func('#indiv#',args['maxcharge'],100,10))+"</b><br>"
end
$args['types.27122013'] = $replace($replace($args['np'],'['),']',',')
$args['res.021213'] = $args['res.021213'] +"<br><b>Тип: </b>"+mid($args['types.27122013'],1,len($args['types.27122013'])-1)+'<br>'
$args['res.021213'] = $args['res.021213'] +"<b>Вес 1 шт.: </b>"+$args['weight']+'<br>'
if kolvo_array[arrpos('$id_array',$args[0])]>1: $args['res.021213'] = $args['res.021213'] +"<b>Общий вес: </b>"+$args['weight.all']+'<br>'
$args['res.021213'] = $args['res.021213'] +"<b>Стоимость 1 шт.: </b>"+$args['stoimost']+' дублон'+$func('get.word.end',val($args['stoimost']),'|а|ов')+'.<br>'
$args['res.021213']+='<br>'
if $GAME_INTERFACE['obj.image.stat']='hide':
	$result='<font size=-1>'+$args['res.021213']+'</font>'
else
	$result='<font size=-1><table width=100%><tr><td>'+$args['res.021213']+'</td><td align=right valign=top><img src="'+$func('base.new.obj',$args['obj'],'image')+'"></td></tr></table></font>'
end
--- int.obj.property ---------------------------------

# int.hero.property
! получает текст свойства по номеру свойства
! $args[0] - oid свойства
$args[0]=$args[0]
args['pos']=arrpos('$id_array',$args[0])	&	!	позиция в базе
$args['property']=$object_array[args['pos']]	&	!	тело объекта
$args['parent']=$object_array[arrpos('$id_array',$position_array[args['pos']])]	&	!	родительский объект
if instr($args['parent'],'<hero>')!0: $args['prefiks']='hero.'	&	!	префикс свойства
$args['id'] = $func('get.tag.cont',$args['property'])	&	!	короткое имя свойства
$args['color'] =  $func('get.tag.num',$args['property'],'color')	&	!	цвет выводимой надписи
args['size'] =  func('get.tag.num',$args['property'],'size')	&	!	размер выводимой надписи
$args['name'] = $func('get.tag.cont',$args['property'],'name')	&	!	имя выводимой надписи
$args['uron']=$func('get.tag.cont',$args['property'],'block')
if $args['uron']='': $args['uron']=$func('get.tag.cont',$args['property'],'uron')
if args['size']=0: args['size']=1
if $strfind($args['property'],'\[txt\]')!'':
! если свойство текстового свойства, пардон за каламбур.
	if instr($args['property'],'[hidden.name]')!0:
	! если имя свойства скрыто
		$args['res.int.hero.property'] = '<font color=#'+$args['color']+' size='+str(args['size'])+' face="CyrillicOld"> '+$property[$args['prefiks']+$args['id']]+'</font>'+'<br>'
	else
	! если имя свойства не скрыто
		$args['res.int.hero.property'] = '<font color=#'+$args['color']+' size='+str(args['size'])+' face="CyrillicOld"> '+$args['name']+': '+'</font>'+$property[$args['prefiks']+$args['id']]+'<br>'
	end
elseif $strfind($args['property'],'\[hide\]')='':
	if $args['color'] = '': $args['color'] = '000088'
	args['i']=1
	:maxxx
	if $strfind($args['property'],'\[max[\S]*\]')!'':
		$args['res.int.hero.property']='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+':</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.all'],100,10)+'<font color=#'+$func('#+col#',$args['color'],'-44')+'><b>/'+$func('#indiv#',property[$args['prefiks']+$args['id']+'.max'],100,10)+'</b></font>'
	else
		$args['res.int.hero.property']='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+':</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']],100,10)
	end
	if $strfind($args['property'],'\[hand[\S]*\]')!'':
		$args['res.int.hero.property']='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+'(рукопашная):</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.hand'],100,10)
		if property[$args['prefiks']+$args['id']+'.arm']!0: $args['res.int.hero.property']+='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+'(текущим оружием):</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.arm'],100,10)
		if property[$args['prefiks']+$args['id']+'.arrow']!0: $args['res.int.hero.property']+='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+'(текущих стрел):</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.arrow'],100,10)
		if property[$args['prefiks']+$args['id']+'.bolt']!0: $args['res.int.hero.property']+='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+'(текущих болтов):</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.bolt'],100,10)
		if property[$args['prefiks']+$args['id']+'.pula']!0: $args['res.int.hero.property']+='<font color=#'+$args['color']+' size='+str(args['size'])+'><b>'+$args['name']+'(текущих снарядов для огнестрельного оружия):</b></font> '+$func('#indiv#',property[$args['prefiks']+$args['id']+'.pula'],100,10)
	end
	if $strfind($args['property'],'\[up[\S]*\]')!'':
		$args['frqs']=$func('get.tag.cont',$args['property'],'frqs')
		args['year']=func('get.tag.num',$args['frqs'],'year')
		args['day']=func('get.tag.num',$args['frqs'],'day')
		args['hour']=func('get.tag.num',$args['frqs'],'hour')
		args['minute']=func('get.tag.num',$args['frqs'],'minute')
		args['secunde']=func('get.tag.num',$args['frqs'],'secunde')
		if args['year']!0: $args['timed.text']=" <<args['year']>> "+$func('get.word.end',args['year'],'год|года|лет')
		if args['day']!0: $args['timed.text']+=" <<args['day']>> "+$func('get.word.end',args['day'],'день|дня|дней')
		if args['hour']!0: $args['timed.text']+=" <<args['hour']>> "+$func('get.word.end',args['hour'],'час|часа|часов')
		if args['minute']!0: $args['timed.text']+=" <<args['minute']>> "+$func('get.word.end',args['minute'],'минуту|минуты|минут')
		if args['secunde']!0: $args['timed.text']+=" <<args['secunde']>> "+$func('get.word.end',args['secunde'],'секунду|секунды|секунд')
		$args['res.int.hero.property']+=' <font color=#'+$func('#+col#',$args['color'],'-44')+' size='+str(args['size'])+'><b>(</b></font>+'+$func('#indiv#',property[$args['prefiks']+$args['id']+'.up'],100,10)+'<font color=#'+$func('#+col#',$args['color'],'-44')+'><b> в'+$args['timed.text']+'.)</b></font>'+'<br>'
	else
		$args['res.int.hero.property']+='<br>'
	end
	$args['res.021213']+=$args['res.int.hero.property']
	if $args['uron']!'':
		if args['i']=1: $args['res.021213']=''
		$args['trefiks']=$func('get.tag.cont',$args['uron'],'u'+str(args['i']))
		$args['uron']=TRIM($replace($args['uron'],'u'+str(args['i'])+':'+$args['trefiks']+':'+'u'+str(args['i'])))
		if instr($args['property'],'[block:')!0: $args['key_word']='block'
		if instr($args['property'],'[uron:')!0: $args['key_word']='uron'
		$args['name']=$func('get.tag.cont',$args['property'],'name')+' ['+$func('base.word.uron',$args['key_word'],$args['trefiks'])+']'
		$args['id']= $func('get.tag.cont',$args['property'])+'.'+$args['trefiks']
		args['i']+=1
		jump 'maxxx'
	end
	if $args['res.021213']!'': $args['res.int.hero.property']=$args['res.021213']
end
$result=$args['res.int.hero.property']
--- int.hero.property ---------------------------------

# int.counter
! локация воспроизводит визуально счётчик по ай-ди.
$args[0] = $args[0]
args['pit']=arrpos('$id_array',$args[0])
$args['obj']=$object_array[args['pit']]
$args['np']=$func('get.tag.cont',$args['obj'],'np')
$args['name']=$func('get.tag.cont',$args['obj'],'name')
$args['color']=$func('get.tag.num',$args['obj'],'color')
$args['short_name']=$func('get.tag.cont',$args['obj'])
if $args['color']='': $args['color']='008888'
if instr($args['np'],'[level]')!0:
	$args['res.021213']+='<table cellpadding=0 cellspacing=0 border=0>'
	$args['res.021213']+='<tr><td><b><font color=#'+$args['color']+' size=5>'+$args['name']+': </font></b></td>'
	$args['l']=$func('get.tag.cont',$args['obj'],'l')
	if $args['l']='': $args['l']='уровень|уровня|уровню|уровень|уровнем|уровне'
	$args['res.021213']+='<td align=right><font color=#'+$func('#+col#',$args['color'],'-22')+'>'+str(point_count[$args['short_name']+'.level'])+" "+$func('get.word.padez',$args['l'],'И')+'</font></td></tr>'
	$args['p']=$func('get.tag.cont',$args['obj'],'p')
	if $args['p']='': $args['p']='Набрано: '
	$args['res.021213']+='<tr><td><font color=#'+$func('#+col#',$args['color'],'-22')+'><b>'+$args['p']+'</b></font></td><td align=right>'+str(point_count[$args['short_name']+'.point'])
	$args['m']=$func('get.tag.cont',$args['obj'],'m')
	if $args['m']='': $args['m']=' из '
	$args['res.021213']+='<b>'+$args['m']+str(point_count[$args['short_name']+'.marker'])+'</b>'
	$args['max']=$func('get.tag.cont',$args['obj'],'max')
	if $args['max']!'':
		$args['res.021213']+='<b>'+$args['max']+str(point_count[$args['short_name']+'.maximum'])+'</b>'
	end
	$args['up']=$func('get.tag.cont',$args['obj'],'up')
	if $args['up']!'':
		$args['res.021213']+='<b>'+$args['up']+str(point_count[$args['short_name']+'.up'])+'.</b>'
	end
	$args['res.021213']+='</td></tr>'
	$args['s']=$func('get.tag.cont',$args['obj'],'s')
	if $args['s']!'':
		$args['res.021213']+='<tr><td colspan=2><br><font color=#'+$func('#+col#',$args['color'],'-44')+'>'+$args['s']+': </font>'+str(point_count[$args['short_name']+'.marker']-point_count[$args['short_name']+'.point'])+'</td></tr>'
	end
	$args['res.021213']+='</table>'
elseif instr($args['np'],'[easy]')!0:
	$args['res.021213']='<font color=#'+$args['color']+'><b>'+$args['name']+': </b></font>'+str(point_count[$args['short_name']+'.point'])
	$args['max']=$func('get.tag.cont',$args['obj'],'max')
	if $args['max']!'':
		$args['res.021213']+='<b>'+$args['max']+str(point_count[$args['short_name']+'.maximum'])+'</b>'
	end
	$args['up']=$func('get.tag.cont',$args['obj'],'up')
	if $args['up']!'':
		$args['res.021213']+='<b>'+$args['up']+str(point_count[$args['short_name']+'.up'])+'.</b>'
	end
end
$result=$args['res.021213']
--- int.counter ---------------------------------

# int.lighting
! Интерпретатор освещения на текущей локации
! Возвращает значения в зависимости от состояния различных переменных.
! Исходные данные:
!	$func('get.loc.id') - id текущей локации
!	time - vremia
$args['obj']=$object_array[arrpos('$id_array',$func('get.loc.id'))] & ! получаем тело заголовка
$args['place']=$strfind($func('get.tag.cont',$args['obj'],'place'),'\[зависит от времени\]|\[тёмная комната\]|\[вечные сумерки\]') & ! получаем значение свойства местности
killvar '$result'
if $args['place']="[тёмная комната]": $result = 'темно' & exit
if $args['place']="[вечные сумерки]": $result = 'сумерки' & exit
if $args['place']='[зависит от времени]':
	args['time_minute']=time['hour']*60 + time['minute']
	$args['res.021213'] = $func('int.time.hours','сумерки||сумерки|темно')
	$result = $args['res.021213']
end
--- int.lighting ---------------------------------

# int.html.Hn
! заменяет в строке вида ++++лалалалал++++ плюсы, знаки равенства на теги заголовков
$args[0] = $args[0]
if instr($args[0],'+')=1:
	if instr($args[0],'++')=1: args['h']=6	&	! заголовок шестого уровня
	if instr($args[0],'+++')=1: args['h']=5	&	! заголовок пятого уровня
	if instr($args[0],'++++')=1: args['h']=4	&	! заголовок четвёртого уровня	
elseif instr($args[0],'=')=1:
	if instr($args[0],'==')=1: args['h']=3	&	! заголовок третьего уровня
	if instr($args[0],'===')=1: args['h']=2	&	! заголовок второго уровня
	if instr($args[0],'====')=1: args['h']=1	&	! заголовок первого уровня	
end
if args['h']=6 or args['h']=3: args['open']=3 & args['len']=len($args[0])-4
if args['h']=5 or args['h']=2: args['open']=4 & args['len']=len($args[0])-6
if args['h']=4 or args['h']=1: args['open']=5 & args['len']=len($args[0])-8
$result="<H"+str(args['h'])+">"+$mid($args[0],args['open'],args['len'])+"</H"+str(args['h'])+">"
--- int.html.Hn ---------------------------------

# int.time.hours
! Функция возвращает текущее название времени суток в зависимости от часа, или слова переданные в аргументе
! $args[0] - сюда передаются слова, необходимые для возврата. Если передано пустое значение, функция возвращает названия времени суток.
! утро|день|вечер|ночь
if $args[0]='': $args[0]=$func('b.d.t','time.hd')
if time['hour']>=22 or (time['hour']>=0 and time['hour']<5): args['i']=4
if time['hour']>=5 and time['hour']<11: args['i']=1
if time['hour']>=11 and time['hour']<18: args['i']=2
if time['hour']>=18 and time['hour']<22: args['i']=3
$args['gwiP']=$func('get.word.inPos',$args[0],args['i'])
$result=$args['gwiP']
--- int.time.hours ---------------------------------

# int.time.years
! $args[0] - сюда передаются слова, необходимые для возврата. Если передано пустое значение, функция возвращает названия времен года
! лето|осень|зима|весна
if $args[0]='': $args[0]=$func('b.d.t','time.my')
if time['month']=1 or time['month']=12 or time['month']=2: args['i']=3
if time['month']=3 or time['month']=4 or time['month']=5: args['i']=4
if time['month']=6 or time['month']=7 or time['month']=8: args['i']=1
if time['month']=9 or time['month']=10 or time['month']=11: args['i']=2
$args['gwiP']=$func('get.word.inPos',$args[0],args['i'])
$result=$args['gwiP']
--- int.time.years ---------------------------------

# int.time.month
! $args[0] - сюда передаются слова, необходимые для возврата. Если передано пустое значение, функция возвращает названия месяцев
! январь|февраль|март|апрель|май|июнь|июль|август|сентябрь|октябрь|ноябрь|декабрь
if $args[0]='': $args[0]=$func('b.d.t','time.m')
args['i']=time['month']
$args['gwiP']=$func('get.word.inPos',$args[0],args['i'])
$result=$args['gwiP']
--- int.time.month ---------------------------------

# int.time.days
! Функция возвращает текущее название дня недели
! $args[0] - сюда передаются слова, необходимые для возврата. Если передано пустое значение, функция возвращает названия дней недели.
! 'Понедельник|Вторник|Среда|Четверг|Пятница|Суббота|Восскресенье'
if $args[0]='': $args[0]=$func('b.d.t','time.wd')
args['i']=time['weekday']+1
$args['gwiP']=$func('get.word.inPos',$args[0],args['i'])
$result=$args['gwiP']
--- int.time.days ---------------------------------

# int.time.calendar
! календарь выставляет текущие значения времени. Не влияет на работу других скриптов обсчитывающих время.
$args[0] = $args[0]	&	!	расходуемое время
! ------------------------ календарь ------------------------	
	time['sec']		=	time['sec']		&	!	для удобства в каждой минуте принято по сто секунд. Секунды не используются в игре, как времяопределение 10
	time['minute']	=	time['minute']	&	!	текущее время в минутах
	time['hour']	=	time['hour']	&	!	текущее время в часах
	time['day']		=	time['day']		&	!	текущее время в днях (365/366)
	time['date']	=	time['date']	&	!	текущая дата 
	time['weekday']	=	time['weekday']	&	!	текущий день недели
	time['month']	=	time['month']	&	!	номер текущего месяца
	time['year']	=	time['year']	&	!	номер текущего года
	$time['last.all']=$func('get.time.now')
! Календарь может быть изменён в соответствии с требованиями игры. Для этого следует отредактировать текущую локацию
! и локацию summ.time
$args['last.time']=$func('get.time.now')
$args['new.time']=$func('summ.time',$args['last.time'],$args[0])
	time['sec']		=	func('get.tag.num',$args['new.time'],'secunde')
	time['minute']	=	func('get.tag.num',$args['new.time'],'minute')
	time['hour']	=	func('get.tag.num',$args['new.time'],'hour')
	time['day']		=	func('get.tag.num',$args['new.time'],'day')
	args['+weekday']	=	func('get.tag.num',$args['new.time'],'week')
	time['year']	=	func('get.tag.num',$args['new.time'],'year')
	if len(str(time['hour']))=1: $time['hour.onClock']='0'+str(time['hour']) else $time['hour.onClock']=str(time['hour'])
	if len(str(time['minute']))=1: $time['minute.onClock']='0'+str(time['minute']) else $time['minute.onClock']=str(time['minute'])
! вычисляем день недели
args['weekday']=time['weekday']+args['+weekday']
time['weekday']=args['weekday'] mod 7
! Вычисляем дату. Дата определяется простым способом - по номеру дня в году.
if time['year'] mod 4 = 0: args['+1']=1
if time['day']>-1 and time['day']<31:
	time['month']=1
	time['date']=time['day']+1
elseif time['day']>30 and time['day']<59+args['+1']:
	time['month']=2
	time['date']=time['day']-30
elseif time['day']>58+args['+1'] and time['day']<90+args['+1']:
	time['month']=3
	time['date']=time['day']-(58+args['+1'])
elseif time['day']>89+args['+1'] and time['day']<120+args['+1']:
	time['month']=4
	time['date']=time['day']-(89+args['+1'])
elseif time['day']>119+args['+1'] and time['day']<151+args['+1']:
	time['month']=5
	time['date']=time['day']-(119+args['+1'])
elseif time['day']>150+args['+1'] and time['day']<181+args['+1']:
	time['month']=6
	time['date']=time['day']-(150+args['+1'])
elseif time['day']>180+args['+1'] and time['day']<212+args['+1']:
	time['month']=7
	time['date']=time['day']-(180+args['+1'])
elseif time['day']>211+args['+1'] and time['day']<243+args['+1']:
	time['month']=8
	time['date']=time['day']-(211+args['+1'])
elseif time['day']>242+args['+1'] and time['day']<273+args['+1']:
	time['month']=9
	time['date']=time['day']-(242+args['+1'])
elseif time['day']>272+args['+1'] and time['day']<304+args['+1']:
	time['month']=10
	time['date']=time['day']-(272+args['+1'])
elseif time['day']>303+args['+1'] and time['day']<334+args['+1']:
	time['month']=11
	time['date']=time['day']-(303+args['+1'])
elseif time['day']>333+args['+1'] and time['day']<365+args['+1']:
	time['month']=12
	time['date']=time['day']-(333+args['+1'])
end
$time['new.all']=$func('get.time.now')
--- int.time.calendar ---------------------------------

# get.time.now
! получает текущее состояние времени в приемлемом виде
$result="[year:<<time['year']>>] [day:<<time['day']>>] [hour:<<time['hour']>>] [minute:<<time['minute']>>] [secunde:<<time['sec']>>]"
--- get.time.now ---------------------------------

# sim.time
! Сравнение двух временнЫх значений. Используется год, день в году, час, минута секунда
$args[0] = $args[0]	&	!	первое значение. Как правило отличное от текущего
$args[1] = $args[1]	&	!	второе значение. Если не указано, сравнивается с текущим временем.

$args[2] = 'year'
$args[3] = 'day'
$args[4] = 'hour'
$args[5] = 'minute'
$args[6] = 'sec'
if $args[1] = '':
	args['sec']		=	time['sec']	&	!	для удобства в каждой минуте принято по сто секунд. Секунды не используются в игре, как времяопределение 10
	args['minute']	=	time['minute']	&	!	текущее время в минутах
	args['hour']	=	time['hour']	&	!	текущее время в часах
	args['day']		=	time['day']	&	!	текущее время в днях (365/366)
	args['year']	=	time['year']	&	!	номер текущего года
else
	args['sec']		=	func('get.tag.num',$args[1],'secunde')
	args['minute']	=	func('get.tag.num',$args[1],'minute')
	args['hour']	=	func('get.tag.num',$args[1],'hour')
	args['day']		=	func('get.tag.num',$args[1],'day')
	args['year']	=	func('get.tag.num',$args[1],'year')
end
args['sec.new']		=	func('get.tag.num',$args[0],'secunde')
args['minute.new']	=	func('get.tag.num',$args[0],'minute')
args['hour.new']	=	func('get.tag.num',$args[0],'hour')
args['day.new']		=	func('get.tag.num',$args[0],'day')
args['year.new']	=	func('get.tag.num',$args[0],'year')
! {результатом являются три слова: 
'first' - больше первое значение
'second' - больше второе значение
'similar' - одинаковые значения}
args['i']=2
:for
if args[$args[args['i']]+'.new']<args[$args[args['i']]]:
	$result='second'
elseif args[$args[args['i']]+'.new']>args[$args[args['i']]]:
	$result='first'
elseif args['i']<7:
	args['i']+=1
	jump 'for'
elseif args['i']>6:
	$result='similar'
end
--- sim.time ---------------------------------

# summ.time
! локация суммирует время
! ВНИМАНИЕ!!!
! Локация производит суммирование времени как числовых величин. Каждое значение является всего лишь специфическим разрядом.
! поэтому в результате будут не
! первый день первого года, а 0 дней 0 лет! Когда истечёт 24 часа, будет 0 лет 1 день 00 часов 00 минут. Учитывайте это при использовании.
! Високосные годы считаются правильно. Ничего не сдивнуто. 0 лет - означает минус первый год отсчёта. 1 год - означает первый год отсчёта, равно как и "с момента отсчёта прошёл один год"
! $args[0] ... $args[8] - временнЫе промежутки в формате [year:ABC] [day:XYZ] [hour:DE] [minute:FJ] [secunde:NM]
$args[0] = $args[0]
$args[1] = $args[1]
$args[2] = $args[2]
$args[3] = $args[3]
$args[4] = $args[4]
$args[5] = $args[5]
$args[6] = $args[6]
$args[7] = $args[7]
$args[8] = $args[8]
! результатом работы функции является временной промежуток в формате [year:ABC] [day:XYZ] [hour:DE] [minute:FJ] [secunde:NM]
! в некотором роде функция дублирует схему работы календаря. Поэтому она, как и календарь должна подгоняться под текущие нужды игры.
! дополнительный тег, позволяющий вычислить значение до указанного разряда, передаётся в нулевом аргументе
! <sec> - секунды <min> - минуты <hour> - часы <day> - дни
args['i']=1
args['res.year']=func('get.tag.num',$args[0],'year')
args['res.day']=func('get.tag.num',$args[0],'day')
args['res.hour']=func('get.tag.num',$args[0],'hour')
args['res.minute']=func('get.tag.num',$args[0],'minute')
args['res.secunde']=func('get.tag.num',$args[0],'secunde')
:for_add_time
if args['i']<9:
	args['add.year']+=func('get.tag.num',$args[args['i']],'year')
	args['add.day']+=func('get.tag.num',$args[args['i']],'day')
	args['add.hour']+=func('get.tag.num',$args[args['i']],'hour')
	args['add.minute']+=func('get.tag.num',$args[args['i']],'minute')
	args['add.secunde']+=func('get.tag.num',$args[args['i']],'secunde')
	args['i']+=1
	jump 'for_add_time'
end
	args['sec']=args['res.secunde']+args['add.secunde']		&	!	расчётные секунды
	args['+minute']=args['sec']/100							&	!	добавочные минуты. Добавляются к текущему значению минут
	args['res.secunde']=args['sec'] mod 100					&	!	значение секунд выставляется остатком от деления
	! Вычисляем значение минут
	args['minute']=args['res.minute']+args['add.minute']+args['+minute']	&	!	расчётные минуты
	args['+hour']=args['minute']/60							&	!	добавочные часы
	args['res.minute']=args['minute'] mod 60				&	!	минуты в действительное значение
	! вычисляем значение часов
	args['hour']=args['res.hour']+args['add.hour']+args['+hour']
	args['+day']=args['hour']/24
	args['res.hour']=args['hour'] mod 24
	
	! расчёт текущего дня в году.
	! Дни нумеруются с нулевого по последний (так же как и часы и минуты) Нулевой день - это первое января.
	! Расчёт можно выполнить циклически с помощью вычитания. Т.е. сколько раз прогнался цикл, столько лет набежало.
	! подсчитываем количество високосных лет циклом
	args['+year']=args['add.year']		&	!	просто счётчик, использующийся для подсчёта количества лет
	args['year.ok']=args['res.year']	&	!	запоминаем текущий год, чтобы не свихнуть календарь раньше срока
	:for_vc
	if args['+year']>0:
		if $func('get.leapYear',args['year.ok'])='true':
		! если год високосный, добавляем к количеству високосных лет
			args['year.+day']+=1
		end
		args['+year']-=1
		args['year.ok']+=1
		jump 'for_vc'
	end
	args['past.day']=args['add.year']*365+args['year.+day']
	! расчётное количество дней после потраченного:
	args['day']=args['res.day']+args['add.day']+args['+day']+args['past.day']
	! цикл
	:for_year
	! $func('vy',time['year']) - функция, вычисляющая високосность года
	if $func('get.leapYear',args['res.year'])='true' and args['day']=>366:
	! если значение дней достигло 366 (т.е. прошло 366 дней) високосного года
		args['res.year']+=1
		args['day']-=366
		jump 'for_year'
	elseif args['day']=>365:
	! если значение дней достигло 365
		args['res.year']+=1
		args['day']-=365
		jump 'for_year'
	end
	args['res.day']=args['day']
:end_sel
if args['res.year']!0: $args['sum.time']+='[year:'+str(args['res.year'])+'] '
if args['res.day']!0: $args['sum.time']+='[day:'+str(args['res.day'])+'] '
if args['res.hour']!0: $args['sum.time']+='[hour:'+str(args['res.hour'])+'] '
if args['res.minute']!0: $args['sum.time']+='[minute:'+str(args['res.minute'])+'] '
if args['res.secunde']!0: $args['sum.time']+='[secunde:'+str(args['res.secunde'])+']'
if args['+day']+args['add.day']+args['past.day']!0: $args['sum.time']+=' [week:'+str(args['+day']+args['add.day']+args['past.day'])+']'
$result=$args['sum.time']
--- summ.time ---------------------------------

# get.leapYear
! проверка года на високосность
args[0] = args[0]	&	!	аргумент, переданный локации, номер года, високосность, которого хотим проверить
! Если високосность года определяется иным образом, измените эту локацию.
if ((args[0] mod 4 = 0) and (args[0] mod 100!0)) or (args[0] mod 400=0):
! если номер года кратен четырем и не кратен 100, или кратен 400, он считается високосным
	$result='true'
else
	$result='false'
end
--- get.leapYear ---------------------------------

# conv.time
! приводит время к наименьшему указанному в строке разряду.
! внимание, конвертация лет считается от текущего значения времени, если не указано иное
$args[0] = $args[0]	&	!	приводимое время
$args[1] = $args[1]	&	!	к чему нужно привести day hour minute secunde
if args[2] = '':
! год, от которого считаются добавочные дни (+1 на каждый високосный)
	args['time.year']=time['year']
else
	args['time.year']=args[1]
end
args['day']=func('get.tag.num',$args[0],'day')
args['year']=func('get.tag.num',$args[0],'year')
args['hour']=func('get.tag.num',$args[0],'hour')
args['minute']=func('get.tag.num',$args[0],'minute')
args['secunde']=func('get.tag.num',$args[0],'secunde')
! вычисляем количество дней 
args['i']=args['time.year']
:for_you
if args['i']<args['time.year']+args['year']:
	if args['i'] mod 4 = 0:
		args['+day']+=1
	end
	args['i']+=1
	jump 'for_you'
end
args['day.result']=args['year']*365+args['day']+args['+day']
args['hour.result']=args['day.result']*24+args['hour']
args['minute.result']=args['hour.result']*60+args['minute']
! максимальное значение при вычислении минут: 4082 года 283 дня 2 часа 7 минут
args['secunde.result']=args['minute.result']*100+args['secunde']
! максимальное значение при вычислении секунд: 40 лет 302 дня 1 час 56 минут 47 секунд
if $args[1] = 'day':
	args['day.result']+=args['hour']/24
	args['minute']+=(args['hour'] mod 24)*60
	args['day.result']+=args['minute']/1440
	args['secunde']+=(args['minute'] mod 1440)*100
	args['day.result']+=args['secunde']/144000
	args['secunde.result']=(args['secunde'] mod 144000)
	$args['ct']="[day:<<args['day.result']>>]"
elseif $args[1] = 'hour':
	args['hour.result']+=args['minute']/60
	args['secunde']+=(args['minute'] mod 60)*100
	args['hour.result']+=args['secunde']/6000
	args['secunde.result']=(args['secunde'] mod 6000)
	$args['ct']="[hour:<<args['hour.result']>>]"
elseif $args[1] = 'minute':
	args['minute.result']+=args['secunde']/100
	args['secunde.result']=(args['secunde'] mod 100)
	$args['ct']="[minute:<<args['minute.result']>>]"
end
if args['secunde.result']!0: $args['ct']+="[secunde:<<args['secunde.result']>>]"
$result=$args['ct']
--- conv.time ---------------------------------

# add.new.task
! Добавление задания.
! производим поиск дневника. Если указать заранее, можно не проводить такой поиск.
! например внести ай.ди дневника в значение переменной.
if $args[0]='':
	if $func('get.daughter.obj','INVENTORY','<diary>','$id_diary')='true':
		$args[0] = $id_diary[0]
		killvar '$id_diary'
	else
		exit
	end
end
$args[1] = $args[1]	&	!	краткое имя задания
$args[2] = $args[2]	&	!	первая стадия
gs 'add.new.obj','<note> [:'+$args[1]+':] [np:[task]:np] [v:next:v] ',$args[0],'NOTE'
if $args[2]!'': gs 'add.new.stady',$args[0],$args[1],$args[2]
--- add.new.task ---------------------------------

# add.new.stady
! Добавление стадии задания по краткому имени задания.
$args[0] = $args[0]	&	!	ай-ди дневника
$args[1] = $args[1]	&	!	краткое имя задания
$args[2] = $args[2]	&	!	краткое имя стадии
if $args[0]='':
	if $func('get.daughter.obj','INVENTORY','<diary>','$id_diary')='true':
		$args[0] = $id_diary[0]
		killvar '$id_diary'
	else
		killvar '$id_diary'
		exit
	end
end
if $func('get.daughter.obj',$args[0],'<note>[\s\S]*\[:'+$args[1]+':\]','$id_diary')='true':
	args['task.pos']=arrpos('$id_array',$id_diary[0])
	$include_array[args['task.pos']]=$args[1]
	charge_array[args['task.pos']]+=1
	gs 'add.new.obj','<note> [:'+$args[2]+':] [np:[stady]:np] [v:next:v] ',$id_diary[0],'NOTE'
else
	$error_log+='location name: "add.new.stady" ERROR!:Cant Find Task. Cant add Stady.'
end
killvar '$id_diary'
--- add.new.stady ---------------------------------

# add.new.note
$args[0] = $args[0]	&	!	ай-ди дневника
$args[6] = ''
if $args[1]='':
	$args[5] = $input($func('b.d.t','d')+$func('b.d.t','c'))
	$args[1] = "[v:"+$args[5]+":v] "	&	!	тело заметки, может содержать html форматировние
end
if $args[2]='': $args[2]="[name:<<time['date']>>/<<time['month']>>/<<time['year']>> <<time['hour']>>:<<time['minute']>>:name] "
if $args[3]='': $args[3]="[sn:"+$func('get.tag.cont',$object_array[arrpos('$id_array',$func('get.loc.id'))],'name')+":sn] "
if $args[4]='': $args[4]='[np:[note]:np]'
$args['obj']=$func('add.new.obj','<note> '+$args[2]+$args[4]+$args[1]+$args[3],$args[0],'NOTE')
--- add.new.note ---------------------------------

# edit.note
$args[0] = $args[0]	&	!	id заметки
$args[1] = $args[1]	&	!	v или sn
if $args[1]='v': $args['t']=$func('b.d.t','a') else $args['t']=$func('b.d.t','b')
$args['input']=$input($args['t']+$func('b.d.t','c'))
args['pos']=arrpos('$id_array',$args[0])
$object_array[args['pos']]=$replace($object_array[args['pos']],$strfind($object_array[args['pos']],'\['+$args[1]+':[\s\S]*:'+$args[1]+'\]'),'['+$args[1]+':'+$args['input']+':'+$args[1]+']')
--- edit.note ---------------------------------

# prv.task.diary
! Функция проверяет наличие задания и его соответствие условиям
$args[0] = $args[0]	&	!	краткое имя задания
$args[1] = $args[1]	&	!	параметр выполнения next last eror
$args[2] = $args[2]	&	!	краткое имя стадии выполнения
$args[3] = $args[3]	&	!	параметр выполнения стадии next last eror
$args['id.task']=$func('get.id.obj','<note>[\s\S]*(\[:'+$args[0]+':\][\s\S]*\[task\]|\[task\][\s\S]*\[:'+$args[0]+':\])')
args['pos.task']=arrpos('$id_array',$args['id.task'])
$args['v.task']=$func('get.tag.cont',$object_array[args['pos.task']],'v')
if $args[0]!'':
	if $args['id.task']!'false':
		if $args[1]!'':
			if $args[1]=$args['v.task']:
				$args['prv.task.diary']=$args['id.task']
			else
				$args['prv.task.diary']='false'
			end
		else
			$args['prv.task.diary']=$args['id.task']
		end
	else
		$result='false'
		exit
	end
end
$args['id.stady']=$func('get.id.obj','<note>[\s\S]*(\[:'+$args[2]+':\][\s\S]*\[stady\]|\[stady\][\s\S]*\[:'+$args[2]+':\])')
args['pos.stady']=arrpos('$id_array',$args['id.stady'])
$args['v.stady']=$func('get.tag.cont',$object_array[args['pos.stady']],'v')
if $args[2]!'':
	if $args['id.stady']!'false':
		if $args[3]!'':
			if $args[3]=$args['v.stady']:
				$args['prv.task.diary']=$args['id.stady']
			else
				$args['prv.task.diary']='false'
			end
		else
			$args['prv.task.diary']=$args['id.stady']
		end
	else
		$result='false'
		exit
	end
end
$result	=	$args['prv.task.diary']
! Внимание!!! Если в качестве условия проверки были указаны стадия и задание, результат false будет выдаваться при отсутствии хотя бы одной составляющей.
! Чтобы производить поиск только по одному из компонент, не указывайте остальные в качестве аргументов
! Результатом работы функции является ай-ди стадии, либо ай-ди задания, если не указана стадия.
--- prv.task.diary ---------------------------------

# int.diary
! Интерпретатор дневника.
! Сохраняем данные из основного окна
$args[0] = $args[0]	&	!	ай-ди дневника
if $args[1]='':
	if $diary['view']='': $args[1]='small' else $args[1]=$diary['view']
end
$diary['view']=$args[1]
if $diary['tab']='': $diary['tab']='next'
if instr($setScreen,'diary.')=0: $diary['setScreen']=$setScreen
gs 'setScreen','diary.'+$args[1]
if $diary['maintxt']='': $diary['maintxt']=MAINTXT
! В дневнике несколько вкладок. Активная выделена. Неактивные - нет
! Вкладки
!	info - информация о времени в мире и других важных вещах
!	next - задания, которые нужно выполнить
!	last - выполненные задания
!	eror - проваленные задания
!	note - заметки
!	sets - настройки

! создаём выводимый текст:
if $diary['tab']='info':
	$args['text']=$func('int.diary.info')
elseif $diary['tab']='next' or $diary['tab']='last' or $diary['tab']='eror':
	$args['text']=$func('int.diary.task',$args[0],$diary['tab'])
elseif $diary['tab']='note':
	$args['text']=$func('int.diary.note',$args[0])
elseif $diary['tab']='sets':
	$args['text']=$func('int.diary.sets',$args[0])
end
if $GAME_INTERFACE['подсказки']="show": $args['text']=$func('game.help',$diary['tab'])+$func('b.w.s','help')+'<br>'+$args['text']
! рисуем таблицу
$args['diary.table']=''
$args['diary.table']+=$func('int.diary.'+$args[1],$args[0],$args['text'])
*CLEAR
*pl $args['diary.table']
--- int.diary ---------------------------------

# int.diary.big
! "Construct of the diary's table. The Big Table"
	$args[0] = $args[0] 	&	!	ай-ди дневника
	$args[1] = $args[1]		&	!	выводимый текст
	$args[2]='info'
	$args[3]='next'
	$args[4]='last'
	$args[5]='eror'
	$args[6]='note'
	$args[7]='sets'
	args['pos']=arrpos('$args',$diary['tab'])
! цвета
	$args['cur.info_color']='bce7f1'
	$args['cur.next_color']='bce7f1'
	$args['cur.last_color']='bce7f1'
	$args['cur.eror_color']='bce7f1'
	$args['cur.note_color']='bce7f1'
	$args['cur.sets_color']='bce7f1'
! верхняя полоска
	$args['cur.top_info_left']=$func('base.img','aplt')
	$args['cur.top_info_cntr']=$func('base.img','pbrd')
	$args['cur.top_info_rght']=$func('base.img','aprt')
	$args['cur.top_next_left']=$func('base.img','aplt')
	$args['cur.top_next_cntr']=$func('base.img','pbrd')
	$args['cur.top_next_rght']=$func('base.img','aprt')
	$args['cur.top_last_left']=$func('base.img','aplt')
	$args['cur.top_last_cntr']=$func('base.img','pbrd')
	$args['cur.top_last_rght']=$func('base.img','aprt')
	$args['cur.top_eror_left']=$func('base.img','aplt')
	$args['cur.top_eror_cntr']=$func('base.img','pbrd')
	$args['cur.top_eror_rght']=$func('base.img','aprt')
	$args['cur.top_note_left']=$func('base.img','aplt')
	$args['cur.top_note_cntr']=$func('base.img','pbrd')
	$args['cur.top_note_rght']=$func('base.img','aprt')
	$args['cur.top_sets_left']=$func('base.img','aplt')
	$args['cur.top_sets_cntr']=$func('base.img','pbrd')
	$args['cur.top_sets_rght']=$func('base.img','aprt')
! нижняя полоска
	$args['cur.btm_info_left']=$func('base.img','aplb')
	$args['cur.btm_info_cntr']=$func('base.img','pbrd')
	$args['cur.btm_info_rght']=$func('base.img','aprb')
	$args['cur.btm_next_left']=$func('base.img','aplb')
	$args['cur.btm_next_cntr']=$func('base.img','pbrd')
	$args['cur.btm_next_rght']=$func('base.img','aprb')
	$args['cur.btm_last_left']=$func('base.img','aplb')
	$args['cur.btm_last_cntr']=$func('base.img','pbrd')
	$args['cur.btm_last_rght']=$func('base.img','aprb')
	$args['cur.btm_eror_left']=$func('base.img','aplb')
	$args['cur.btm_eror_cntr']=$func('base.img','pbrd')
	$args['cur.btm_eror_rght']=$func('base.img','aprb')
	$args['cur.btm_note_left']=$func('base.img','aplb')
	$args['cur.btm_note_cntr']=$func('base.img','pbrd')
	$args['cur.btm_note_rght']=$func('base.img','aprb')
	$args['cur.btm_sets_left']=$func('base.img','aplb')
	$args['cur.btm_sets_cntr']=$func('base.img','pbrd')
	$args['cur.btm_sets_rght']=$func('base.img','aprb')
! заголовки вкладок
	$args['cur.thd_info_left']=$func('base.img','pbrd')
	$args['cur.thd_info_rght']=$func('base.img','pbrd')
	$args['cur.thd_next_left']=$func('base.img','pbrd')
	$args['cur.thd_next_rght']=$func('base.img','pbrd')
	$args['cur.thd_last_left']=$func('base.img','pbrd')
	$args['cur.thd_last_rght']=$func('base.img','pbrd')
	$args['cur.thd_eror_left']=$func('base.img','pbrd')
	$args['cur.thd_eror_rght']=$func('base.img','pbrd')
	$args['cur.thd_note_left']=$func('base.img','pbrd')
	$args['cur.thd_note_rght']=$func('base.img','pbrd')
	$args['cur.thd_sets_left']=$func('base.img','pbrd')
	$args['cur.thd_sets_rght']=$func('base.img','pbrd')
! верхний разделитель
	$args['cur.thr_info_left']=$func('base.img','pbrd')
	$args['cur.thr_info_cntr']=$func('base.img','pbrd')
	$args['cur.thr_info_rght']=$func('base.img','pbrd')
	$args['cur.thr_next_left']=$func('base.img','pbrd')
	$args['cur.thr_next_cntr']=$func('base.img','pbrd')
	$args['cur.thr_next_rght']=$func('base.img','pbrd')
	$args['cur.thr_last_left']=$func('base.img','pbrd')
	$args['cur.thr_last_cntr']=$func('base.img','pbrd')
	$args['cur.thr_last_rght']=$func('base.img','pbrd')
	$args['cur.thr_eror_left']=$func('base.img','pbrd')
	$args['cur.thr_eror_cntr']=$func('base.img','pbrd')
	$args['cur.thr_eror_rght']=$func('base.img','pbrd')
	$args['cur.thr_note_left']=$func('base.img','pbrd')
	$args['cur.thr_note_cntr']=$func('base.img','pbrd')
	$args['cur.thr_note_rght']=$func('base.img','pbrd')
	$args['cur.thr_sets_left']=$func('base.img','pbrd')
	$args['cur.thr_sets_cntr']=$func('base.img','pbrd')
	$args['cur.thr_sets_rght']=$func('base.img','pbrd')
	
	$args['cur.tvs_info_left']=$func('base.img','aalt')
	$args['cur.tvs_info_cntr']=$func('base.img','abrd')
	$args['cur.tvs_info_rght']=$func('base.img','abrd')
	$args['cur.tvs_next_left']=$func('base.img','abrd')
	$args['cur.tvs_next_cntr']=$func('base.img','abrd')
	$args['cur.tvs_next_rght']=$func('base.img','abrd')
	$args['cur.tvs_last_left']=$func('base.img','abrd')
	$args['cur.tvs_last_cntr']=$func('base.img','abrd')
	$args['cur.tvs_last_rght']=$func('base.img','abrd')
	$args['cur.tvs_eror_left']=$func('base.img','abrd')
	$args['cur.tvs_eror_cntr']=$func('base.img','abrd')
	$args['cur.tvs_eror_rght']=$func('base.img','abrd')
	$args['cur.tvs_note_left']=$func('base.img','abrd')
	$args['cur.tvs_note_cntr']=$func('base.img','abrd')
	$args['cur.tvs_note_rght']=$func('base.img','abrd')
	$args['cur.tvs_sets_left']=$func('base.img','abrd')
	$args['cur.tvs_sets_cntr']=$func('base.img','abrd')
	$args['cur.tvs_sets_rght']=$func('base.img','aart')
! нижний разделитель
	$args['cur.bhr_info_left']=$func('base.img','pbrd')
	$args['cur.bhr_info_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_info_rght']=$func('base.img','pbrd')
	$args['cur.bhr_next_left']=$func('base.img','pbrd')
	$args['cur.bhr_next_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_next_rght']=$func('base.img','pbrd')
	$args['cur.bhr_last_left']=$func('base.img','pbrd')
	$args['cur.bhr_last_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_last_rght']=$func('base.img','pbrd')
	$args['cur.bhr_eror_left']=$func('base.img','pbrd')
	$args['cur.bhr_eror_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_eror_rght']=$func('base.img','pbrd')
	$args['cur.bhr_note_left']=$func('base.img','pbrd')
	$args['cur.bhr_note_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_note_rght']=$func('base.img','pbrd')
	$args['cur.bhr_sets_left']=$func('base.img','pbrd')
	$args['cur.bhr_sets_cntr']=$func('base.img','pbrd')
	$args['cur.bhr_sets_rght']=$func('base.img','pbrd')
	
	$args['cur.bvs_info_left']=$func('base.img','aalb')
	$args['cur.bvs_info_cntr']=$func('base.img','abrd')
	$args['cur.bvs_info_rght']=$func('base.img','abrd')
	$args['cur.bvs_next_left']=$func('base.img','abrd')
	$args['cur.bvs_next_cntr']=$func('base.img','abrd')
	$args['cur.bvs_next_rght']=$func('base.img','abrd')
	$args['cur.bvs_last_left']=$func('base.img','abrd')
	$args['cur.bvs_last_cntr']=$func('base.img','abrd')
	$args['cur.bvs_last_rght']=$func('base.img','abrd')
	$args['cur.bvs_eror_left']=$func('base.img','abrd')
	$args['cur.bvs_eror_cntr']=$func('base.img','abrd')
	$args['cur.bvs_eror_rght']=$func('base.img','abrd')
	$args['cur.bvs_note_left']=$func('base.img','abrd')
	$args['cur.bvs_note_cntr']=$func('base.img','abrd')
	$args['cur.bvs_note_rght']=$func('base.img','abrd')
	$args['cur.bvs_sets_left']=$func('base.img','abrd')
	$args['cur.bvs_sets_cntr']=$func('base.img','abrd')
	$args['cur.bvs_sets_rght']=$func('base.img','aarb')
! открытая вкладка
	$args['cur.cntr_left']=$func('base.img','abrd')
	$args['cur.cntr_rght']=$func('base.img','abrd')
! изменяем расцветку активной вкладки
	$args['cur.'+$diary['tab']+'_color']='99d9ea'
	$args['cur.top_'+$diary['tab']+'_left']=$func('base.img','aalt')
	$args['cur.top_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.top_'+$diary['tab']+'_rght']=$func('base.img','aart')
	$args['cur.btm_'+$diary['tab']+'_left']=$func('base.img','aalb')
	$args['cur.btm_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.btm_'+$diary['tab']+'_rght']=$func('base.img','aarb')
	$args['cur.thd_'+$diary['tab']+'_left']=$func('base.img','abrd')
	$args['cur.thd_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.thd_'+$diary['tab']+'_rght']=$func('base.img','abrd')
	$args['cur.thr_'+$diary['tab']+'_left']=$func('base.img','abrd')
	$args['cur.thr_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.thr_'+$diary['tab']+'_rght']=$func('base.img','abrd')
	$args['cur.bhr_'+$diary['tab']+'_left']=$func('base.img','abrd')
	$args['cur.bhr_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.bhr_'+$diary['tab']+'_rght']=$func('base.img','abrd')
	$args['cur.bvs_'+$diary['tab']+'_left']=$func('base.img','abrd')
	$args['cur.bvs_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.bvs_'+$diary['tab']+'_rght']=$func('base.img','abrd')
	$args['cur.tvs_'+$diary['tab']+'_left']=$func('base.img','abrd')
	$args['cur.tvs_'+$diary['tab']+'_cntr']=$func('base.img','abrd')
	$args['cur.tvs_'+$diary['tab']+'_rght']=$func('base.img','abrd')
	$args['cur.thr_'+$args[args['pos']+1]+'_left']=$func('base.img','da')
	$args['cur.thr_'+$args[args['pos']-1]+'_rght']=$func('base.img','up')
	$args['cur.bhr_'+$args[args['pos']+1]+'_left']=$func('base.img','ua')
	$args['cur.bhr_'+$args[args['pos']-1]+'_rght']=$func('base.img','dp')
! ссылки вкладок
	$args['href.sets']="<center><a href=""exec:$diary['tab']='sets' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.sets')+"</a></center>"
	$args['href.info']="<center><a href=""exec:$diary['tab']='info' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.info')+"</a></center>"
	$args['href.next']="<center><a href=""exec:$diary['tab']='next' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.next')+"</a></center>"
	$args['href.last']="<center><a href=""exec:$diary['tab']='last' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.last')+"</a></center>"
	$args['href.eror']="<center><a href=""exec:$diary['tab']='eror' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.eror')+"</a></center>"
	$args['href.note']="<center><a href=""exec:$diary['tab']='note' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.note')+"</a></center>"
! далее
	$args['close.link']={<a href="exec:*clr & *pl $diary['maintxt'] & gs 'setScreen',$diary['setScreen'] & $diary['maintxt']='' & $diary['setScreen']=''">}
	$args['close.table']='<table width=100% height=15 cellpadding=0 cellspacing=0 border=0><tr><td height=15>'+$args['close.link']+'<img src="'+$func('base.img','sclb')+'" height=15 width=100%></a></td><td height=15 width=200>'+$args['close.link']+'<img src="'+$func('base.img','cls2')+'"></a></td><td height=15>'+$args['close.link']+'<img src="'+$func('base.img','sclb')+'" height=15 width=100%></a></td></tr></table>'
	$args['int.diary.big']+=$args['close.table']+'<br><br>'
	$args['int.diary.big']+="<table width=100% height=90% valign=top cellpadding=0 cellspacing=0 border=0><tr>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.top_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.top_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.top_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.top_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.top_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.top_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.top_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thd_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+">"+$args['href.info']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thd_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thd_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+">"+$args['href.next']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thd_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thd_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+">"+$args['href.last']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thd_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thd_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+">"+$args['href.eror']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thd_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thd_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+">"+$args['href.note']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thd_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thd_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+">"+$args['href.sets']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thd_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thr_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.thr_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thr_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thr_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.thr_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thr_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thr_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.thr_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thr_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thr_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.thr_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thr_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thr_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.thr_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thr_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thr_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.thr_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thr_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.tvs_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.tvs_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.tvs_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.tvs_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.tvs_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.tvs_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.tvs_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.tvs_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.tvs_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.tvs_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.tvs_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.tvs_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.tvs_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.tvs_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.tvs_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.tvs_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.tvs_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.tvs_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr colspan=16>"
$args['int.diary.big']+="<td width=15 bgcolor=#99d9ea><img src='"+$args['cur.cntr_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#99d9ea colspan=16>"+$args[1]+"</td>"
$args['int.diary.big']+="<td width=15 bgcolor=#99d9ea><img src='"+$args['cur.cntr_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.bvs_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.bvs_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.bvs_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.bvs_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.bvs_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.bvs_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.bvs_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.bvs_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.bvs_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.bvs_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.bvs_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.bvs_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.bvs_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.bvs_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.bvs_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.bvs_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.bvs_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.bvs_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.bhr_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.bhr_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.bhr_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.bhr_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.bhr_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.bhr_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.bhr_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.bhr_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.bhr_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.bhr_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.bhr_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.bhr_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.bhr_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.bhr_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.bhr_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.bhr_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.bhr_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.bhr_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thd_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+">"+$args['href.info']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><img src='"+$args['cur.thd_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thd_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+">"+$args['href.next']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><img src='"+$args['cur.thd_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thd_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+">"+$args['href.last']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><img src='"+$args['cur.thd_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thd_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+">"+$args['href.eror']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><img src='"+$args['cur.thd_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thd_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+">"+$args['href.note']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><img src='"+$args['cur.thd_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thd_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+">"+$args['href.sets']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><img src='"+$args['cur.thd_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><img src='"+$args['cur.btm_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><img src='"+$args['cur.btm_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><img src='"+$args['cur.btm_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><img src='"+$args['cur.btm_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><img src='"+$args['cur.btm_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><img src='"+$args['cur.btm_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><img src='"+$args['cur.btm_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr></table>"
$args['int.diary.big']+='<br><br><table width=100% cellpadding=0 cellspacing=0 border=0><tr>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aalt')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><img src="'+$func('base.img','abrd')+'" width=100% height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aart')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aplt')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><img src="'+$func('base.img','pbrd')+'" height=15 width=100%></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aprt')+'" width=15 height=15></td>'
$args['int.diary.big']+='</tr><tr><td bgcolor=#99d9ea width=15><img src="'+$func('base.img','abrd')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td bgcolor=#99d9ea width=80% align=center valign=top>Интересная информация о персонаже</td>'
$args['int.diary.big']+='<td bgcolor=#99d9ea width=15><img src="'+$func('base.img','abrd')+'" width=15></td>'
$args['int.diary.big']+='<td bgcolor=#bce7f1 width=15><img src="'+$func('base.img','pbrd')+'" width=15></td>'
$args['int.diary.big']+="<td bgcolor=#bce7f1><center><font size=7><<time['hour']>>:<<time['minute']>></font></center></td>"
$args['int.diary.big']+='<td bgcolor=#bce7f1 width=15><img src="'+$func('base.img','pbrd')+'" width=15></td></tr><tr>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aalb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><img src="'+$func('base.img','abrd')+'" width=100% height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aarb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aplb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><img src="'+$func('base.img','pbrd')+'" height=15 width=100%></td>'
$args['int.diary.big']+='<td width=15 height=15><img src="'+$func('base.img','aprb')+'" width=15 height=15></td>'
$args['int.diary.big']+='</tr></table>'
$args['int.diary.big']+='<br><br>'+$args['close.table']
$result=$args['int.diary.big']
killvar '$cur'
--- int.diary.big ---------------------------------

# int.diary.big1
! "Construct of the diary's table. The Big Table"
	$args[0] = $args[0] 	&	!	ай-ди дневника
	$args[1] = $args[1]		&	!	выводимый текст
	$args[2]='info'
	$args[3]='next'
	$args[4]='last'
	$args[5]='eror'
	$args[6]='note'
	$args[7]='sets'
	args['pos']=arrpos('$args',$diary['tab'])
! цвета
	$args['cur.info_color']='bce7f1'
	$args['cur.next_color']='bce7f1'
	$args['cur.last_color']='bce7f1'
	$args['cur.eror_color']='bce7f1'
	$args['cur.note_color']='bce7f1'
	$args['cur.sets_color']='bce7f1'
! верхняя полоска
! изменяем расцветку активной вкладки
	$args['cur.'+$diary['tab']+'_color']='99d9ea'
! ссылки вкладок
	$args['href.sets']="<center><a href=""exec:$diary['tab']='sets' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.sets')+"</a></center>"
	$args['href.info']="<center><a href=""exec:$diary['tab']='info' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.info')+"</a></center>"
	$args['href.next']="<center><a href=""exec:$diary['tab']='next' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.next')+"</a></center>"
	$args['href.last']="<center><a href=""exec:$diary['tab']='last' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.last')+"</a></center>"
	$args['href.eror']="<center><a href=""exec:$diary['tab']='eror' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.eror')+"</a></center>"
	$args['href.note']="<center><a href=""exec:$diary['tab']='note' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.note')+"</a></center>"

	$args['close.link']={<a href="exec:*clr & *pl $diary['maintxt'] & gs 'setScreen',$diary['setScreen'] & $diary['maintxt']='' & $diary['setScreen']=''">}
	$args['close.table']='<table width=100% height=15 cellpadding=0 cellspacing=0 border=0><tr><td height=15>'+$args['close.link']+'<src="'+$func('base.img','sclb')+'" height=15 width=100%></a></td><td height=15 width=200>'+$args['close.link']+'<src="'+$func('base.img','cls2')+'"></a></td><td height=15>'+$args['close.link']+'<src="'+$func('base.img','sclb')+'" height=15 width=100%></a></td></tr></table>'
	$args['int.diary.big']+=$args['close.table']+'<br>'
	$args['int.diary.big']+="<table width=100% height=90% valign=top cellpadding=0 cellspacing=0 border=0><tr>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.top_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.top_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.top_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.top_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.top_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.top_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.top_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thd_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+">"+$args['href.info']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thd_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thd_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+">"+$args['href.next']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thd_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thd_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+">"+$args['href.last']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thd_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thd_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+">"+$args['href.eror']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thd_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thd_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+">"+$args['href.note']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thd_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thd_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+">"+$args['href.sets']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thd_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thr_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.thr_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thr_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thr_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.thr_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thr_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thr_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.thr_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thr_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thr_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.thr_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thr_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thr_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.thr_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thr_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thr_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.thr_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thr_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.tvs_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.tvs_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.tvs_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.tvs_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.tvs_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.tvs_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.tvs_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.tvs_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.tvs_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.tvs_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.tvs_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.tvs_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.tvs_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.tvs_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.tvs_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.tvs_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.tvs_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.tvs_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr colspan=16>"
$args['int.diary.big']+="<td width=15 bgcolor=#99d9ea><src='"+$args['cur.cntr_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#99d9ea colspan=16>"+$args[1]+"</td>"
$args['int.diary.big']+="<td width=15 bgcolor=#99d9ea><src='"+$args['cur.cntr_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.bvs_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.bvs_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.bvs_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.bvs_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.bvs_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.bvs_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.bvs_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.bvs_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.bvs_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.bvs_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.bvs_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.bvs_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.bvs_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.bvs_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.bvs_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.bvs_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.bvs_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.bvs_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.bhr_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.bhr_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.bhr_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.bhr_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.bhr_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.bhr_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.bhr_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.bhr_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.bhr_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.bhr_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.bhr_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.bhr_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.bhr_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.bhr_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.bhr_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.bhr_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.bhr_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.bhr_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thd_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+">"+$args['href.info']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+" width=15 height=15><src='"+$args['cur.thd_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thd_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+">"+$args['href.next']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+" width=15 height=15><src='"+$args['cur.thd_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thd_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+">"+$args['href.last']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+" width=15 height=15><src='"+$args['cur.thd_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thd_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+">"+$args['href.eror']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+" width=15 height=15><src='"+$args['cur.thd_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thd_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+">"+$args['href.note']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+" width=15 height=15><src='"+$args['cur.thd_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thd_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+">"+$args['href.sets']+"</td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+" width=15 height=15><src='"+$args['cur.thd_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr><tr>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_info_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.info_color']+"><src='"+$args['cur.btm_info_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_info_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_next_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.next_color']+"><src='"+$args['cur.btm_next_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_next_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_last_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.last_color']+"><src='"+$args['cur.btm_last_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_last_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_eror_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.eror_color']+"><src='"+$args['cur.btm_eror_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_eror_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_note_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.note_color']+"><src='"+$args['cur.btm_note_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_note_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_sets_left']+"' width=15 height=15></td>"
$args['int.diary.big']+="<td bgcolor=#"+$args['cur.sets_color']+"><src='"+$args['cur.btm_sets_cntr']+"' width=100% height=15></td>"
$args['int.diary.big']+="<td width=15 height=15><src='"+$args['cur.btm_sets_rght']+"' width=15 height=15></td>"
$args['int.diary.big']+="</tr></table>"
$args['int.diary.big']+='<br><br><table width=100% cellpadding=0 cellspacing=0 border=1><tr>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aalt')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><src="'+$func('base.img','abrd')+'" width=100% height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aart')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aplt')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><src="'+$func('base.img','pbrd')+'" height=15 width=100%></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aprt')+'" width=15 height=15></td>'
$args['int.diary.big']+='</tr><tr><td bgcolor=#99d9ea width=15><src="'+$func('base.img','abrd')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td bgcolor=#99d9ea width=80% align=center valign=top>Интересная информация о персонаже</td>'
$args['int.diary.big']+='<td bgcolor=#99d9ea width=15><src="'+$func('base.img','abrd')+'" width=15></td>'
$args['int.diary.big']+='<td bgcolor=#bce7f1 width=15><src="'+$func('base.img','pbrd')+'" width=15></td>'
$args['int.diary.big']+="<td bgcolor=#bce7f1><center><font size=7><<time['hour']>>:<<time['minute']>></font></center></td>"
$args['int.diary.big']+='<td bgcolor=#bce7f1 width=15><src="'+$func('base.img','pbrd')+'" width=15></td></tr><tr>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aalb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><src="'+$func('base.img','abrd')+'" width=100% height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aarb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aplb')+'" width=15 height=15></td>'
$args['int.diary.big']+='<td height=15><src="'+$func('base.img','pbrd')+'" height=15 width=100%></td>'
$args['int.diary.big']+='<td width=15 height=15><src="'+$func('base.img','aprb')+'" width=15 height=15></td>'
$args['int.diary.big']+='</tr></table>'
$args['int.diary.big']+='<br>'+$args['close.table']
$result=$args['int.diary.big']
killvar '$cur'
--- int.diary.big1 ---------------------------------

# int.diary.small
! "Construct of the diary's table. The Small Table"
$args[0] = $args[0]
if $args[1] = '': $args[1]='&nbsp;'	&	!	The Text in a Central Cell.
! цвета
$args['info_color']='bbbb44'
$args['next_color']='bbbb44'
$args['last_color']='bbbb44'
$args['eror_color']='bbbb44'
$args['note_color']='bbbb44'
$args['sets_color']='bbbb44'
$args[$diary['tab']+'_color']='dddd66'
! ссылки вкладок
	$args['href.sets']="<center><a href=""exec:$diary['tab']='sets' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.sets')+"</a></center>"
	$args['href.info']="<center><a href=""exec:$diary['tab']='info' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.info')+"</a></center>"
	$args['href.next']="<center><a href=""exec:$diary['tab']='next' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.next')+"</a></center>"
	$args['href.last']="<center><a href=""exec:$diary['tab']='last' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.last')+"</a></center>"
	$args['href.eror']="<center><a href=""exec:$diary['tab']='eror' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.eror')+"</a></center>"
	$args['href.note']="<center><a href=""exec:$diary['tab']='note' & gs 'int.diary','<<$args[0]>>'"">"+$func('b.d.t','diary.note')+"</a></center>"
! строка ссылок
	$args['str.href'] ="<td bgcolor=#"+$args['info_color']+">"+$args['href.info']+"</td>"
	$args['str.href']+="<td bgcolor=#"+$args['next_color']+">"+$args['href.next']+"</td>"
	$args['str.href']+="<td bgcolor=#"+$args['last_color']+">"+$args['href.last']+"</td>"
	$args['str.href']+="<td bgcolor=#"+$args['eror_color']+">"+$args['href.eror']+"</td>"
	$args['str.href']+="<td bgcolor=#"+$args['note_color']+">"+$args['href.note']+"</td>"
	$args['str.href']+="<td bgcolor=#"+$args['sets_color']+">"+$args['href.sets']+"</td>"
$args['close.link']={<font size=1><a class="plain" href="exec:*clr & *pl $diary['maintxt'] & gs 'setScreen',$diary['setScreen'] & $diary['maintxt']='' & $diary['setScreen']=''">Закрыть</a></font>}
$args['time']="<<time['date']>> "+$func('int.time.month','Января|Февраля|Марта|Апреля|Мая|Июня|Июля|Августа|Сентября|Октября|Ноября|Декабря')+" <<time['year']>> года<br>[<<$time['hour.onClock']>>:<<$time['minute.onClock']>>]"
$args['info']=$replace($replace($func('get.scale.hero'),'<center>'),'</center>')
$args['res.061213']+="<table bgcolor=#aaaa33 width=100% cellcpacing=0 cellpadding=5 border=0><tr><td width=5%>"+$args['close.link']+"</td><td><font size=1>&nbsp;</font></td><td width=5%>"+$args['close.link']+"</td></tr></table><br>"
$args['res.061213']+='<center><table width=90% valign=top cellpadding=15 cellspacing=0 border=0>'
$args['res.061213']+='<tr>'
$args['res.061213']+=$args['str.href']
$args['res.061213']+="</tr><tr>"
$args['res.061213']+="<td bgcolor=#dddd66 colspan=6>"+$args[1]+"</td>"
$args['res.061213']+="</tr><tr>"
$args['res.061213']+=$args['str.href']
$args['res.061213']+='</tr>'
$args['res.061213']+='</table></center><br><br><br>'
$args['res.061213']+='<center><table cellpadding=25 cellspacing=0 border=0 width=90%><tr><td width=80% bgcolor=#ffff88>'+$args['info']+'</td><td bgcolor=#bbbb44>'+$args['time']+'</td></tr></table></center><br>'
$args['res.061213']+="<table bgcolor=#aaaa33 width=100% cellcpacing=0 cellpadding=5 border=0><tr><td width=5%>"+$args['close.link']+"</td><td width=90%><font size=1>&nbsp;</font></td><td width=5%>"+$args['close.link']+"</td></tr></table>"
$result=$args['res.061213']
--- int.diary.small ---------------------------------

# int.notes
! интерпретатор заданий
$args[0] = $args[0]	&	!	ай-ди задания
$args[1] = $args[1]	&	!	цвет задания
$args['zadanije.obj']=$object_array[arrpos('$id_array',$args[0])]
$args['zadanije.p']=$func('get.tag.cont',$args['zadanije.obj'])
$args['np']=$func('get.tag.cont',$args['zadanije.obj'],'np')
if instr($args['np'],'[task]')!0:
	$args['zadanije.name']=$func('get.tag.cont',$args['zadanije.obj'],'name')
end
if $args['zadanije.name']!'': $args['int.notes']='<font color=#'+$args[1]+' face="CyrillicOld" size=+2><b>'+$args['zadanije.name']+':</b></font><br>'
$result=$args['int.notes']+$func('[diary]',$args['zadanije.p'],$args[1])
--- int.notes ---------------------------------

# int.diary.info
$result='Очень полезная и интересная информация'
--- int.diary.info ---------------------------------

# int.diary.task
! выводит список заданий
! производим поиск дневника
$args[0] = $args[0]	&	!	ай-ди дневника
$args[1] = $args[1]	&	!	вид задания например
$args['regexp']='<note>[\s\S]*(\[task\][\s\S]*\[v:'+$args[1]+':v\]|\[v:'+$args[1]+':v\][\s\S]*\[task\])'
if $args[1] = 'next': $args['color1']='008888' 	&	$args['color2']='004488'
if $args[1] = 'last': $args['color1']='008800' 	&	$args['color2']='004400'
if $args[1] = 'eror': $args['color1']='aa4400' 	&	$args['color2']='880000' 
$args['gdo']=$func('get.daughter.obj',$args[0],$args['regexp'],'$id_notes')
if $args['gdo']='true':
	args['note']=0
	:tasks
	if args['note']<arrsize('$id_notes'):
		$args['int.diary.task']+=$func('int.notes',$id_notes[args['note']],$args['color1'])+'<br>'
		$args['imitation_gs_dont_use']=$func('get.daughter.obj',$id_notes[args['note']],'\[stady\]','$id_stadies')
		args['stady']=0
		args['sn']=1
		:stadies
		if args['stady']<arrsize('$id_stadies'):
			args['stady.pos']=arrpos('$id_array',$id_stadies[args['stady']])
			$args['np']=$func('get.tag.cont',$object_array[args['stady.pos']],'np')
			if instr($args['np'],'[hide]')=0:
				$args['v']=$func('get.tag.cont',$object_array[args['stady.pos']],'v')
				if $args['v']='next': $args['color']=$args['color2']
				if $args['v']='last': $args['color']=$func('#+col#',$args['color2'],'-44')
				if $args['v']='eror': $args['color']='aa4400'
				$args['int.diary.task']+="<font color=#"+$args['color']+"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Заметка № <<args['sn']>>: </b></font>"+$func('int.notes',$id_stadies[args['stady']])+'<br>'
				args['sn']+=1
			end
			args['stady']+=1
			jump 'stadies'
		end
		args['note']+=1
		jump 'tasks'
	end
end
$result=$args['int.diary.task']
killvar '$id_notes'
killvar '$id_stadies'
--- int.diary.task ---------------------------------

# int.diary.note
$args[0] = $args[0]	&	!	id - дневника
if $diary['view']='small':
	$args['bgc1']='eeee77'
	$args['bgc2']='cccc55'
	$args['bgc3']=''
else
	$args['bgc1']='88c8d9'
	$args['bgc2']='a9e9fa'
	$args['bgc3']=''
end
:new
$args['note']=$func('get.daughter.obj',$args[0],'<note>[\s\S]*\[note\]','$array_note')
if $args['note']='false':
	$args['head']=$func('add.new.note',$args[0],"[v:<img src='"+$func('base.img','note')+"'> Содержимое заметки:v]","[name:Название заметки:name]","[sn:<img src='"+$func('base.img','ps')+"'> Примечание:sn]","[np:[note] [lock-button]:np]")
	$args['adding']=$func('add.new.note',$args[0],"[v::v]","[name::name]","[sn::sn]","[np:[note] [lock-button]:np]")
	killvar '$array_note'
	jump 'new'
elseif $args['note']='true':
	$args['table.note']='<table width=100% align=left cellspacing=0 cellpadding=5 border=0>'
	args['i']=0
	:for
	if args['i']<arrsize('$array_note'):
		if args['i'] mod 2 = 0: $args['bgc']=$args['bgc1'] else $args['bgc']=$args['bgc2']
		if args['i']<2: $args['bgc']=$args['bgc3']
		$args['table.note']+='<tr bgcolor=#'+$args['bgc']+' valign=middle>'
		args['pos']=arrpos('$id_array',$array_note[args['i']])
		$args['obj']=$object_array[args['pos']]
		$args['содержимое заметки']=$func('get.tag.cont',$args['obj'],'v')
		$args['название заметки']=$func('get.tag.cont',$args['obj'],'name')
		$args['примечание к заметке']=$func('get.tag.cont',$args['obj'],'sn')
		$args['набор признаков']=$func('get.tag.cont',$args['obj'],'np')
		if args['i']=1: $args['link.add']='<a href="exec:'+"gs 'add.new.note','<<$args[0]>>' & gs 'int.diary','<<$args[0]>>'"+'" title="добавить заметку"><img src="'+$func('base.img','add')+'"></a>' else $args['link.add']=''
		if instr($args['набор признаков'],'[lock-button]')=0:
			if args['i']>2: $args['link.up']='<a href="exec:'+"gs 'rtp.obj','"+$array_note[args['i']]+"','"+$array_note[args['i']-1]+"' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','toup')+'"></a>' else  $args['link.up']=''
			if args['i']+1<arrsize('$array_note'): $args['link.down']='<a href="exec:'+"gs 'rtp.obj','"+$array_note[args['i']]+"','"+$array_note[args['i']+1]+"' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','down')+'"></a>' else $args['link.down']=''
			$args['link.edit']='<a href="exec:'+"gs 'edit.note','"+$array_note[args['i']]+"','v' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','edit')+'"></a>'
			$args['link.edtprim']='<a href="exec:'+"gs 'edit.note','"+$array_note[args['i']]+"','sn' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','edtp')+'"></a>'
			$args['link.del']='<a href="exec:'+"gs 'del.obj.id','"+$array_note[args['i']]+"' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','del')+'"></a>'
		else
			$args['link.up']=''
			$args['link.down']=''
			$args['link.edit']=''
			$args['link.del']=''
		end
		$args['table.note']+='<td >'+$args['название заметки']+'&nbsp;	&nbsp;	&nbsp;	&nbsp;	&nbsp;'+$args['содержимое заметки']+'</td><td>'+$args['примечание к заметке']+'&nbsp;	&nbsp;	&nbsp;	&nbsp;	&nbsp;<div align=right>'+$args['link.add']+$args['link.up']+$args['link.down']+$args['link.edit']+$args['link.edtprim']+$args['link.del']+'</div></td>'
		$args['table.note']+='</tr>'
		args['i']+=1
		jump 'for'
	end
	$args['table.note']+='<tr bgcolor='+$args['bgc3']+'>'
	$args['table.note']+='<td align=right colspan=2>'+'<a href="exec:'+"gs 'add.new.note','<<$args[0]>>' & gs 'int.diary','<<$args[0]>>'"+'" title="добавить заметку"><img src="'+$func('base.img','add')+'"></a>'+'</td>'
	$args['table.note']+='</tr>'
	$args['table.note']+='</table>'
end
killvar '$array_note'
$result=$args['table.note']
--- int.diary.note ---------------------------------

# int.diary.sets
$args[0] = $args[0]
$args['res.021213']=''
if $GAME_INTERFACE['обучение']="show":
	$args['help.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['обучение']='hide' & gs 'int.diary','<<$args[0]>>'"+'">Выключить режим обучения</a>'
	$args['help.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['обучение']='hide' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','on')+'" width=25 height=25></a>'
else
	$args['help.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['обучение']='show' & gs 'int.diary','<<$args[0]>>'"+'">Включить режим обучения</a>'
	$args['help.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['обучение']='show' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','off')+'" width=25 height=25></a>'
end
if $GAME_INTERFACE['подсказки']="show":
	$args['подсказки.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['подсказки']='hide' & gs 'int.diary','<<$args[0]>>'"+'">Выключить советы по интерфейсу</a>'
	$args['подсказки.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['подсказки']='hide' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','on')+'" width=25 height=25></a>'
else
	$args['подсказки.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['подсказки']='show' & gs 'int.diary','<<$args[0]>>'"+'">Включить советы по интерфейсу</a>'
	$args['подсказки.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['подсказки']='show' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','off')+'" width=25 height=25></a>'
end
if $GAME_INTERFACE['show.input']='show':
	showinput 1
	$args['input.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['show.input']='hide' & gs 'int.diary','<<$args[0]>>'"+'">Скрыть строку ввода</a>'
	if $GAME_INTERFACE['подсказки']="show": $args['input.txt']+=$func('game.help','comcom')+$func('b.w.s','help')
	$args['input.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['show.input']='hide' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','on')+'" width=25 height=25></a>'
else
	showinput 0
	$args['input.txt']='<a class="plain" href="exec:'+"$GAME_INTERFACE['show.input']='show' & msg 'внимание!!! неумелое пользование чит-командами может привести к краху игры!' & gs 'int.diary','<<$args[0]>>'"+'">Показать строку ввода</a>'
	if $GAME_INTERFACE['подсказки']="show": $args['input.txt']+=$func('game.help','commandcom')+$func('b.w.s','help')
	$args['input.img']='<a class="plain" href="exec:'+"$GAME_INTERFACE['show.input']='show' & msg 'внимание!!! неумелое пользование чит-командами может привести к краху игры!' & gs 'int.diary','<<$args[0]>>'"+'"><img src="'+$func('base.img','off')+'" width=25 height=25></a>'
end
$args['сменить представление.img']='<img src="'+$func('base.img','diary.'+$diary['view'])+'" width=25 height=25>'
$args['сменить представление.txt']=$func('b.d.t','diary.change')
if $diary['view']='small':
	$args['next.view']='big'
elseif $diary['view']='big':
	$args['next.view']='big1'
elseif $diary['view']='big1':
	$args['next.view']='small'
end
$args['сменить представление.href']="<a href=""exec:$diary['view']='"+$args['next.view']+"' & gs 'int.diary','<<$args[0]>>'"" class=""plain"">"
$args['сменить представление.txt']=$args['сменить представление.href']+$args['сменить представление.txt']+'</a>'
$args['сменить представление.img']=$args['сменить представление.href']+$args['сменить представление.img']+'</a>'
$args['res.021213']+='<table width=50% align=left border=0 cellspacing=3>'
$args['res.021213']+='<tr colspan=2><td align=left colspan=2><u>Помощь:</u></td></tr>'
$args['res.021213']+='<tr><td align=right width=50 valign=top>'+$args['help.img']+'</td><td align=left>'+$args['help.txt']+'</td></tr>'
$args['res.021213']+='<tr><td align=right width=50 valign=top>'+$args['подсказки.img']+'</td><td align=left>'+$args['подсказки.txt']+'</td></tr>'
$args['res.021213']+='<tr colspan=2><td align=left colspan=2>Управление интерфейсом:</td></tr>'
$args['res.021213']+='<tr><td align=right width=50 valign=top>'+$args['input.img']+'</td><td align=left>'+$args['input.txt']+'</td></tr>'
$args['res.021213']+='<tr><td align=right width=50 valign=top>'+$args['сменить представление.img']+'</td><td align=left>'+$args['сменить представление.txt']+'</td></tr>'
$args['res.021213']+='</table>'
$result=$args['res.021213']
--- int.diary.sets ---------------------------------

# gen.ahref.actObj
! Генератор гиперссылок для одевания предмета! Внимание ссылки предназначены только для одевания предметов, находящихся в рюкзаке
$args[0] = $args[0]	&	!	id предмета
$args['name']=$func('get.tag.cont',$object_array[arrpos('$id_array',$args[0])],"name")
$args['name'] = $func('get.word.padez',$args['name'],'В')
$result = '<a href="exec:gs '+"'menu.in.body','"+$args[0]+"' & gs 'print.word'"+'">Использовать '+$args['name']+"</a>"
--- gen.ahref.actObj ---------------------------------

# gen.act.obj
! генерирует действие для поднятия предмета
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	ай-ди локации
$args[2] = $args[2]	&	!	режим: acts - получаем действия в виде динамического кода href - получаем гиперссылки пустое значение - действия добавляются напрямую
$args[3] = $args[3]	&	!	различные надстройки. Т.е. какую инфу нам хотелось бы видеть при отображении предмета:
!	[count] - количество
!	[weight] - только при наличии count - вес
!	[take: ] - содержимое тега. Указанное слово или слово по-умолчанию из базы.
!	[cost] - стоимость
!	[spirit] - духовная ценность
if $light_array[$args[1]]='темно': jump 'fin'	&	!	в темноте нельзя разглядеть предметов, завершаем
! ------------------ различные свойства предметов ----------
	$args['obj']=$func('get.obj.id',$args[0])
	args['pos']=arrpos('$id_array',$args[0])
	$args['name']=$func('get.tag.cont',$args['obj'],'name')
	$args['name']=$func('get.word.padez',$args['name'],'В')
	args['weight']=func('get.tag.num',$args['obj'],'weight')
	if kolvo_array[args['pos']]!0 and instr($args[3],'[count]')<>0: $args['kolvo']=' ('+str(kolvo_array[args['pos']])+' штук'+$func('get.word.end',kolvo_array[args['pos']],'а|и|')
	if args['weight']!0 and instr($args[3],'[weight]')<>0: $args['kolvo']+=' x '+$func('#indiv#',args['weight'],100,10)+')' else $args['kolvo']+=')'
! ------------------ различные свойства предметов ----------
! слово подъёма
$args['[take]']=$func('get.tag.num',$args[3],'take')
if $args['[take]']='' or $args['[take]']='take':
	$args['поднять']+=$func('b.d.t','take')
elseif $args['[take]']='lift':
	$args['поднять']+=$func('b.d.t','lift')
elseif $args['[take]']='buy':
	$args['поднять']+=$func('b.d.t','buy')
else
	$args['поднять']+=$args['[take]']
end
! стоимость cost:
if instr($args[3],'[cost]')<>0:
	args['stoim']=func('get.tag.num',$args['obj'],"stoim")
	$args['stoimost']=$func('#indiv#',func('obj.purc.cost',args['stoim'],$args[1]),100,1)
	!	заменить на обращение к базе
	$args['купить за']=" по "+$args['stoimost']+' дублон'+$func('get.word.end',val($args['stoimost']),'|а|ов')+"."
end
! духовная ценность:
if instr($args[3],'[spirit]')<>0:
	args['духовная ценность']=func('get.spirit',$args[0],$args[1])
	$args['дух']=" ("+$func('#indiv#',args['духовная ценность'],100,10)+" ед. кармы) "
else
	$args['дух']=""
end
! формируем название действия из всего вышеперечисленного
$args['actions.text']=$args['поднять']+$args['name']+$args['kolvo']+$args['купить за']+$args['дух']

if $args[2]='href' or $args[2]='':
	if instr($args['obj'],'[lock-obj]')=0:
		$args['res.021213']+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="plain" href="exec:'+"gs 'take.obj','<<$args[0]>>' & GS 'true.goto.curloc','"+$curloc+"'"+'"><font color=#880088>'+$args['actions.text']+'</font></a><br>'
	else
		$args['res.021213']+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="plain" href="exec:'+"$print['take.obj']+=$func('b.w.s','loc-obj') & GS 'true.goto.curloc','"+$curloc+"'"+'"><font color=#888888>'+$args['actions.text']+'</a></font><br>'
	end
elseif $args[2]='acts':
	if instr($args['obj'],'[lock-obj]')=0:
$args['res.021213']="
act '<font color=#880088><<$args['actions.text']>><oid:<<$args[0]>>:oid></font>':
	$args['oid']=$func('get.tag.cont',$selact,'oid')
	gs 'take.obj',$args['oid']
	GS 'true.goto.curloc',$curloc
end
"
	else
$args['res.021213']="
act '<font color=#888888><<$args['actions.text']>></font>':
	$print['take.obj']+=$func('b.w.s','loc-obj')
	GS 'true.goto.curloc',$curloc
end"
	end
end
:fin
$result=$args['res.021213']
--- gen.act.obj ---------------------------------

# gen.act.goto
! Локация воссоздаёт действие из тела условного перехода
$args[0] = $args[0]	&	!	ай-ди условного перехода
$args[1] = $args[1]	&	!	ай-ди локации
$args[2] = $args[2]	&	!	href acts - вид действия
$args[3] = $args[3]	&	!	дополнительные команды
! получаем некоторую инфу о переходе
$args['obj']=$object_array[arrpos('$id_array',$args[0])]	&	!	тело объекта "переход"
$args['loc']=$func('get.tag.cont',$args['obj'],'loc')		&	!	направление перехода ай-ди локации, на которую нужно попасть
$args['name']=$func('get.tag.cont',$args['obj'],'name')		&	!	название перехода
if $light_array[$args[1]]='темно':
! если на локации темно, вид переходов несколько меняется
	$args['name']=$func('b.d.t','dark.goto')	&	!	название во тьме
	! блок текста, выводимый, если в тёмном помещении не виден торговец или сундук
	if $args['loc']='[chest]' and $SQUARE['SQUARE.location.indark.chest']='': $SQUARE['SQUARE.location.indark.chest']=$func('b.w.s','dark.chest')
end
if $strfind($args['obj'],'\[key:[\s\S]*:key\]')<>'': $args['key']='need' &	!	необходимость ключа

if ($light_array[$args[1]]='темно' and $args['loc']<>"[chest]" and $args['key']<>'need') or $light_array[$args[1]]<>'темно':
! если переход на локацию места и для него не нужен ключ
	if $args[2]='href' or $args[2]='':
	! если формируется ссылка
		$args['res.021213']="<a class=""plain"" href=""exec:gs 'int.act.goto','<<$args[0]>>'""><<$args['name']>></a><br>"
	elseif $args[2]='acts':
	! если формируется действие
$args['acts']+="
act '<<$args['name']>><oid:<<$args[0]>>:oid>':
	$args['oid']=$func('get.tag.cont',$selact,'oid')
	gs 'int.act.goto',$args['oid']
end
"
	$args['res.021213']=$args['acts']
	end
end
$result=$args['res.021213']
--- gen.act.goto ---------------------------------

# gen.act.act
! генератор уникальных действий
$args[0] = $args[0]	&	!	ай-ди действия
$args[1] = $args[1]	&	!	ай-ди локации
$args[2] = $args[2]	&	!	acts href - действия или ссылка
$args[3] = $args[3]	&	!	дополнительные опции
args['pit']=arrpos('$id_array',$args[0])
$args['obj']=$object_array[args['pit']]
$args['name']=$func('get.tag.cont',$args['obj'],'name')
if instr($args['obj'],'[lock-obj]')<>0: $args['lock']='lock'
if $light_array[$args[1]]='темно':
! если на локации темно
	if instr($args['obj'],'[dark-hide]')<>0: jump 'fin'	&	!	скрывать в темноте. Не выводится
	$args['dark.name']=$func('get.tag.cont',$args['obj'],'dark-name')	&	!	имя в темноте
	if $args['dark.name']<>'': $args['name']=$args['dark.name']
	if instr($args['obj'],'[dark-lock]')<>0: $args['lock']='lock'
end
if $args['lock']='lock':
	$args['name']="<font color=#888888>"+$args['name']+"</font>"
	$args['acts.code']="$print['take.obj']+=$func('b.w.s','loc-act') & gosub 'true.goto.curloc','<<$args[1]>>'"
else
	$args['acts.code']="gosub 'run.dynamic.script','!from.act!','<<$args[0]>>'"
end
if $args[2]='href' or $args[2]='':
	$args['res.021213']='<a class="plain" href="exec:<<$args["acts.code"]>>"><<$args["name"]>></a><br>'
elseif $args[2]='acts':
$args['res.021213']="
act '<<$args['name']>>':
	<<$args['acts.code']>>
end
"
end
:fin
$result=$args['res.021213']
--- gen.act.act ---------------------------------

# gen.loc.head
! генератор стандартных заголовков для локаций хранения
$args[0]=$args[0]	&	!	передаёт ай-ди сундука
$args[1]=$args[1]	&	!	передаёт управляющее слово

if instr($args[1],'set_smithing')!0:
	$args['spec']+='[smithing]'
end
if instr($args[1],'set_altar')!0:
	$args['spec']+='[altar]'
end
if instr($args[1],'set_alchemic')!0:
	$args['spec']+='[alchemic]'
end
if $args['spec']!'': gs 'add.new.obj','<заголовок> [spec:'+$args['spec']+':spec]','',$args[0]
--- gen.loc.head ---------------------------------

# add.new.obj
! Подпрограмма создаёт новый объект в игре и присваивает ему айдишник
! Если используется в качестве функции, в результат возвращается ай-дишник
$args[0] = $args[0]	&	!	 - тело объекта, исходник объекта
$args[1] = $args[1]	&	!	 - положение, где находится объект
$args[2] = $args[2]	&	!	 - Ключевое слово (короткое слово, идентификатор вида)
args[3] = args[3]	&	!	 - количество одинаковых предметов
args[4] = args[4]	&	!	 - заряд предмета
$args[5] = $args[5]	&	!	 - динамический код, выполняемый во время действий с предметом.
args[6] = args[6]	&	!	 - позиция в которую нужно добавить предмет в базе !!!! ВНИМАНИЕ. Если в этой позиции в базе уже есть предмет, он будет затёрт.
if args[6]!0: args['num']=args[6] else args['num'] = arrsize('$id_array')
$object_array[args['num']]=$args[0]	&	!	создаём объекту тело
! если объект является заголовком или инвентарём или респавнером, его ай-ди 
if $strfind($args[0],'<заголовок>')!'' or $args[2] = 'INVENTORY' or $args[2]='RESPAWNER':
	$id_array[args['num']]=$args[2]
elseif $strfind($args[0],'<link>')!'':
	$id_array[args['num']]='link.'+TRIM($args[2])
else
	$id_array[args['num']]=$args[2]+'.'+$func('#rndstr#',8,'буквы и цифры')
end
if $strfind($args[0],'<заголовок>')!'' and instr($args[0],'[respawn.stop]')=0:
	$position_array[args['num']]='RESPAWNER'
else
	$position_array[args['num']]=$args[1]
end
kolvo_array[args['num']]=args[3]
charge_array[args['num']]=args[4]
$run_array[args['num']]=$args[5]
$result = $id_array[args['num']]
--- add.new.obj ---------------------------------

# rtp.obj
! меняет два объекта местами. полезно для сортировки
$args[0] = $args[0]	&	!	ай-ди одного объекта
$args[1] = $args[1]	&	!	ай-ди другого объекта
args['pos0'] = arrpos('$id_array',$args[0])
args['pos1'] = arrpos('$id_array',$args[1])
! запоминаем данные из нулевого объекта
$args['obj0']=$object_array[args['pos0']]
$args['p0']=$position_array[args['pos0']]
$args['in0']=$include_array[args['pos0']]
args['kolvo0']=kolvo_array[args['pos0']]
args['charge0']=charge_array[args['pos0']]
$args['respawn0']=$respawn_array[args['pos0']]
$args['run0']=$run_array[args['pos0']]
! заменяем нулевой объект первым
$id_array[args['pos0']]=$args[1]
$object_array[args['pos0']]=$object_array[args['pos1']]
$position_array[args['pos0']]=$position_array[args['pos1']]
$include_array[args['pos0']]=$include_array[args['pos1']]
kolvo_array[args['pos0']]=kolvo_array[args['pos1']]
charge_array[args['pos0']]=charge_array[args['pos1']]
$respawn_array[args['pos0']]=$respawn_array[args['pos1']]
$run_array[args['pos0']]=$run_array[args['pos1']]
! заменяем первый объект данными из нулевого
$id_array[args['pos1']]=$args[0]
$object_array[args['pos1']]=$args['obj0']
$position_array[args['pos1']]=$args['p0']
$include_array[args['pos1']]=$args['in0']
kolvo_array[args['pos1']]=args['kolvo0']
charge_array[args['pos1']]=args['charge0']
$respawn_array[args['pos1']]=$args['respawn0']
$run_array[args['pos1']]=$args['run0']
--- rtp.obj ---------------------------------

# del.obj
! Удаляет предмет из игры по ай-дишнику. А так же все унаследованные предметы.
! $args[0] - айдишник
$args[0] = $args[0]
$args[1] = $args[1]	&	!	'not parent' - удалятся все объекты, кроме родительского
gs 'get.daughter.obj.all',$args[0],'','$temp_id'
if $args[1]!'not parent': $temp_id[arrsize('$temp_id')]=$args[0]
args['i']=0
:while
if args['i']<arrsize('$temp_id'):
	gs 'del.obj.id',$temp_id[args['i']]
	gs 'clr.parent.obj',$temp_id[args['i']]
	args['i']+=1
	jump 'while'
end
killvar '$temp_id'
--- del.obj ---------------------------------

# del.obj.id
! Удаляет предмет по ай-дишнику
$args[0] = $args[0]
args['pos']=arrpos('$id_array',$args[0])
killvar '$id_array',args['pos']
killvar '$object_array',args['pos']
killvar '$position_array',args['pos']
killvar '$include_array',args['pos']
killvar 'kolvo_array',args['pos']
killvar 'charge_array',args['pos']
killvar '$respawn_array',args['pos']
killvar '$run_array',args['pos']
--- del.obj.id ---------------------------------

# clr.parent.obj
! Функция очищает все родительские объекты от дочернего
$args[0] = $args[0]	&	!	id дочернего объекта
args['pos']=-1
:for
args['pos']=arrpos(args['pos']+1,'$include_array',$args[0])
if args['pos']!-1: $include_array[args['pos']]='' else exit
jump 'for'
--- clr.parent.obj ---------------------------------

# get.id.obj
! функция получает первый в списке объект, соответствующий регулярному выражению:
! $args[0] - регулярное выражение
! $result - ай-ди соответствующего объекта
args['pos']=arrcomp('$object_array','[\s\S]*'+$args[0]+'[\s\S]*')
if args['pos']!-1: $result=$id_array[args['pos']] else $result='false'
--- get.id.obj ---------------------------------

# get.obj.id
! Функция получает содержимое объекта из ай-дишника
! $args[0] - айди
$args[0] = $args[0]
$result=$object_array[arrpos('$id_array',$args[0])]
--- get.obj.id ---------------------------------

# get.daughter.obj
! Функция получает все дочерние объекты для данного ай-ди.
! Результатом является true - есть дочерние, false - нет дочерних
! так же заполняется массив $temp_id
$args[0] = $args[0] &	! $args[0] - ай-ди родительского объекта
$args[1] = $args[1]	&	! $args[1] - регулярное выражение по которому производится дополнительная фильтрация
if $args[2] = '': $args[2] = '$temp_id'	&	!	массив, в который вносятся ай-ди дочерних объектов.
if instr($args[2],'$')<>1: $args[2]='$'+$args[2]
$args[3] = $args[3]	&	!	дополнительная проверка.
if $args[4] = '': $args[4]='position'
! регулярное выражение по которому производится дополнительная фильтрация. Сортировка идёт по данным в массиве $run_array[]
args['log.start']=msecscount
$args['gdo']='false'
args['pos']=-1
:for
args['pos']=arrpos(args['pos']+1,'$<<$args[4]>>_array',$args[0])
if args['pos']<>-1 and args['i']<>args['pos']:
	args['i']=args['pos']
	if $args[1]='' or $strfind($object_array[args['pos']],$args[1])<>'':
		if $args[3]='' or $strfind($run_array[args['pos']],$args[3])<>'':
			$args['gdo']='true'
			pl "&gt;<<$args[2]>>[arrsize('<<$args[2]>>')]=<<$id_array[args['pos']]>>"
			dynamic "<<$args[2]>>[arrsize('<<$args[2]>>')]=$id_array[args[0]]",args['pos']
		end
	end
	jump 'for'
end
args['log.finish']=msecscount
$error_log[]="<<MSECSCOUNT>> get.daughter.obj
	curloc:<<$curloc>> 
	parent:<<$args[0]>> 
	filtr:<<$args[1]>> 
	array:<<$args[2]>> 
	dynamic_script:<<$args[3]>>
	round:$<<$args[4]>>_array 
	result:<<$args['gdo']>> 
	arrsize:<<arrsize($args[2])>> 
	time:<<args['log.finish']-args['log.start']>>"
$result=$args['gdo']
--- get.daughter.obj ---------------------------------

# get.daughter.obj.all
! локация ищет все дочерние объекты и вложенные в них объекты.
! Если указать регулярное выражение будет произведён поиск лишь тех объектов, к которым применимо регулярное выражение
$args[0] = $args[0]	&	!	ID местоположения
$args[1] = $args[1]	&	!	фильтр объектов в виде регулярного выражения
$args[2] = $args[2]	&	!	имя массива, в который будут помещены ай-ди всех дочерних объектов
$args['gdoa']='false'
$args['level.0']=DYNEVAL("$args['dyneval']=$func('get.daughter.obj','<<$args[0]>>','<<$args[1]>>','<<$args[2]>>0')
$result=$args['dyneval']")
if $args['level.0']='true':
	args['i'] = 0
	:next
	args['u'] = 0
	:daughter
	$args["level.<<args['i']>>"]=DYNEVAL("$args['dyneval']=$func('get.daughter.obj',<<$args[2]>><<args['i']>>[<<args['u']>>],'<<$args[1]>>','<<$args[2]>><<args['i']+1>>')
$result=$args['dyneval']")
	args['u']+=1
	if args['u']<arrsize("<<$args[2]>><<args['i']>>"): jump 'daughter'
	args['i']+=1
	if arrsize("<<$args[2]>><<args['i']>>")>0: jump 'next'
end
args['r'] = 0
args['t'] = 0
:for
if args['r']<args['i']+1:
	args['n'] = 0
	:lu
	if args['n']<arrsize("<<$args[2]>><<args['r']>>"):
		DYNAMIC "<<$args[2]>>[<<args['t']>>]=<<$args[2]>><<args['r']>>[<<args['n']>>]"
		if args['t']=0: $args['gdoa']='true'
		args['n']+=1
		args['t']+=1
		jump 'lu'
	end
	killvar "<<$args[2]>><<args['r']>>"
	args['r']+=1
	jump 'for'
end
$result = $args['gdoa']
--- get.daughter.obj.all ---------------------------------

# get.similar.obj
! Функция получает позицию объекта, которому идентичен другой объект
! $args[0] - ай-ди исходного объекта
! $args[1] - ай-ди искомого местоположения. если пустое значение, ищет вообще по всем объектам в игре.
$args[0] = $args[0]
$args[1] = $args[1]
args['obj'] = arrpos('$id_array',$args[0])	&	!	получаем номер объекта в базе по его ай-ди
args['get.similar.obj']=-1	&	!	результат по умолчанию
args['pos']=-1	&	!	позиция исключаемая из поиска
:for
args['pos']=arrpos(args['pos']+1,'$object_array',$object_array[args['obj']])	&	!	находим позицию объекта идентичного исходному
if no args['pos']<0:
! Если позиция не -1
	if args['pos']=args['obj']: jump 'for'
	if $position_array[args['pos']]!$args[1] and $args[1]!'': jump 'for'	&	!	если родительский объект искомого объекта не соответствует исходному повторяем поиск
	if charge_array[args['pos']]!charge_array[args['obj']]: jump 'for'	&	!	если у объектов разные заряды, повторяем поиск
	$args['daughters']=$func('get.daughter.obj',$id_array[args['pos']],'','$id_temp')
	if $args['daughters']!'false': killvar '$id_temp' & jump 'for'
	if $respawn_array[args['pos']]!$respawn_array[args['obj']]:  jump 'for'	&	!	если у объектов разное время респаунинга, повторяем поиск
	if $run_array[args['pos']]!$run_array[args['obj']]:  jump 'for'	&	!	если у объектов различаются динамические коды
	args['get.similar.obj']=args['pos']
	result=args['get.similar.obj']
	exit
else
	result=args['get.similar.obj']
	exit
end
--- get.similar.obj ---------------------------------

# prv.str.inObj
! Функция проверяет объект на совпадение с искомой информацией
! Результатом является true или false
! $args[0] - ай-ди объекта
! $args[1] - регулярное выражение
$args[0] = $args[0]
$args[1] = $args[1]
args['pos']=arrpos('$id_array',$args[0])
if $strfind($object_array[args['pos']],$args[1])!'': $result='true' else $result='false'
--- prv.str.inObj ---------------------------------

# rpl.str.inObj.id
! Заменяет в объекте строку по ай-дишнику
! $args[0] - fq-дишник
! $args[1] - динамическая строка
! $args[2] - статическая строка замены
args['pos']=arrpos('$id_array',$args[0])
$args[1]=$strfind($object_array[args['pos']],$args[1])
$object_array[args['pos']]=$replace($object_array[args['pos']],$args[1],$args[2])
--- rpl.str.inObj.id ---------------------------------

# add.obj.nocount
! программа добавляет неисчислимый предмет в кошелёк
$args[0] = $args[0]	&	!	ай-ди объекта

$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.

$args['bag_in']=$func('get.bag',$args[0],'<money>')	&	!	находим подходящий кошелёк
if $args['bag_in']='INVENTORY':
! {ВНИМАНИЕ. необходимо создать внутреннюю базу oneself-объектов.}
	$args['bag_in']=$func('add.new.obj','<money> [name:Кошелёк:name] [color:888800] [:money:] [oneself]','INVENTORY','MONEY')
end
args['поднять_штук']=kolvo_array[args['pit']]
$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['поднять_штук'])
$args['add.obj.nocount']=$func('prv.obj.id',$args[0],$args['last_id'])
if $args['add.obj.nocount']!'dont take':
	$print['take.obj']+=$func('b.w.s','take.nocount',$args['obj'],args['поднять_штук'])
	if $strfind($run_array[args['pit']],'!nocount.take!')!'': $args['run_array']=$func('run.dynamic.script','!nocount.take!',$args['last_id'],$args[0])
else
	if $strfind($run_array[args['pit']],'!nocount.dont.take!')!'': $args['run_array']=$func('run.dynamic.script','!nocount.dont.take!',$args['last_id'],$args[0])
end
$result=$args['add.obj.nocount']
$infop['last_id.on.prv.obj.pay']=$args['last_id']
--- add.obj.nocount ---------------------------------

# get.bag
! локация находит для предмета наиболее подходящую сумку
$args[0] = $args[0]	&	!	ай-ди предмета
if $args[1]='': $args[1]='<bag>'	&	!	регулярное выражение, например класс объекта. по умолчанию производится поиск среди сумок
$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.
! -------------- алгоритм поиска подходящей сумки ------------------------------
	$args['res.021213']='INVENTORY'	&	!	по умолчанию все предметы помещаются в инвентарь, если не будет найдено иного подходящего контейнера.
	! ------------------ поиск сумки без целевого слова ------------------------
		args['arr']=-1
		:bag_non_target
		args['arr']=arrcomp(args['arr']+1,'$object_array','[\s\S]*'+$args[1]+'[\s\S]*')
		! Вычисляем первую попавшуюся сумку
		if no args['arr']<0:
			if $strfind($object_array[args['arr']],'\[:[^:]*]')!'':
			! Если содержит целевое слово, повторяем поиск
				jump 'bag_non_target'
			else
			! Если не содержит целевого слова - сумка подходящая
				$args['res.021213']=$id_array[args['arr']]
			end
		end
	! ------------------ поиск сумки без целевого слова ------------------------
	! ------------------ поиск сумки с подходящим целевым словом ---------------
		! Получаем список целевых слов
		$args['target_list']=$replace($replace($func('get.tag.cont',$args['obj'],'np'),'[','|'),']')
		$args['target_list']=$mid(TRIM($args['target_list']),2)+'| '
		args['tl']=1
		:bag_w_target
		$args['boob']=TRIM($func('get.word.inPos',$args['target_list'],args['tl']))
		! $args['print']+=$args['boob']+' <<args["tl"]>><br>'
		if $args['boob']!'':
			args['arr']=arrcomp('$object_array','[\s\S]*'+$args[1]+'[\s\S]*\[:'+$args['boob']+'\][\s\S]*|[\s\S]*\[:'+$args['boob']+'\][\s\S]*'+$args[1]+'[\s\S]*')
			if args['arr']=-1:
				args['tl']+=1
				jump 'bag_w_target'
			else
				$args['res.021213']=$id_array[args['arr']]
			end
		end
	! ------------------ поиск сумки с подходящим целевым словом ---------------
	! Как видно из последовательности действий, если небудет найдена искомая сумка, предмет будет добавлен в сумку выше по иерархии
! -------------- алгоритм поиска подходящей сумки ------------------------------
$result=$args['res.021213']
--- get.bag ---------------------------------

# minus.obj
! уменьшение количества предметов.
$args[0] = $args[0]	&	!	id-объекта.
args[1]	=	args[1]	&	!	сколько предметов надо удалить

args['pit']	=	arrpos('$id_array',$args[0])
kolvo_array[args['pit']]-=args[1]
if kolvo_array[args['pit']]<1:	gs 'del.obj',$args[0]
--- minus.obj ---------------------------------

# prv.obj.id
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	id итогового предмета
args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
if $args[1]=$args[0] or kolvo_array[args['pit']]=0: 
! Если ай-ди итогового предмета совпадает с исходным, значит предмет взят полностью
	$result='taken'
elseif $args[1]='':
! Если ай-ди итогового предмета равно пустому значению, значит предмет не взят
	$result='dont take'
else
! Если значение не пустое, но и не равно $args[0], значит предмет взят не полностью
	$result='[колво:'+str(kolvo_array[args['pit']])+']'
end
--- prv.obj.id ---------------------------------

# prv.obj.pay
! Локация вычисляет стоимость предметов и имеется ли требуемое количество денег
$args[0]= $args[0]	&	!	ай-ди предмета
args[1]	= args[1]	&	!	количество, которое покупаем или продаём
$args[2]= $args[2]	&	!	sale - продажа purchase - покупка

$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['stoim.nominal']=$func('get.tag.num',$args['obj'],'stoim')	&	!	получаем номинальную стоимость предмета
args['tid']=arrpos('$id_array',$func('get.loc.id'))	&	!	получаем позицию торговца в базе
$args['prv.obj.pay']='false'
args['did']=-1
if $func('get.daughter.obj','INVENTORY','<money>',"$temp_id_costbag")='true':
! Вычисляем позицию кошелька (пока кошелёк может быть только один. Теоретически больше и не нужно)
	$args['id_money']=$temp_id_costbag[]
	killvar '$temp_id_costbag'
	if $func('get.daughter.obj',$args['id_money'],'\[name:Дублоны:name\]',"$temp_id_costbag")='true':
	! Вычисляем позицию денег в кошельке (пока это только дублоны, позже можно сделать гораздо более гибкий выбор)
		$args['id_money']=$temp_id_costbag[]
		args['did']=arrpos('$id_array',$args['id_money'])
		killvar '$temp_id_costbag'
	elseif $args[2]='purchase':
	! Если дублонов в кошельке нет и совершается покупка товара, действие признаётся невозможным.
		$args['<money>']='no valute'
		jump 'нет денег'
	end
	killvar '$temp_id_costbag'
elseif $args[2]='purchase':
! Если кошелька нет, значит фактически не существует и денег
	$args['<money>']='no'
	! -------------------- "нет денег" --------------------
		:нет денег
		killvar '$temp_id_costbag'
		$print['take.money']+=$func('base.word.screen','014')
		$dvar[]=$func('b.d.s','noMoney',$id_array[args['tid']])
		if args['не хватает']>0:
			$print['take.money']+=' '+$func('base.word.screen','008.3',$object_array[args['did']]+'[колво:'+str(args['не хватает'])+']')
		end
		if $args['<money>']='no':
			$print['take.money']+='<br>'+$func('b.w.s','noMoneyBag')
		elseif $args['<money>']='no valute':
			$print['take.money']+='<br>'+$func('b.w.s','noValute')
		end
		$result=$args['prv.obj.pay']
		exit
	! -------------------- "нет денег" --------------------
end
if $args[2]='sale':
! Если товар продаётся, то стоимость на 20 % меньше номинальной
	args['stoim.exit']=func('obj.sale.cost',args['stoim.nominal'],$func('get.loc.id'))
	args['bank']=charge_array[args['tid']]	&	!	в банк помещаются деньги торговца
elseif $args[2]='purchase':
! Если товар покупается, то стоимость на 20 % больше номинальной
	args['stoim.exit']=func('obj.purc.cost',args['stoim.nominal'],$func('get.loc.id'))
	args['bank']=kolvo_array[args['did']]	&	!	в банк помещаются "деньги" из кошелька
end
! Теперь предстоит сравнить стоимость продаваемых предметов с деньгами в банке
! Для этого вычисляем общую стоимость предметов в целом количестве монет
args['stoim.coin']=val($func('#indiv#',args['stoim.exit']*args[1],100,1))
if args['stoim.coin']>args['bank']:
! Если общая стоимость предметов превышает количество денег в банке, покупка/продажа невозможны.
	if $args[2]='purchase':
		args['не хватает']=args['stoim.coin']-args['bank']
		jump 'нет денег'
	else
		$print['take.money']+=$func('base.word.screen','015')+' '
		$print['take.money']+=$func('base.word.screen','008.3',$object_array[args['did']]+'[колво:'+str(args['stoim.coin']-args['bank'])+']')
		$result=$args['prv.obj.pay']
		exit
	end
else
! Если общая стоимость предметов не превышает количество денег в банке
! Отнимаем из банка сумму и возвращаем true
	if $args[2]='sale':
	! ты продаёшь. при этом:
		charge_array[args['tid']]	-=	args['stoim.coin']	&	!	уменьшается количество денег у торговца
		if args['did']!-1:
			kolvo_array[args['did']]	+=	args['stoim.coin']	&	!	увеличивается количество денег у тебя
		else
			$args['f_b_id']=$func('base.new.obj','[:дублоны:]',"","SPACE",args['stoim.coin'])
			$args['prv.obj.pay']=$func('add.obj.nocount',$args['f_b_id'])
			args['did']=arrpos('$id_array',$infop['last_id.on.prv.obj.pay'])
			gosub 'kill.var.olegus','$infop','last_id.on.prv.obj.pay'
		end
		$print['take.money']+=$func('base.word.screen','008.1',$object_array[args['did']]+'[колво:'+str(args['stoim.coin'])+']')
	elseif $args[2]='purchase':
	! ты покупаешь. при этом:
		kolvo_array[args['did']]	-=	args['stoim.coin']	&	!	уменьшается количество денег у тебя
		charge_array[args['tid']]	+=	args['stoim.coin']	&	!	увеличивается количество денег у торговца
		$print['take.money']+=$func('base.word.screen','008.2',$object_array[args['did']]+'[колво:'+str(args['stoim.coin'])+']')
	end
	$args['prv.obj.pay']='true'
end
$result=$args['prv.obj.pay']
--- prv.obj.pay ---------------------------------

# prv.obj.weight
! функция проверяет возможно ли добавление в рюкзак или инвентарь
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	управляющая конструкция
$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.

args['колво']=kolvo_array[args['pit']]	&	!	количество предметов в позиции
args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	вес одного предмета

if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\s\S]*|seller;|торговец;)')!'':
	$args['поднять']='buy'
elseif $args[1]='inBag':
	$args['поднять']='inBag'
elseif $args[1]='inInv':
	$args['поднять']='inInv'
else
	$args['поднять']='place'
end
! Вычисляем, сколько предметов такого веса может поместиться в рюкзаке
if args['weight']!0: args['вместимость']=(property['hero.power.max']-property['hero.power.all'])/args['weight'] else args['вместимость']=2123456789
if args['колво']>5 and args['вместимость']>5:
! Проверяем количество поднимаемых предметов. Если оно больше пяти, спрашиваем, сколько хочешь поднять.
	! Если количество поднимаемых предметов больше вместимости рюкзака, количество предметов, которые можно поднять ограничивается вместимостью
	! В противном случае это количество ограничено количеством поднимаемых предметов
	if args['колво']>args['вместимость']: args['вместимость']=args['вместимость'] else args['вместимость']=args['колво']
	args['поднять_штук']=$input($func('b.d.t','hmayw',$args['поднять'],args['вместимость']))
	if isnum($args['поднять_штук'])=-1: args['поднять_штук']=val($args['поднять_штук']) else args['поднять_штук']=0
else
! Если количество поднимаемых предметов 5 или меньше, и рюкзак может вместить лишь пять или меньше предметов, предметы поднимаются поштучно.
	args['поднять_штук']=1
end
if args['поднять_штук']!0 and no args['поднять_штук']*args['weight']>property['hero.power.max']-property['hero.power.all'] and no args['поднять_штук']>args['вместимость']:
	result=args['поднять_штук']
else
	result=0
end
--- prv.obj.weight ---------------------------------

# prv.pos.inObj
! Функция проверяет, есть ли свободное "место на теле" для "предмета"
! если есть - заполняет массив $array_body_part[] айдишниками позиций и возвращает 'empty'
! если нет - возвращает "full"
$args[0] = $args[0]	&	!	id объекта "предмет"
$args['obj']=$func('get.obj.id',$args[0])	&	!	тело объекта "предмет"
$args['pos_list']=$func('get.tag.cont',$args['obj'],'pos')	&	!	список позиций
if $func('get.tag.cont',$args['pos_list'],'t1')!'': $args['l']='t'	&	!	тип позиции "рука" "перчатки"
if $func('get.tag.cont',$args['pos_list'],'c1')!'': $args['l']='c'	&	!	класс позиции "arm" "dosp"
if $func('get.tag.cont',$args['pos_list'],'p1')!'': $args['l']='p'	&	!	конкретная позиция "правая рука" "левая рука"
args['i']=1
:newpos
$args['position']=$func('get.tag.cont',$args['pos_list'],$args['l']+str(args['i']))
! получаем позицию из тега
if $args['position']!'':
	args['count']+=1
	args['pos']=-1
	:for
	args['pos']=arrcomp(args['pos']+1,'$object_array','[\s\S]*<body>[\s\S]*'+$args['position']+'[\s\S]*|[\s\S]*'+$args['position']+'[\s\S]*<body>[\s\S]*')
	if args['pos']!-1:
		if $include_array[args['pos']]!'': jump 'for'
		$array_body_part[arrsize('$array_body_part')]=$id_array[args['pos']]
		jump 'for'
	end
	$args['pos_list']=TRIM($replace($args['pos_list'],$args['l']+str(args['i'])+':'+$args['position']+':'+$args['l']+str(args['i'])))
end
args['i']+=1
if len($args['pos_list'])>0: jump 'newpos'
if arrsize('$array_body_part')<args['count']:
	$result='full'
	killvar '$array_body_part'
else
	$result='empty'
end
--- prv.pos.inObj ---------------------------------

# prv.onTarget
! Локация сравнивает списки типов
$args[0] = TRIM($args[0])	&	!	первый список
$args[1] = TRIM($args[1])	&	!	второй список
$args[2] = $args[2]	&	!	ключевое слово
$args['0'] = $args[1]
$args['1'] = $args[0]
$args['res'] = 'false'
args['u'] = 0
:for
if $args[args['u']]!'':
	args['progon']+=1
	$args['type'] = mid($args[args['u']],1,instr($args[args['u']],']'))
	if instr($args["<<args['u']>>"],$args['type'])!0:
		args['sovp']+=1
		if	$args[2]	=	'one':	$result	=	'true'	&	exit
	end
	$args[args['u']]=TRIM($replace($args[args['u']],$args['type']))
	jump 'for'
end
if args['u']=0:
	args['u'] = 1
	jump 'for'
end
if $args[2] = 'all':
	if args['sovp'] = args['progon']: $args['res'] = 'true'
end
$result = $args['res']
--- prv.onTarget ---------------------------------

# redo.obj.inCharge
! локация изменяет таблицы в соответсвии с изменениями зарядов предметов
$args[0]=$args[0]	&	!	ай-ди исходного предмета
$args[1]=$args[1]	&	!	id родительского предмета
args[2]=args[2]	&	!	значение изменяемого заряда
if $args[3]='' or $args[3]='down' or $args[3]='del' or $args[3]='-': $args[3]='-'
if $args[3]='up' or $args[3]='add' or $args[3]='+': $args[3]='+'	&	!	если не указано, заряд уменьшается
$args[4] = $args[4]	&	!	ай-ди патронташа
args[5] = args[5]	&	!	количество патронташей
	args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию в таблице
	args['pit.parent']=arrpos('$id_array',$args[1])	&	!	позиция родительского объекта в таблице
	$args['WORD']=$mid($args[0],1,instr($args[0],'.')-1)	&	!	получаем ключевое слово
	! перемещаем объект в несуществующее место
	if instr($object_array[args['pit.parent']],'<body>')=0:
		$args['id.newObj']=$func('replace.obj',$args[0],'charge_place',$args['WORD'],1)
	else
		$args['id.newObj']=$args[0]
	end
	! заряжаем в несуществующем месте
	if $args[4]!'':
		$args['patron']=$func('get.tag.cont',$object_array[arrpos('$id_array',$args[4])])
		$args['charge.new']=$func('replace.obj',$args[4],$args['id.newObj'],$args['patron'],args[5])
	end
	args['new.pit']=arrpos('$id_array',$args['id.newObj'])
	if $args[3]='-': charge_array[args['new.pit']]-=args[2]
	if $args[3]='+': charge_array[args['new.pit']]+=args[2]
	! перемещаем этот объект в контейнер родительского объекта
	if instr($object_array[args['pit.parent']],'<body>')=0:
		$args['replaced']=$func('replace.obj',$args['id.newObj'],$args[1],$args['WORD'],1)
	else
		$args['replaced']=$args[0]
	end
	$args['redo.obj.inCharge']=$args['replaced']
killvar '$result'
$result=$args['redo.obj.inCharge']
--- redo.obj.inCharge ---------------------------------

# replace.obj
! Перемещает часть предмета или весь предмет в указанную позицию
! Результатом является ай-ди перемещённого предмета
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	ай-ди объекта, который должен стать родительским
if $args[2]='': $args[2]=$mid($args[0],1,instr($args[0],'.')-1) else $args[2] = $args[2]	&	!	ключевое слово
args[3] = args[3]	&	!	количество перемещаемых предметов. Внимание!!! может быть равно 0
args[4] = args[4]
args['pos']=arrpos('$id_array',$args[0])
! позиция в базе
args['kolvo']=kolvo_array[args['pos']]
! количество предметов в позиции
if args['kolvo']<args[3]: args[3]=args['kolvo']
! Если в позиции меньше предметов, чем хочется переместить, Количество перемещаемых предметов приравнивается количеству предметов в позиции
args['posin']=func('get.similar.obj',$args[0],$args[1])	&	!	находит идентичный объект в указанном месте
if args['kolvo']>args[3]:
! переносится часть объекта
	if charge_array[args['pos']]>0: args['charge']=charge_array[args['pos']]
	if $run_array[args['pos']]!'': $args['runarray']=$run_array[args['pos']]
	if args[3]>0: args['колво']=args[3]
	if args['posin']=-1:
		$args['res.021213']=$func('add.new.obj',$object_array[args['pos']],$args[1],$args[2],args['колво'],args['charge'],$args['runarray'])
	else
		kolvo_array[args['posin']]+=args[3]
		$args['res.021213']=$id_array[args['posin']]
	end
	kolvo_array[args['pos']]-=args[3]
else
! переносится весь объект
	if args['posin']=-1:
		gs 'clr.parent.obj',$args[0]	&	!	удаляются все связи с родительскими объектами
		$position_array[args['pos']]=$args[1]
		$args['res.021213']=$args[0]
	else
		kolvo_array[args['posin']]+=args[3]
		$args['res.021213']=$id_array[args['posin']]
		gs 'del.obj',$args[0]
	end
end
$result=$args['res.021213']
! Результатом может быть:
! ай-ди нового объекта - если идентичного объекта в указанном месте нет и переносится часть объекта
! ай-ди идентичного объекта - если идентичный объект в указанном месте найден
! ай-ди исходного объекта - если идентичный объект не найден и переносится весь объект
--- replace.obj ---------------------------------

# take.obj
! локация поднимает предмет с текущего положения и добавляет его в инвентарь или рюкзак
$args[0] = $args[0]	&	!	ай-ди предмета
$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit'] = arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.
! выбираем текст подъёма, покупки
if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'':
	$args['take/buy']='[buy]'		&	!	покупается
else
	$args['take/buy']='[take]'	&	!	простой подъём
end
if instr($args['obj'],'[oneself]')!0:
	! здесь может быть проверка на наличие этого предмета.
	$object_array[args['pit']]=$replace($object_array[args['pit']],'<obj>','<'+$args['short_name']+'>')
	kolvo_array[args['pit']]=0
	gosub 'replace.obj',$args[0],'INVENTORY'
	$print['take.obj']+=$func('b.w.s',"take.oneself "+$args['take/buy'],$args['obj'])
elseif instr($args['obj'],'[nocount]')!0:
! Находим подходящий кошелёк. Динамический код при поднятии неисчислимого предмета выполняется с локации add.obj.noucount
	$args['res.take.obj']=$func('add.obj.nocount',$args[0])
elseif $strfind($args['obj'],'\[count\]|\[number\]')!'':
! Если предмет штучный, или меновой. Динамический код надевания предмета выполняется с локации use.obj.actObj
	if instr($args['obj'],'[count]')=0:
		$args['onBody']=$func('use.obj.actObj',$args[0])
	else
		$args['onBody']='dont take'
	end
	if $args['onBody']='dont money':
		$args['res.take.obj']='dont take'
		jump 'print'
	elseif $args['onBody']!'dont take':
		$args['res.take.obj']=$args['onBody']
		$print['take.obj']+=$func('b.w.s',"take.number "+$args['take/buy'],$args['obj']+'[колво:1]')
	else
	! Если предмет напрямую не одевается на тело, должна быть произведена проверка, можно ли добавить предмет в рюкзак или инвентарь
		! Проверяем правильно ли указано количество предметов, которое мы хотим поднять
		args['поднять_штук']=func('prv.obj.weight',$args[0])
		if args['поднять_штук']!0:
		! Количество предметов, которые мы собираемся поднять, не выходит за указанные пределы
			if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'':
				$args['pay']=$func('prv.obj.pay',$args[0],args['поднять_штук'],'purchase')
				if $args['pay']='true': $infop['pay']='true' else jump 'print'
			end
			args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	вес одного предмета
			$args['bag_in']=$func('get.bag',$args[0])
			! Перемещаем предмет в полученную позицию
			$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['поднять_штук'])
			$args['res.take.obj']=$func('prv.obj.id',$args[0],$args['last_id'])
			property['hero.power.all']+=args['поднять_штук']*args['weight']
			$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
			$print['take.obj']+=$func('b.w.s',"take.count "+$args['take/buy'],$args['obj']+'[колво:'+str(args['поднять_штук'])+']')
			args['pos_lid']=arrpos('$id_array',$args['last_id'])
			$infop['last_id']=$args['last_id']
			$infop['past_id']=$args[0]
			$infop['taked']='true'
			if $strfind($run_array[args['pos_lid']],'!inbag!')!'':
			! динамический код помещения при помещении в сумку/инвентарь
				$args['run_array.used']=$func('run.dynamic.script','!inbag!',$args['last_id'],$args[0])
			end
		else
		! Количество предметов, которое мы собираемся поднять, не входит в указанные пределы, либо невозможно поднять ни одного предмета
			$args['res.take.obj']='dont take'
			$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
			$print['take.obj']+=$func('base.word.screen','001')
		end 
	end
end
! $args['bag'] = $func('get.id.obj','<bag>')	&	!	получаем ай-ди сумки
! $position_array[args['pit']]=$args['bag']	&	!	помещаем объект в указанную позицию
! ----------------------------------------------- вывод на печать --------------------------------------------------
	:print
	if $run_array[arrpos('$id_array',$infop['last_id'])]!'':
	! динамический код при покупке, неважно на тело или в сумку
		args['pos_lid']=arrpos('$id_array',$infop['last_id'])
		if $infop['pay']='true' and $strfind($run_array[args['pos_lid']],'!purc!')!'': $args['run_array.purc']=$func('run.dynamic.script','!purc!',$infop['last_id'],$infop['past_id'])
	! динамический код при взятии, неважно на тело или в сумку
		if $infop['taked']='true' and $strfind($run_array[args['pos_lid']],'!taked!')!'': $args['run_array.take']=$func('run.dynamic.script','!taked!',$infop['last_id'],$infop['past_id'])
	end
	$result=$args['res.take.obj']
	gosub 'kill.var.olegus','$infop','pay','taked','last_id','past_id'
	killvar '$array_body_part_obj'
	killvar '$array_body_part'
	gs 'int.inventory'
! ----------------------------------------------- вывод на печать --------------------------------------------------
--- take.obj ---------------------------------

# del.markers.obj
!Удаляет лишние метки на предметах при поднятии и пр
$args[0] = $args[0]	&	!	id предмета
$args[1] = $args[1]	&	!	управление
args['pit']=arrpos('$id_array',$args[0])
$log_error+='last_id^'+$args[0]
if $args[1]='take':
	$object_array[args['pit']]=$replace($object_array[args['pit']],'[on Altar]')
	$object_array[args['pit']]=$replace($object_array[args['pit']],'[lock-obj]')
end
--- del.markers.obj ---------------------------------

# use.obj.actObj
! функция осуществляет одевание предмета на тело, если есть такая возможность
! В результат выдаётся три варианта:
! dont take	- предмет не был взят
! taken		- предмет взят полностью, т.е. всё количество
! другое	- предмет взят не полностью, т.е. только некоторое количество
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	управляющее или сопроводительное слово dont.pay - по этому значению определяем, что не нужно проверять стоимость.
if args[2]=0: args[2]=1 else args[2] = args[2]	&	!	количество
$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit']=arrpos('$id_array',$args[0])	&	!	получаем позицию предмета в базе
$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.
$args['use.obj.actObj']='dont take'
$args['pos_list']=$func('get.tag.cont',$args['obj'],'pos')	&	!	вычисляем список позиций, в которые добавляется указанный предмет
$args['ppi']=$func('prv.pos.inObj',$args[0])
if $args['pos_list']!'' and $args['ppi']='empty':
! если предмет должен добавляться на тело и "части тела" свободны
	! есть список позиций и заполненный массив $array_body_part
	! Заполняем массив $array_body_part_obj объектами "части тела"
	args['i']=0
	:array_body_part
	if args['i']<arrsize('$array_body_part'):
		$array_body_part_obj[args['i']]=$func('get.obj.id',$array_body_part[args['i']])
		args['i']+=1
		jump 'array_body_part'
	end
	args['p']=1
	if $func('get.tag.cont',$args['pos_list'],'t1')!'': $args['l']='t'	&	!	тип позиции "рука" "перчатки"
	if $func('get.tag.cont',$args['pos_list'],'c1')!'': $args['l']='c'	&	!	класс позиции "arm" "dosp"
	if $func('get.tag.cont',$args['pos_list'],'p1')!'': $args['l']='p'	&	!	конкретная позиция "правая рука" "левая рука"
	:body_part
	if len($args['pos_list'])>0:
		$args['position']=$func('get.tag.cont',$args['pos_list'],$args['l']+str(args['p']))
		! получаем очередную позицию из списка
		if $args['position']!'':
		! если позиция не равна пустому значению, ищем её в массиве $array_body_part_obj
			args['exit_pos']=arrcomp('$array_body_part_obj','[\s\S]*'+$args['position']+'[\s\S]*')
			if args['exit_pos']!-1:
			! Если позиция в массиве найдена
				if $args['last_id']='':
				! Перемещаем предмет, в позицию "части тела". Заметьте! Один раз
					if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'' and $args[1]!'dont.pay':
						$args['pay']=$func('prv.obj.pay',$args[0],args[2],'purchase')
						if $args['pay']='false':
							$result='dont money'
							exit
						end
					end
					$args['last_id']=$func('replace.obj',$args[0],$array_body_part[args['exit_pos']],$args['short_name'],args[2])
					$args['use.obj.actObj']=$func('prv.obj.id',$args[0],$args['last_id'])
					args['pos_lid']=arrpos('$id_array',$args['last_id'])
					$infop['last_id']=$args['last_id']
					$infop['past_id']=$args[0]
					$infop['taked']='true'
					if $args['pay']='true': $infop['pay']='true'
					if $strfind($run_array[args['pos_lid']],'!used!')!'':
					! динамический код, выполняемый при использовании/одевании
						$args['run_array.used']=$func('run.dynamic.script','!used!',$args['last_id'],$args[0])
					end
				end
				$include_array[arrpos('$id_array',$array_body_part[args['exit_pos']])]=$args['last_id']
				$args['short_body_part']='[:'+$func('get.tag.cont',$array_body_part_obj[args['exit_pos']])+':]'
				$print['use.obj.actObj']+=$func('base.new.bodypart',$args['short_body_part'],'take.obj:'+$args['last_id']+':take.obj')
				! Придаём части тела дочерний объект
				
				! Удаляем "использованную" "часть тела"
				killvar '$array_body_part_obj',args['exit_pos']
				killvar '$array_body_part',args['exit_pos']
				! Вырезаем значение из позиционного листа
				$args['pos_list']=TRIM($replace($args['pos_list'],$args['l']+str(args['p'])+':'+$args['position']+':'+$args['l']+str(args['p'])))
			else
				$error_log+='<font size=+1 color=#ff0000><b>ВНИМАНИЕ!!! Произошла ошибка добавления предмета в "части тела" на локации use.obj.actObj Несоответствие начального и конечного списков позиций.</b></font>'
				exit
			end
		end
		! Независимо от того была ли нужная нам "часть тела" или пустое значение
		args['p']+=1
		jump 'body_part'
	end
end
$result=$args['use.obj.actObj']
--- use.obj.actObj ---------------------------------

# obj.sale.cost
! Функция вычисляет полную стоимость при продаже
args[0] = args[0]	&	!	номинальная стоимость
$args[1] = $args[1]	&	!	id торговца

args['tid']=arrpos('$id_array',$args[1])
args['margin']=func('get.tag.num',$object_array[args['tid']],'margin')	&	!	индивидуальная наценка торговца в процентах
result=args[0]+(args[0]*(args['margin']-20))/100
--- obj.sale.cost ---------------------------------

# obj.purc.cost
! Функция вычисляет полную стоимость при покупке
args[0] = args[0]	&	!	номинальная стоимость
$args[1] = $args[1]	&	!	id торговца

args['tid']=arrpos('$id_array',$args[1])
args['discount']=func('get.tag.num',$object_array[args['tid']],'discount')	&	!	индивидуальная скидка торговца в процентах
result=args[0]+(args[0]*(20-args['discount']))/100
--- obj.purc.cost ---------------------------------

# menu.obj.put
! локация сбрасывает предмет на локации или в сундуке
if $args[0]='': $args[0]=$OOS['oid']
args[1] = args[1]	&	!	задаётся количество сбрасываемых предметов. Внимательно!
$args[2] = $args[2]	&	!	управление
$args['obj'] = $func('get.obj.id',$args[0])	&	!	получаем тело предмета
if $strfind($args['obj'],'\[quest\]')='':
	args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	вес одного предмета
	$args['short_name']=$func('get.tag.cont',$args['obj'])	&	!	короткое имя предмета, ай-ди вида.
	$args['inPut']=$func('get.loc.id')	&	!	получаем айди места, в которое собираемся переместить предмет (id текущей локации)
	$args['loc.targets']=TRIM($func('get.tag.cont',$object_array[arrpos('$id_array',$args['inPut'])],'target'))
	$args['obj.targets']=$func('get.tag.cont',$args['obj'],'np')
	$args['target']=$func('prv.onTarget',$args['loc.targets'],$args['obj.targets'],'one')
	if $args['target'] = 'false' and $args['loc.targets']!'':
		! невозможно сбросить предмет сюда
		$print['take.obj']+=$func('b.w.s','nih','loc')
		jump 'print'
	end
	args['pos']=arrpos('$id_array',$args[0])	&	!	вычислем позицию предмета в базе
	args['bag']=arrpos('$id_array',$position_array[args['pos']])	&	!	вычисляем позицию сумки в базе
	! перемещаем предмет. Если предметов меньше шести, то по-одному. Если больше шести, то спрашиваем, сколько хочешь переместить.
	if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'':
		$args['выбросить']='продать'
		$args['#']='011.2'
	else
		$args['выбросить']='выбросить'
		$args['#']='011.1'
	end
	if args[1]>0:
		args['переместить_штук']=args[1]
	elseif kolvo_array[args['pos']]>5:
		args['переместить_штук']=$input($func('b.d.t','hmayw',$args['выбросить'],kolvo_array[args['pos']]))
	else
		args['переместить_штук']=1
	end
	if args['переместить_штук']<1 or args['переместить_штук']>kolvo_array[args['pos']]:
		$print['take.obj']+=$func('base.word.screen','013')
	else
		if $strfind($func('get.loc.id'),'(\[т:[\d]+\]_[\S\s]+|торговец;|seller;)')!'':
			! Если происходит торговля
			$args['pay']=$func('prv.obj.pay',$args[0],args['переместить_штук'],'sale')
			if $args['pay']='false': jump 'print'
		end
		$args['last_id']=$func('replace.obj',$args[0],$args['inPut'],$args['short_name'],args['переместить_штук'])
		$args['menu.obj.put']=$func('prv.obj.id',$args[0],$args['last_id'])
		if $strfind($object_array[args['bag']],'<bag>|<inventory>')!'':
			! предмет выложен из рюкзака
			property['hero.power.all']-=args['переместить_штук']*args['weight']
			$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
			$args['put.from']='bag'
		else
			! предмет выложен из части тела
			$args['short_body_part']='[:'+$func('get.tag.cont',$object_array[args['bag']])+':]'
			$args['put.from']='body'
			$print['take.obj']+=$func('base.new.bodypart',$args['short_body_part'],'put.obj:'+$args['last_id']+':put.obj')
		end
		$print['use.obj.actObj']+=$func('base.word.screen',$args['#'],$args['obj']+'[колво:'+str(args['переместить_штук'])+']')
		args['pos_lid']=arrpos('$id_array',$args['last_id'])
		if $run_array[args['pos_lid']]!'':
			if $strfind($run_array[args['pos_lid']],'!passed!')!'':
				$args['run_array']=$func('run.dynamic.script','!passed!',$args['last_id'],$args[0])
			end
			if $args['pay']='true' and $strfind($run_array[args['pos_lid']],'!sale!')!'':
				$args['run_array.purc']=$func('run.dynamic.script','!sale!',$args['last_id'],$args[0])
			end
			if $args['put.from']='body' and $strfind($run_array[args['pos_lid']],'!deused!')!'':
				$args['run_array.purc']=$func('run.dynamic.script','!deused!',$args['last_id'],$args[0])
			elseif $args['put.from']='bag' and $strfind($run_array[args['pos_lid']],'!outbag!')!'':
				$args['run_array.purc']=$func('run.dynamic.script','!outbag!',$args['last_id'],$args[0])
			end
		end
	end
else
	$print['take.obj']+=$func('base.word.screen','010')
end
:print
if $strfind($args[2],'no GOTO')='':
	$result=$args['menu.obj.put']
	gs 'int.inventory'
	gs 'true.goto.curloc',$curloc
else
	$result=$args['last_id']
end
--- menu.obj.put ---------------------------------

# menu.obj.eat
! локация съедания предмета
if $args[0]='': $args[0]=$OOS['oid']
! Выполняем инструкцию
args['pit']=arrpos('$id_array',$args[0])
if $strfind($run_array[args['pit']],'!eat!')!'': $args['func']=$func('run.dynamic.script','!eat!',$args[0])
gs 'minus.obj',$args[0],1
gs 'int.inventory'
--- menu.obj.eat ---------------------------------

# menu.obj.disCharge
! выгружает из оружия все заряды
if $args[0]='': $args[0]=$OOS['oid']
args['pit']=arrpos('$id_array',$args[0])
! действует следующим образом:
! 1. Получаем список дочерних объектов
$args['daughter']=$func('get.daughter.obj',$args[0],'','$id_modc')
! вычисляем рюкзак
:hander_hoch
if arrsize('$id_modc')>0:
! каждый дочерний предмет просто перемещается в рюкзак
	$args['bag_in']=$func('get.bag',$id_modc[0])
	args['pit.p']=arrpos('$id_array',$id_modc[0])
	args['-weight']+=func('get.tag.num',$object_array[args['pit.p']],'weight')*kolvo_array[args['pit.p']]
	args['k']=kolvo_array[args['pit.p']]
	$args['replaced']=$func('replace.obj',$id_modc[0],$args['bag_in'],'',kolvo_array[args['pit.p']],1)
	$args['np.obj']=$object_array[arrpos('$id_array',$args['replaced'])]
	$args['text']+='<font color=#'+$func('get.tag.num',$args['np.obj'],'color')+'>'+$func('get.word.padez',$func('get.tag.cont',$args['np.obj'],'name'),'И')+" (<<args['k']>> шт.)</font>, "
! Уменьшается вес оружия !
	killvar '$id_modc',0
	jump 'hander_hoch'
end
! заряд оружия очищается
charge_array[args['pit']]=0
! уменьшаем вес
args['weight']=func('get.tag.num',$object_array[args['pit']],'weight')
$object_array[args['pit']]=$replace($object_array[args['pit']],"[weight:<<args['weight']>>]","[weight:"+str(args['weight']-args['-weight'])+"]")
$print['menu.else']+=$func('b.w.s','dch',$args[0],$args['text'],$args['bag_in'])
--- menu.obj.disCharge ---------------------------------

# menu.obj.inCharge
! локация зарядки ружья. Выполняет сдвоенную функцию:
! выбирает списком все ружья, которые есть у героя и предлагает их в виде ссылок
! если обращение происходит от ссылки, помещает заряд в ружьё, если это возможно
if $args[0]='': $args[0]=$OOS['oid']
$args[1] = $args[1]
args['pit.patron']=arrpos('$id_array',$args[0])
! получаем название патронов
$args['name.patron']=$func('get.tag.cont',$object_array[args['pit.patron']],"name")
$args['patron']=$func('get.tag.cont',$object_array[args['pit.patron']])
args['weight.patron']=func('get.tag.num',$object_array[args['pit.patron']],'weight')
! получаем калибр и прочую информацию
$args['calibr.patron']=$func('get.tag.num',$object_array[args['pit.patron']],'calibr')
args['maxCharge.patron']=func('get.tag.num',$object_array[args['pit.patron']],'maxchrg')
if $args[1]='':
! находим все объекты
	$args['get.arms']=$func('get.daughter.obj.all','INVENTORY','','$id_moic')
	if $args['get.arms']='true':
		:Game_Adventures_Making
		if arrsize('$id_moic')>0:
				args['pit.arm']=arrpos('$id_array',$id_moic[0])
				$args['arm']=$object_array[args['pit.arm']]
			if $strfind($args['arm'],'<obj>[\s\S]*\[огнестрельное\]')!"":
				$args['calibr.arm']=$func('get.tag.num',$args['arm'],'calibr')
				args['maxCharge.arm']=func('get.tag.num',$args['arm'],'maxchrg')
				if $args['calibr.arm']=$args['calibr.patron'] and args['maxCharge.patron']<=args['maxCharge.arm']-charge_array[args['pit.arm']]:
					$args['name.arm']=$func('get.word.padez',$func('get.tag.cont',$args['arm'],"name"),'В')
					$args['res.021213']='true'
					args['u']+=1
					!начало генерации ссылки для вывода на экран:
					$print['menu.else']+="[<<args['u']>>]: "	&	!	просто номер надписи по порядку
					! проверяем родительский объект на наличие слова <body>
					if instr($object_array[arrpos('$id_array',$position_array[args['pit.arm']])],'<body>')!0: $args['menu.else']="*" else $args['menu.else']=""
					$print['menu.else']+='<a class="plain" href="exec:'+"gosub 'menu.obj.inCharge','"+$args[0]+"','"+$id_moic[0]+"'"+'">Зарядить '	&	!	начало ссылки
					$print['menu.else']+=$func('get.word.padez',$args['name.patron'],'В')+" в "+$args['name.arm']+$args['menu.else']+" [<<charge_array[args['pit.arm']]>>/<<args['maxCharge.arm']>>]"	&	!	конец ссылки
					$print['menu.else']+=".</a><br>"
					! конец генерации ссылки для вывода на экран:
				end
			end
			killvar '$id_moic',0
			jump 'Game_Adventures_Making'
		end
	end
	if $args['res.021213']!'true': $print['menu.else']+=$func('base.word.screen','003.1') else $print['menu.else']+=$func('b.w.s','u')
else
	args['pit.arm']=arrpos('$id_array',$args[1])
	$args['arm']=$object_array[args['pit.arm']]
	$args['calibr.arm']=$func('get.tag.num',$args['arm'],'calibr')
	args['maxCharge.arm']=func('get.tag.num',$args['arm'],'maxchrg')
	$args['name.arm']=$func('get.word.padez',$func('get.tag.cont',$args['arm'],"name"),'В')
	! помещаем патронташ в пистолет
	args['штук']=charge_array[args['pit.patron']]/args['maxCharge.patron']	&	!	всегда должно быть равно 1
	$args['new.arm.charge']=$func('redo.obj.inCharge',$args[1],$position_array[args['pit.arm']],charge_array[args['pit.patron']],'+',$args[0],args['штук'])
	! в последнюю переменную внесен ай-ди оружия, которое получилось в результате. Этому оружию передаётся вес патронов
	args['pit.arm']=arrpos('$id_array',$args['new.arm.charge'])
	$args['arm']=$object_array[args['pit.arm']]
	args['weight.arm']=func('get.tag.num',$args['arm'],'weight')
	$object_array[args['pit.arm']]=$replace($object_array[args['pit.arm']],"[weight:<<args['weight.arm']>>]","[weight:<<args['weight.arm']+args['weight.patron']*args['штук']>>]")
	$print['menu.else']+='<font color=#008888><b>'+$func('get.word.padez',$args['name.patron'],'В')+" заряжены в "+$args['name.arm']+'.</b></font>'
	gs 'int.inventory'
	pl $func('print.word')
end
killvar '$id_moic'
--- menu.obj.inCharge ---------------------------------

# menu.obj.property
! Выводит свойства объекта.
! используется переменная $OOS['obj']
if $args[0]='': $args[0]=$OOS['oid']
$print['obj.property']=$func('int.obj.property',$args[0])
args['pit']=arrpos('$id_array',$args[0])
if $strfind($run_array[args['pit']],'!obj.property!')!'': $args['func']=$func('run.dynamic.script','!obj.property!',$args[0])
--- menu.obj.property ---------------------------------

# menu.obj.read
$args[0] = $OOS['oid']
args['pit']=arrpos('$id_array',$args[0])
$args['obj']=$object_array[args['pit']]
$args['book']=$func('get.tag.cont',$args['obj'])
if instr($args['obj'],'<spell>')!0 and книга_прочитана[$args['book']]=0:
	$print['read.book']+='Ты не знаешь, как действует это заклинание.'
	$args['ras']='!book.cant.read!'
	jump 'end_keep'
end
if $light_array[$func('get.loc.id')]='темно' and instr($args['obj'],'<spell>')=0:
	$print['read.book']+='Нельзя читать книги в полной темноте.'
	$args['ras']='!book.cant.read!'
else
	$print['read.book']+=$func('base.new.obj',$args['obj'],'book')
	if книга_прочитана[$args['book']]=0: книга_прочитана[$args['book']]+=1
	if это_прочитано[$args[0]]=0: это_прочитано[$args[0]]+=1
	$args['ras']='!book.read!'
end
:end_keep
if $run_array[args['pit']]!'': $args['func']=$func('run.dynamic.script',$args['ras'],$args[0])
--- menu.obj.read ---------------------------------

# menu.obj.unmount
! локация разбирает предмет на составляющие части
! Фактически: получает список составляющих по предмету, создаёт на их основе новые предметы
if $args[0] = '': $args[0]=$OOS['oid']
$args['obj']= $func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['pit']	= arrpos('$id_array',$args[0])
$args['short_word']=$func('get.tag.cont',$args['obj'])
args['weight']=func('get.tag.num',$args['obj'],'weight')
$args['unmount.list']=$func('base.new.obj','[:'+$args['short_word']+':]','unmount')
if $args['unmount.list']='cant unmount':
	if $strfind($run_array[args['pit']],'!cant.unmount!')!'': $args['flop']=$func('run.dynamic.script','!cant.unmount!',$args[0]) else $args['flop']='cant unmount'
	if $args['flop']='cant unmount':
		$print['obj.unmount']+=$func('base.word.screen','023')
		jump 'print'
	end
end
if kolvo_array[args['pit']]>5:
	args['unmount.iner']=$input($func('b.d.t','rebuild',kolvo_array[args['pit']]))
else
	args['unmount.iner']=1
end
if args['unmount.iner']>0 and no args['unmount.iner']>kolvo_array[args['pit']]:
	args['i']=1
	:for
	if strfind($args['unmount.list'],"\[[\d]+:[\s\S]*:[\d]+\]")!'':
		$args['str']=$replace($replace($strfind($args['unmount.list'],"\[<<args['i']>>:[\s\S]+:<<args['i']>>\]"),"[<<args['i']>>:"),":<<args['i']>>]")
		$args['unmount.name']=$func('get.tag.cont',$args['str'],'name')
		args['unmount.weight']=func('get.tag.num',$args['str'],'count')
		$args['ingredients.id']=$func('base.new.obj','[:'+$args['unmount.name']+':]','','INVENTORY',args['unmount.iner']*args['unmount.weight'])
		$args['last_id']=$func('replace.obj',$args['ingredients.id'],$cvar['loc_id'+$cvar['chest']],$args['short_word'],args['unmount.iner']*args['unmount.weight'])
		$args['unmount.list']=TRIM($replace($args['unmount.list'],"[<<args['i']>>:"+$args['str']+":<<args['i']>>]"))
		args['i']+=1
		jump 'for'
	end
	$print['obj.unmount']+=$func('base.word.screen','024',$args['obj']+' [колво:'+str(args['unmount.iner'])+']')
	gs 'minus.obj',$args[0],args['unmount.iner']
	property['hero.power.all']-=args['unmount.iner']*args['weight']
	$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
else
	$print['obj.unmount']+=$func('base.word.screen','022')
end
:print
gs 'int.inventory'
gs 'true.goto.curloc',$curloc
--- menu.obj.unmount ---------------------------------

# menu.in.bag
! Локация убирает предмет в наиболее подходящую сумку в инвентаре
if $args[0]='': $args[0]=$OOS['oid']
args['pos']=arrpos('$id_array',$args[0]) 	&	!	получаем позицию предмета в базе
$args['obj']=$func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	получаем вес предмета
args['kolvo']=kolvo_array[args['pos']]	&	! запоминаем текущее количество
$args['short_name']=$func('get.tag.cont',$args['obj'])
$args['bag_in']=$func('get.bag',$args[0])
! Необходимо проверить из какого места перемещается предмет, т.е. проверяем класс родительского объекта <body> или <inventory>
$args['parent']=$func('get.obj.id',$position_array[args['pos']]) 	&	!	получаем тело родительского объекта
if instr($args['parent'],'<inventory>')!0:
	args['w']=0
	$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['kolvo'])
	$print['menu.in.bag']+=$func('base.word.screen','006',$args['obj']+'[колво:'+str(args['kolvo'])+']')
elseif instr($args['parent'],'<body>')!0:
	args['поднять_штук']=func('prv.obj.weight',$args[0],'inBag')	&	!	получаем сколько можно отправить в сумку
	if args['поднять_штук']!0:
		$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['поднять_штук'])
		args['w']=args['поднять_штук']*args['weight']
		args['pit']=arrpos('$id_array',$args['last_id'])
		if $run_array[args['pit']]!'':
			if $strfind($run_array[args['pos_lid']],'!deused!')!'':	$args['func']=$func('run.dynamic.script','!deused!',$args['last_id'],$args[0])
			if $strfind($run_array[args['pos_lid']],'!inbag!')!'':	$args['func']=$func('run.dynamic.script','!inbag!',$args['last_id'],$args[0])
		end
		$print['menu.in.bag']+=$func('base.word.screen','004',$args['obj']+'[колво:'+str(args['поднять_штук'])+']')
	else
		$print['menu.in.bag']+=$func('base.word.screen','005')
	end
end
property['hero.power.all']+=args['w']
$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
gs 'int.inventory'
--- menu.in.bag ---------------------------------

# menu.in.inventory
! локация убирает предмет в инвентарь.
if $args[0]='': $args[0]=$OOS['oid']
args['pos']=arrpos('$id_array',$args[0]) 	&	!	получаем позицию предмета в базе
$args['obj']=$func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	получаем вес предмета
args['kolvo']=kolvo_array[args['pos']]	&	! запоминаем текущее количество
$args['short_name']=$func('get.tag.cont',$args['obj'])
$args['bag_in']='INVENTORY'
! Необходимо проверить из какого места перемещается предмет, т.е. проверяем класс родительского объекта <body> или <inventory>
$args['parent']=$func('get.obj.id',$position_array[args['pos']]) 	&	!	получаем тело родительского объекта
if instr($args['parent'],'<bag>')!0:
	args['w']=0
	$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['kolvo'])
	$print['menu.in.bag']+=$func('base.word.screen','007',$args['obj']+'[колво:'+str(args['kolvo'])+']')
elseif instr($args['parent'],'<body>')!0:
	args['поднять_штук']=func('prv.obj.weight',$args[0],"inInv")	&	!	получаем сколько можно отправить в сумку
	if args['поднять_штук']!0:
		$args['last_id']=$func('replace.obj',$args[0],$args['bag_in'],$args['short_name'],args['поднять_штук'])
		args['w']=args['поднять_штук']*args['weight']
		args['pit']=arrpos('$id_array',$args['last_id'])
		if $run_array[args['pit']]!'':
			if $strfind($run_array[args['pos_lid']],'!deused!')!'':	$args['func']=$func('run.dynamic.script','!deused!',$args['last_id'],$args[0])
			if $strfind($run_array[args['pos_lid']],'!inbag!')!'':	$args['func']=$func('run.dynamic.script','!inbag!',$args['last_id'],$args[0])
		end
		$print['menu.in.bag']+=$func('base.word.screen','004.1',$args['obj']+'[колво:'+str(args['поднять_штук'])+']')
	else
		$print['menu.in.bag']+=$func('base.word.screen','005')
	end
end
property['hero.power.all']+=args['w']
$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
gs 'int.inventory'
--- menu.in.inventory ---------------------------------

# menu.in.body
! локация проверяет возможность поместить предмет в указанную позицию на теле и помещает его туда, если есть такая возможность.
if $args[0]='': $args[0]=$OOS['oid']
args['pos']=arrpos('$id_array',$args[0]) 	&	!	получаем позицию предмета в базе
$args['obj']=$func('get.obj.id',$args[0])	&	!	получаем тело предмета
args['weight']=func('get.tag.num',$args['obj'],'weight')	&	!	получаем вес предмета
args['kolvo']=kolvo_array[args['pos']]	&	! запоминаем текущее количество
if instr($args['obj'],'[number]')!0:
	args['штучек']=1
elseif  instr($args['obj'],'[count]')!0:
	args['штучек']=args['kolvo']
end
$args['use']=$func('use.obj.actObj',$args[0],'dont.pay',args['штучек'])	&	!	перемещаем объект если это возможно
if $args['use']='taken':
! Предмет взят полностью. Значит вес уменьшается на полное число
	args['w']=args['kolvo']*args['weight']
elseif $args['use']='dont take':
	args['w']=0
	$print['menu.in.body']=$func('base.word.screen','003')
	$args['pos_list']=$func('get.tag.cont',$args['obj'],'pos')
	$print['use.obj.actObj']=$func('b.w.s','full.pos',$args['pos_list'])
else
! предмет взят, но не полностью, значит возвращён остаток
	args['w']=args['weight']*(args['kolvo']-func('get.tag.num',$args['use'],'колво'))
end
property['hero.power.all']-=args['w']
$print['power.change']+=$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:power:\]'))
if $strfind($run_array[arrpos('$id_array',$infop['last_id'])],'!outbag!')!'':
	if $infop['taked']='true': $args['func']=$func('run.dynamic.script','!outbag!',$infop['last_id'],$infop['past_id'])
end
gs 'int.inventory'
--- menu.in.body ---------------------------------

# menu.obj.spell.teach

--- menu.obj.spell.teach ---------------------------------

# menu.obj.spell.read
! Функция реализует скрипт прочтения заклинания
! Всем заклинаниям передаются одинаковые наборы аргументов
if $args[0]='': $args[0] = $OOS['oid']
$args[1] = $func('get.loc.id')
$args['spell']='!spell.read!'
args['spell.pit']=arrpos('$id_array',$args[0])
$args['spell.obj']	=	$object_array[args['spell.pit']]
if $args[1] = '[chest]':
! невозможно прочесть заклинание, находясь в сундуке
	$print['menu.else'] += $func('base.word.screen','019.1')+$func('b.w.s','dont_spell.chest')
	$args['spell']='!spell.cant.read! chest'
else
	args['loc.pit']=arrpos('$id_array',$args[1])
	$args['loc.obj']=$object_array[args['loc.pit']]
	$args['place']=$func('get.tag.cont',$args['loc.obj'],'place')
	if instr($args['place'],'[молчание]')!0:
		$args['spell']='!spell.cant.read! silent'
		$print['menu.in.body'] += $func('base.word.screen','019.1')+$func('b.w.s','dont_spell.location')
	end
end

! здесь должна находиться проверка на возможность читать заклинание во время боя
!	пошаговый бой предполагает одно чтение заклинания за ход

$args['menergy.spell'] = $func('get.tag.cont',$args['spell.obj'],'menergy')
$args['magic.menergy.spell']=$func('magic.menergy.spell',$args[1],$args['menergy.spell'],'prove')
if $args['magic.menergy.spell']='false':
	args['mana']=func('get.tag.num',$args['spell.obj'],'mana')
	if args['mana']>property['hero.mana.all'] or instr($args['spell.obj'],'[mana:')=0:
		$args['magic.menergy.spell']='false'
		$args['spell']='!spell.cant.read! not energy'
		$print['menu.in.bag'] += $func('base.word.screen','019.1')+$func('b.w.s','dont_spell.magic')
	else
		$args['magic.menergy.spell']='mana'
	end
else
	$args['magic.menergy.spell']='menergy'
end
if $strfind($run_array[args['spell.pit']],$strfind($args['spell'],'![\s\S]+!'))!'': $args['spell']=$func('run.dynamic.script',$args['spell'],$args[0])
! В результате имеем два слова: "true" - удалось выполнить заклинание, или "false" - не удалось.
if $args['spell']='true':
	if instr($args['spell.obj'],'<obj>')!0:	gosub 'minus.obj',$args[0],1
	if $args['magic.menergy.spell'] = 'mana': gosub 'hero.mana',args['mana']
	if $args['magic.menergy.spell'] = 'menergy': gosub 'magic.menergy.spell',$args[1],$args['menergy.spell'],'spell'
end
gs 'int.inventory'
gs 'true.goto.curloc',$curloc
--- menu.obj.spell.read ---------------------------------

# int.menu.obj
! интерпретатор создаёт дополнительные пункты меню для предметов
! $args[0] - строка из которой извлекаются пункты
$args[0] = $args[0]
if $func ('get.tag.cont',$args[0],'menu')!'':
	$args['menu'] = $func ('get.tag.cont',$args[0],'menu')
	args['i'] = 1
	:menu
	if $func('get.tag.cont',$args['menu'],'m'+str(args['i']))!'':
		$menu_OOS[arrsize('$menu_OOS')] = $func('get.tag.cont',$args['menu'],'m'+str(args['i']))
		$args['menu']=TRIM($replace($args['menu'],'m'+str(args['i'])+':'+$menu_OOS[arrsize('$menu_OOS')]+':m'+str(args['i'])))
		args['i']+=1
		if len($args['menu'])>0: jump 'menu'
	end
	$menu_OOS[arrsize('$menu_OOS')] ='-:-'
end
--- int.menu.obj ---------------------------------

# get.key.inOpen
! Функция получает ай-ди ключа, которым можно открыть замок
! Объект ключа содержит следующие данные
! <key> [name:Название ключа:name] [key:короткое_имя:key] [open:5] [breake:1000]
! В переменной kolvo_array[] - может быть записано количество подобных ключей. Если оно равно нулю, ключ считается потерянным, его нужно удалить
! В переменной charge_array[] - при создании ключа было вписано значение из [open:5]. Если тег присутствует, а charge_array[]=0, ключ не используется
!поиск производится до тех пор, пока не будет просмотрен весь массив ключей.
! $args[0] - короткое слово
$args[0] = $args[0]
args['pos']=-1
:for
args['pos']=arrcomp(args['pos']+1,'$object_array','[\s\S]*<key>[\s\S]*')
if no args['pos']<0:
	if $func('prv.str.inObj',$position_array[args['pos']],'<keys>')='false':	jump 'for'
	if $func('get.tag.cont',$object_array[args['pos']],'key')=$args[0]:
		if kolvo_array[args['pos']]=0: gs 'del.obj',$id_array[args['pos']] & jump 'for'	&	! если ключ уже не существует, удаляем его
		if $func('get.tag.num',$object_array[args['pos']],'open')!0 and charge_array[args['pos']]=0: jump 'for'	&	! проверяем может ли ключ открывать двери
		! если ключ есть и он может открыть дверь - ай-ди найден.
		$result = $id_array[args['pos']]
		exit
	end
else
	exit
end
--- get.key.inOpen ---------------------------------

# get.key.inBreake
! Функция получает ай-ди наиболее подходящей отмычки.
args[0] = args[0]
args['pos']=-1
args['key']=0
:for
args['pos']=arrcomp(args['pos']+1,'$object_array','[\s\S]*<key>[\s\S]*\[breake:[\d]+\][\s\S]*')
if no args['pos']<0:
	if $func('prv.str.inObj',$position_array[args['pos']],'<keys>')='false':	jump 'for'
	if kolvo_array[args['pos']]=0: gs 'del.obj',$id_array[args['pos']] & jump 'for'	&	! если ключ уже не существует, удаляем его
	if $func('get.tag.num',$object_array[args['pos']],'open')!0 and charge_array[args['pos']]=0: jump 'for'	&	! проверяем может ли ключ открывать двери
	! если ключ есть и он может открывать двери, сверяется свойство
	args['breake-1']=func('get.tag.num',$object_array[args['pos-1']],'breake')
	args['breake']=func('get.tag.num',$object_array[args['pos']],'breake')
	if args['breake']!args[0]:
		if (args['breake']>args[0] and ((args['breake-1']<args[0]) or (func('#-#',args['breake-1'],args[0])>func('#-#',args['breake'],args[0])))) or  _
		((no args['breake-1']>args[0]) and (func('#-#',args['breake-1'],args[0])>func('#-#',args['breake'],args[0]))):
				$args['get.key.inBreake']=$id_array[args['pos']]
				args['pos-1']=args['pos']
		end
	else
		$args['get.key.inBreake'] = $id_array[args['pos']]
		$result = $args['get.key.inBreake']
		exit
	end
	jump 'for'
else
	$result = $args['get.key.inBreake']
	exit
end
--- get.key.inBreake ---------------------------------

# get.shell.inOpen
! Подпрограмма перебирает все предметы на наличие тегов [снаряд] и [дверь]
! Если теги есть, данные из [uron::uron] предмета и $args[0], отправляются программе get.similar.Uron,
! Которая сравнивает каждый тип урона с каждым типом урона и выстраивает список совпадающих типов урона.
! Если возвращённый результат не равен пустому значению, ай-ди снаряда записывается в $shell_iag
! $args[0] - список уронов
$args[0] = $args[0]
args['pos']=-1
:for
args['pos']=arrcomp(args['pos']+1,'$object_array','[\s\S]*\[снаряд метательный\][\s\S]*\[:дверь\][\s\S]*|[\s\S]*\[:дверь\][\s\S]*\[снаряд метательный\][\s\S]*')	&	! находим в массиве позицию элемента содержащего сочетание тегов
if no args['pos']<0:
	if $func('prv.str.inObj',$position_array[args['pos']],'<bag>|<inventory>')='false':	jump 'for'	&	! если предмет не лежит ни в сумке ни в инвентаре, ищем новый
	if $args[0]='' or ($args[0]!'' and $func('get.similar.Uron',$args[0],$func('get.tag.cont',$object_array[args['pos']],'uron'))!''):
	! если урон можно нанести любыми видами атак или конкретным и он присутствует в списке оружия
		$shell_iag[arrsize('$shell_iag')]=$id_array[args['pos']]
	end
	jump 'for'
else
	exit
end
--- get.shell.inOpen ---------------------------------

# get.arm.inOpen
! Подпрограмма сравнивает все предметы в руках с возможными уронами.
! Если нужное сочетание найдено, оружие вписывается в $arm_iag
! $args[0] - список уронов
$args[0] = $args[0]
args['pos']=-1
:for
args['pos']=arrcomp(args['pos']+1,'$object_array','[\s\S]*<body>[\s\S]*\[c:arm:c\][\s\S]*')	&	! находим в массиве позицию элемента "часть тела, предназначенная для оружия"
if no args['pos']<0:
	if $func('prv.str.inObj',$include_array[args['pos']],'\[type:оружие:type\]')='false':	jump 'for'
	if $args[0]='' or ($args[0]!'' and $func('get.similar.Uron',$args[0],$func('get.tag.cont',$include_array[args['pos']],'uron'))!''):
	! если урон можно нанести любыми видами атак, или конкретным и он присутствует в списке оружия
		if arrpos('$arm_iag',$include_array[args['pos']])!-1: $arm_iag[arrsize('$arm_iag')]=$include_array[args['pos']]
		! если такого предмета ещё нет в базе предметов, наносящих урон
	end
	jump 'for'
else
	exit
end
--- get.arm.inOpen ---------------------------------

# use.shell.inDoor

--- use.shell.inDoor ---------------------------------

# use.arm.inDoor

--- use.arm.inDoor ---------------------------------

# true.goto.curloc
if $args[0] = '[chest]' or ($cvar['loc_id'+$cvar['chest']]!'' and $strfind($args[0],'(\[м:[\d]+\]_[\s\S]+|место;|place;)')!''):
	GOTO $args[0],$cvar['loc_id'+$cvar['chest']],$cvar['manage'+$cvar['chest']],$cvar['back'+$cvar['chest']]
else
	GOTO $args[0]
end
--- true.goto.curloc ---------------------------------

# use.key.inDoor
! Локация производит действие вскрытия двери с помощью ранее найденной отмычки
! Используются значения из переменных $key_iag и $int_act_goto[0]
! Чем больше уровень отмычки, мастерства, меньше уровень замка, чем выше удача (как максимальная, так и текущая) тем больше вероятность взлома.
! Взлом вероятен в любом случае, даже если удача на минимуме, а разница между уровнем отмычки и замком невероятная.
! провал взлома так же возможен в любом случае.
! Уменьшаем количество отмычек на 1
$key_iag = $key_iag
$int_act_goto[0] = $int_act_goto[0]
args['tek_luck']=property['hero.luck.all']	&	!	текущая удача
args['max_luck']=property['hero.luck.max']	&	!	максимальная удача
args['breaking']=property['hero.breaking']	&	!	уровень умения вскрывать замки
args['lock']=func('get.tag.num',$object_array[arrpos('$id_array',$int_act_goto[0])],'breake')	&	!	уровень замка
args['key']=func('get.tag.num',$object_array[arrpos('$id_array',$key_iag)],'breake')	&	!	уровень отмычки

args['abs_luck']=(rand(1,args['tek_luck'])*100/args['tek_luck'])-((args['max_luck']-args['tek_luck'])*100/args['max_luck'])
args['breake']=(args['lock']-(args['key']+args['breaking']/args['key']))*100/args['lock']
args['var']=rand(-args['abs_luck'],100)
if no args['var']<args['breake']:
	*pl 'Замок взломан'
	if instr($object_array[arrpos('$id_array',$int_act_goto[0])],'[locked]')=0:
		gs 'rpl.str.inObj.id',$int_act_goto[0],'\[key:[\s\S]+:key\]'
		gs 'rpl.str.inObj.id',$int_act_goto[0],'\[breake:[\d]+\]'
	end
else
	*pl 'Неудачная попытка'
end
--- use.key.inDoor ---------------------------------

# magic.menergy.spell
! работа с энергией пространства
$args[0] = $args[0]	&	! ай-ди локации
$args[1] = $args[1]	&	! характеристики заклинания
$args[2] = $args[2]	&	! управляющая конструкция
if $args[2]='respawn' or $args[2]='set':
	args['loc.it']=arrpos('$id_array',$args[0])
	$args['obj']=$object_array[args['loc.it']]
end
if $args[2]='respawn':
	if instr($args['obj'],'[menergy:')!0 and instr($args['obj'],'[menergy.stop]')=0:
	! ВНИМАНИЕ!!! РЕСПАВН МАГИЧЕСКОЙ ЭНЕРГИИ ПРОСТРАНСТВА ОСУЩЕСТВЛЯЕТСЯ ВСЕГДА, независимо от того находится ли локация в респаунере, или нет	
	! Респавн магической энергии происходит постоянно. Тут работает простая закономерность. Каждая энергия пространства имеет свой предел
	! этот предел делится на период спавна и вычисляется насколько он должен быть сейчас заполнен
		$args['respawn.loc']=$func('get.tag.cont',$args['obj'],'respawn')	&	!	получаем время респавна
		if $args['respawn.loc']='': $args['respawn.loc']='[day:1]'
		args['respawn.time']=$func('get.tag.num',$func('conv.time',$args['respawn.loc'],'minute'),'minute')	&	!	вычисляем период респавнинга в минутах
		args['time.last']=$func('get.tag.num',$func('conv.time',$kolvo_array[args['loc.it']],'minute'),'minute')
		args['time.new']=$func('get.tag.num',$func('conv.time',$time['new.all'],'minute'),'minute')
		$args['menergy']=$func('get.tag.cont',$args['obj'],'menergy')
	else
		$result='false' & exit
	end
end
if $args[2]='prove' or $args[2]='spell':
	if $args[1]='':
		$result='false'
		exit
	else
		$args['menergy']=$args[1]
	end
end
if $args[2]='set':
	$args['menergy']=$func('get.tag.cont',$args['obj'],'menergy')
	if $args['menergy']='': $result='flase' & exit
end
args['i']=1
:for
if $strfind($args['menergy'],"u[\d]+:[\s\S]+:u[\d]+")!'':
	$args['uron']=$func('get.tag.cont',$args['menergy'],"u<<args['i']>>")
	if $args['uron']!"":
		args['power']=func('get.tag.num',$args['menergy'],"p<<args['i']>>")
		if $args[2]='set':
			menergy[$args[0]+'/'+$args['uron']]=args['power']
		elseif $args[2]='respawn':
			if menergy[$args[0]+'/'+$args['uron']]<args['power']:
				menergy[$args[0]+'/'+$args['uron']]+=(args['time.new']-args['time.last'])*args['power']/args['respawn.time']
				if menergy[$args[0]+'/'+$args['uron']]>args['power']: menergy[$args[0]+'/'+$args['uron']]=args['power']
			end
		elseif $args[2]='prove':
			if menergy[$args[0]+'/'+$args['uron']]<args['power']: $result='false' & exit
		elseif $args[2]='spell':
			menergy[$args[0]+'/'+$args['uron']]-=args['power']
		end
		$args['menergy'] = $replace($args['menergy'],"u<<args['i']>>:"+$args['uron']+":u<<args['i']>>")
		$args['menergy'] = $replace($args['menergy'],"p<<args['i']>>:"+str(args['power']))
		$args['menergy'] = TRIM($args['menergy'])
	end
	args['i']+=1
	jump 'for'
end
$result = 'true'
--- magic.menergy.spell ---------------------------------

# magic.add.spell
! Функция позволяет добавить в игру заклинание, прописанное в базе предметов base.new.obj
$args[0] = $args[0]	&	!	короткое слово внутри тега [::]
if $args[1] = '': exit	&	!	место, куда помещается заклинание
$args['get.spell.body']=$replace($func('base.new.obj',$args[0],'get.obj'),'<obj>','<spell>')
$args['get.spell.body']=$replace($args['get.spell.body'],'[свиток]')
$args['get.spell.dyncode']=$func('base.new.obj',$args[0],'get.obj get.run_array')
$args['res.13122013']=$func('add.new.obj',$args['get.spell.body'],$args[1],'SPELL',0,0,$args['get.spell.dyncode'])
$result=$args['res.13122013']
--- magic.add.spell ---------------------------------

# get.uron.list
! функция формирует текст для вывода на экран по имеющимся уронам. VISUALISATION
$args[0] = $args[0]	&	!	ключевое слово
$args[1] = $args[1] 	&	!	список уронов
if $args[2] = '': $args[2]='ff0000' 	&	!	цвет, по умолчанию ярко-красный
args['i']=1
$args['res.021213']='<table align=left valign=top border=0 cellpadding=0 cellspacing=0 width=60%>'
:for_uron
$args['uron_i']=$func('get.tag.cont',$args[1],'u'+str(args['i']))
args['power_i']=func('get.tag.num',$args[1],'p'+str(args['i']))
if $args['uron_i']!'':
	if args['power_i']!0: $args['res.021213']+='<tr><td align=left><b>'+$func('base.word.uron',$args[0],$args['uron_i'])+':'+'</b></td><td align=left width=10%><font color=#'+$args[2]+'>'+$func('#indiv#',args['power_i'],100,10)+'</font></td></tr>'
	$args[1]=TRIM($replace($args[1],'u'+str(args['i'])+':'+$args['uron_i']+':'+'u'+str(args['i'])))
	$args[1]=TRIM($replace($args[1],'p'+str(args['i'])+':'+$args['uron_i']))
end
args['i']+=1
if len($args[1])>0 and args['i']<100: jump 'for_uron'
$args['res.021213']+='</table>'
$result=$args['res.021213']
--- get.uron.list ---------------------------------

# get.similar.Uron
! Локация сравнивает два набора характеристик
! ВАЖНО! Характеристики должны заключаться в теги u1: :u1 и т.д.
! $args[0] - первый набор
! $args[1] - второй набор
! В результате функция возвращает набор совпадающих характеристик
$args[0] = $args[0]
$args[1] = $args[1]
u_gsu=0
:while2
dynamic "
i_gsu=1
:while1
if $strfind($args[<<u_gsu>>],'u[\d]+:[\s\S]+:u[\d]+')!'':
	$gsu<<u_gsu>>[i_gsu]=$func('get.tag.cont',$args[<<u_gsu>>],'u'+str(i_gsu))
	$args[<<u_gsu>>]=$replace($args[<<u_gsu>>],'u'+str(i_gsu)+':'+$gsu<<u_gsu>>[i_gsu]+':u'+str(i_gsu))
	i_gsu+=1
	jump 'while1'
end",$args[0],$args[1]
u_gsu+=1
if u_gsu<2: jump 'while2'
i_gsu=0
u_gsu=1
:while3
if i_gsu<arrsize('$gsu0'):
	if $gsu0[i_gsu]!''and arrpos('$gsu1',$gsu0[i_gsu])!-1:
		$args['res.021213']+='u<<u_gsu>>:'+$gsu0[i_gsu]+':u<<u_gsu>> '
		u_gsu+=1
	end
	i_gsu+=1
	jump 'while3'
end
$result=$args['res.021213']
killvar '$gsu0'
killvar '$gsu1'
killvar 'i_gsu'
killvar 'u_gsu'
--- get.similar.Uron ---------------------------------

# sim.uron.onFull
! Локация сравнивает два набора характеристик
$args[0] = TRIM($args[0])	&	!	первый набор - основной
$args[1] = TRIM($args[1])	&	!	второй набор - проверочный
! Результат является верным, когда все характеристики из второго набора по параметрам превышают или равны характеристикам из первого
! наборы приходят в виде u1:djdj:u1 p1:1000 u2:mmd:u2 p2:100 и т.д.
args['i']=1
:надежда_твой_компас_земной
if $strfind($args[0],"u[\d]+:[\s\S]+:u[\d]+")!'':
! проверяем наличие в строке интересующей конструкции
	$args['uron.1']=$func('get.tag.cont',$args[0],"u<<args['i']>>")
	! вычисляем характеристику по текущему номеру
	if $args['uron.1']!"":
	! если характеристика присутствует в строке
		$args['uron.2']=$strfind($args[1],"u[\d]+:"+$args['uron.1']+":u[\d]+")
		!	получаем ту же характеристику из второй строки
		args['uron.2.p']=val($mid($args['uron.2'],2,instr($args['uron.2'],':')-2))
		! получаем номер характеристики из второй строки
		args['uron.2.p']=func('get.tag.num',$args[1],"p<<args['uron.2.p']>>")
		! получаем силу характеристики из второй строки, из первой:
		args['uron.1.p']=func('get.tag.num',$args[0],"p<<args['i']>>")
		if $args['uron.2']='' or args['uron.1.p']>args['uron.2.p']:
		! если характеристика с таким же значением отсутствует в строке, или сила характеристики из первой строки превышает силу характеристики из второй строки
			$result='false'
			! результат - ложь
			exit
		end
		! удаляем характеристику из первой строки
		$args[0] = $replace($args[0],"u<<args['i']>>:"+$args['uron.1']+":u<<args['i']>>")
		$args[0] = $replace($args[0],"p<<args['i']>>:"+str(args['uron.1.p']))
		$args[0]=TRIM($args[0])
	end
	args['i']+=1
	jump 'надежда_твой_компас_земной'
end
$result='true'
--- sim.uron.onFull ---------------------------------

# setScreen
if $args[0] = '': $args[0] = $setScreen	&	!	точный тип интерфейса: место, хранилище, торговец, алтарь, кузница, алхим_стол... diary.big, diary.small...
$args[1] = $args[1]	&	!	цветовые настройки: темно, чёрно-зелёный
! -------------------------------- Выставление настроек по-умолчанию -----------------------------------------
	if $GAME_INTERFACE['show.input']='':	$GAME_INTERFACE['show.input']='hide'
	if $GAME_INTERFACE['show.acts']='':		$GAME_INTERFACE['show.acts']='hide'
	if $GAME_INTERFACE['show.stat']='':		$GAME_INTERFACE['show.stat']='show'
	if $GAME_INTERFACE['maintxt']="":		$GAME_INTERFACE['maintxt']="vertical"
	if $GAME_INTERFACE['obj.image.stat']='':$GAME_INTERFACE['obj.image.stat']='hide'
	
! -------------------------------- Выставление настроек по-умолчанию -----------------------------------------

if $GAME_INTERFACE['show.input']='show':
	args['input']=1
elseif $GAME_INTERFACE['show.input']='hide':
	args['input']=0
end
if $GAME_INTERFACE['show.acts']='show':
	args['acts']=1
elseif $GAME_INTERFACE['show.acts']='hide':
	args['acts']=0
end
if $GAME_INTERFACE['show.stat']='show':
	args['stat']=1
else
	args['stat']=0
end
! выставляем настройки строки ввода
showinput args['input']
:место
! настройки экрана для локаций места
if $args[0]='место':
	if $args[1]='темно':
		fcolor = rgb (0,250,0)
		bcolor = rgb (0,0,0)
		lcolor = rgb (0,100,0)
		$GAME_INTERFACE['acts.color']='101010'
		$GAME_INTERFACE['stat.color']='000004'
	else
		fcolor = 0
		bcolor = rgb(224,224,224)
		lcolor = rgb (0,80,0)
		$GAME_INTERFACE['acts.color']='e0e0f0'
		$GAME_INTERFACE['stat.color']='dde0dd'
	end
	showacts args['acts']
	showstat args['stat']
end
:хранилище
! настройки экрана для хранилищ
if $args[0]='хранилище':
	
		fcolor = 0
		bcolor = rgb(224,224,224)
		lcolor = rgb (0,80,0)
		$GAME_INTERFACE['acts.color']='e0e0f0'
		$GAME_INTERFACE['stat.color']='dde0dd'
	
	showacts 0
	showstat args['stat']
end
:кузница
! настройки экрана для хранилищ
if $args[0]='кузница':
	
		fcolor = 0
		bcolor = rgb(224,224,224)
		lcolor = rgb (0,80,0)
		$GAME_INTERFACE['acts.color']='e0e0f0'
		$GAME_INTERFACE['stat.color']='dde0dd'
	
	showacts args['acts']
	showstat args['stat']
end

if $args[0]='black-green':
	fcolor = rgb (0,200,0)
	bcolor = rgb (0,0,0)
	lcolor = rgb (0,100,0)
	showacts 0	&	! скрываем действия
	showobjs 0	&	! скрываем вещи
	showstat 0	&	! скрываем дополнительное описание
	showinput args['input']
elseif $args[0]='reset':
	showacts 1
	showobjs 1
	showstat 1
	showinput 1
	fcolor = 0
	bcolor = 0
	lcolor = 0
elseif $args[0]='diary.big':
	showacts 0
	showobjs 0
	showstat 0
	showinput args['input']
	fcolor = 0
	bcolor = rgb (60,60,88)
	lcolor = rgb(0,100,100)
elseif $args[0]='diary.big1':
	showacts 0
	showobjs 0
	showstat 0
	showinput args['input']
	fcolor = 0
	bcolor = rgb (60,60,88)
	lcolor = rgb(0,100,100)
elseif $args[0]='diary.small':
	showacts 0
	showobjs 0
	showstat 0
	showinput args['input']
	fcolor = 0
	bcolor = rgb(224,224,224)
	lcolor = rgb(0,100,0)
elseif $args[0]='chest':
	showacts 0
	showobjs 1
	showstat args['stat']
	showinput args['input']
	$GAME_INTERFACE['acts.color']='e0e0f0'
	$GAME_INTERFACE['stat.color']='dde0dd'
	fcolor = 0
	bcolor = rgb(224,224,224)
	lcolor = rgb (0,80,0)
elseif $args[0]='smithing':
	showacts args['acts']
	showobjs 1
	showstat args['stat']
	showinput args['input']
	$GAME_INTERFACE['acts.color']='e0e0f0'
	$GAME_INTERFACE['stat.color']='dde0dd'
	fcolor = 0
	bcolor = rgb(224,224,224)
	lcolor = rgb (0,80,0)
else
	showacts args['acts']
	showobjs 1
	showstat args['stat']
	showinput args['input']
	$GAME_INTERFACE['acts.color']='e0e0f0'
	$GAME_INTERFACE['stat.color']='dde0dd'
	fcolor = 0
	bcolor = rgb(224,224,224)
	lcolor = rgb (0,80,0)
end
$setScreen = $args[0]
--- setScreen ---------------------------------

# print.word
clr
if $print['obj.property']!'':	$args['pl']+=$print['obj.property']+'<br>'
if $print['obj_in_pos']!'':		$args['pl']+=$print['obj_in_pos']+'<br>'
if $print['take.obj']!'':		$args['pl']+=$print['take.obj']+'<br>'
if $print['take.money']!'':		$args['pl']+=$print['take.money']+'<br>'
if $print['menu.in.body']!'':	$args['pl']+=$print['menu.in.body']+'<br>'
if $print['menu.in.bag']!'':	$args['pl']+=$print['menu.in.bag']+'<br>'
if $print['use.obj.actObj']!'':	$args['pl']+=$print['use.obj.actObj']+'<br>'
if $print['put.altar']!'':		$args['pl']+=$print['put.altar']+'<br>'
if $print['menu.else']!'':		$args['pl']+=$print['menu.else']+'<br>'
if $print['dynamic.script']!'':	$args['pl']+=$print['dynamic.script']+'<br>'
if $print['read.book']!'':		$args['pl']+=$print['read.book']+'<br>'
if $print['hero.health']!'':	$args['pl']+=$print['hero.health']+'<br>'
if $print['money']!'':			$args['pl']+=$print['money']+'<br>'
if $print['key.table']!'':		$args['pl']+=$print['key.table']+'<br>'
if $print['hero.property']!'':	$args['pl']+=$print['hero.property']+'<br>'
if $print['gs.table']!'':		$args['pl']+=$print['gs.table']+'<br>'
if $print['obj.unmount']!'':	$args['pl']+=$print['obj.unmount']+'<br>'
if $print['power.change']!'':	$args['pl']+='<br><div align=right>'+$print['power.change']+'</div>'+'<br>'
if $print['help']!'':			$args['pl']+=$print['help']+'<br>'
if $print['counters']!'':		$args['pl']+=$print['counters']+'<br>'
if $print['charge.altar']!'':	$args['pl']+=$print['charge.altar']+'<br>'
killvar '$print'
killvar '$result'
if $args['pl']!'': $log_print[]+=$args['pl']+'<hr>'
if arrsize('$log_print')>100: killvar '$log_print',0
if $GAME_INTERFACE['hero.stat']='stat':  $args['pl']+='<br>'+$replace($replace($func('get.scale.hero'),'<center>'),'</center>')
$args['pl']=$mid($args['pl'],1,len($args['pl'])-4)
$result=$args['pl']
--- print.word ---------------------------------

# get.scale
! функция получает изображение шкалы
$args[0] =	$args[0]	&	!	- кодовое слово рисунка наполнения или цвет в формате RRGGBB
args[1]	 =	args[1]		&	!	- текущее значение
args[3]	 =	args[3] 	&	!	- ширина шкалы. По умолчанию 100 повторений для изображений и 20 повторений для символов
$args[4] =	$args[4]	&	!	- информация для лога
if args[2]=0:
	if $args[4]!'no.log':
		$error_log+='location name: "get.scale" ERROR!: Maximal is null. <<$args[0]>> all:<<args[1]>> max:<<args[2]>><br>'
	else
		$error_log+='location name: "get.scale" This is not error. Maximal is null. <<$args[0]>> all:<<args[1]>> max:<<args[2]>><br>'
	end
	exit		&	!	- максимальное значение
else
	args[2]	 =	args[2]
end
! получаем рисунки шкал
$args['no_image']= $func('base.img')	&	!	как выглядит строка базы, не получившая изображения
$args['fill']	=	$func('base.img',$args[0])
$args['space']	=	$func('base.img','scsp')
$args['refill']	=	$func('base.img','scyl')
if $args['fill']=$args['no_image'] or $args['space']=$args['no_image'] or $args['refill']=$args['no_image']:
! если хотя бы для одного из рисунков не будет найдено изображение в базе создаём шкалу из символов
	if args[3]=0: args[3] = 20
	$args['fill']	=	'<font color=#'+$args[0]+' face="CourierNew">|</font>'
	$args['space']	=	'<font color=#888888 face="CourierNew">|</font>'
	$args['refill']	=	'<font color=#888800 face="CourierNew">|</font>'
else
	if args[3]=0: args[3]=100
	$args['fill']	=	'<img src="'+$args['fill']+'">'
	$args['space']	=	'<img src="'+$args['space']+'">'
	$args['refill']	=	'<img src="'+$args['refill']+'">'
end 
args['fill_size'] = args[1]*args[3]/args[2]	&	!	вычисляем насколько заполнена шкала в процентах
args['full_size']=args[3]	&	!	устанавливаем ширину шкалы
:elset
if args['full_size']>0 or args['fill_size']>0:
	if args['fill_size']>0 and args['full_size']>0:
		$args['res.031213']+=$args['fill']	&	!	подстановка рисунка наполнения шкалы
	elseif args['fill_size']>0 and args['full_size']<1:
		$args['res.031213']+=$args['refill']	&	!	подстановка рисунка переполнения шкалы
	else
		$args['res.031213']+=$args['space']	&	!	подстановка рисунка пустой шкалы
	end
	args['fill_size']=args['fill_size']-1
	args['full_size']=args['full_size']-1
	if args['full_size']>0 or args['fill_size']>0: jump 'elset'
end
$result=$args['res.031213']
--- get.scale ---------------------------------

# get.scale.rn
args[0] = args[0]	&	!	текущее значение
if args[1]=0: args[1]=1 else args[1] = args[1]	&	!	максимальное значение
$args[2] = $args[2]	&	!	набор картинок
if args[3]=0: args[3]=640 else args[3] = args[3]	&	!	ширина шкалы
! Вычисляем ширины ячеек
args['width.all']	=	args[3] - 12	&	!	общая ширина
args['width.full']	=	args[0] * args['width.all'] / args[1]	&	!	ширина заполненного пространства
args['width.empty']	=	args['width.all'] - args['width.full']	&	!	ширина незаполненного пространства
! Простраиваем таблицу
	$args['tr']	+= '<td width='+str(args['width.full'])+'><img src="res/img/scl/scl.rainbow.gif" height=21 width='+str(args['width.full'])+'></td>'
	$args['tr']	+= '<td width='+str(args['width.empty'])+'><img src="res/img/scl/scl.space" height=21 width='+str(args['width.empty'])+'></td>'

$args['result'] += '<table width='+str(args[3]+50)+' cellpadding=0 cellspacing=0><tr>'
$args['result'] += $args['tr']
$args['result'] += '<td width=50><<args[0]>>/<<args[1]>></td></tr></table>'
$result = $args['result']
--- get.scale.rn ---------------------------------

# get.scale.hero
$args['interface']+='<center><table align=center cellpadding=0 cellspacing=0>'
$args['interface']+="<tr><td background='res\img\scl\scl.sky'><font size=-1>"+$func('#indiv#',property['hero.health.all'],100,10)+"</font></td><td>"+$func('get.scale','scrd',property['hero.health.all'],property['hero.health.max'])+"</td><td><font size=-1>"+$func('#indiv#',property['hero.health.max'],100,10)+"</font></td></tr>"
$args['interface']+="<tr><td><font size=-1>"+$func('#indiv#',property['hero.mana.all'],100,10)+"</font></td><td>"+$func('get.scale','scsk',property['hero.mana.all'],property['hero.mana.max'])+"</td><td><font size=-1>"+$func('#indiv#',property['hero.mana.max'],100,10)+"</font></td></tr>"
$args['interface']+="<tr><td><font size=-1>"+$func('#indiv#',property['hero.force.all'],100,10)+"</font></td><td>"+$func('get.scale','scgr',property['hero.force.all'],property['hero.force.max'])+"</td><td><font size=-1>"+$func('#indiv#',property['hero.force.max'],100,10)+"</font></td></tr>"
$args['interface']+="<tr><td><font size=-1>"+$func('#indiv#',property['hero.luck.all'],100,10)+"</font></td><td>"+$func('get.scale','scyl',property['hero.luck.all'],property['hero.luck.max'])+"</td><td><font size=-1>"+$func('#indiv#',property['hero.luck.max'],100,10)+"</font></td></tr>"
$args['interface']+='</table></center>'
$result=$args['interface']
--- get.scale.hero ---------------------------------

# waiting.string
! функция обеспечивает выведение набора символов для визуальной задержки
if $args[0]='': $args[0]=':'	&	!	набор символов
if args[1]=0: args[1]=100	&	!	время задержки между символами
if args[2]=0: args[2]=args[1]*10 	&	!	общее время продолжительности вывода строки в милисекундах
if $args[3]='': $args[3]='ff0000'	&	!	начальный цвет
if $args[4]='': $args[4]='0000ff'	&	!	конечный цвет
args[5]=args[5]	&	!	размер шрифта
args[6] = args[6] 	&	!	режим 0 - вывод в окне основного описания и дополнительного, 1 - основного, 2 дополнительного
args['r1']=func('#hex-dec#',$mid($args[3],1,2))
args['g1']=func('#hex-dec#',$mid($args[3],3,2))
args['b1']=func('#hex-dec#',$mid($args[3],5,2))
args['r2']=func('#hex-dec#',$mid($args[4],1,2))
args['g2']=func('#hex-dec#',$mid($args[4],3,2))
args['b2']=func('#hex-dec#',$mid($args[4],5,2))
args['len'] = len($args[0])	&	!	длина исходной строки
args['i']=args[2]/args[1]
args['r']=(args['r1']-args['r2'])/args['i']
args['g']=(args['g1']-args['g2'])/args['i']
args['b']=(args['b1']-args['b2'])/args['i']
if args['r1']>args['r2'] and args['r']=0: args['r']=1
if args['g1']>args['g2'] and args['g']=0: args['g']=1
if args['b1']>args['b2'] and args['b']=0: args['b']=1
if args['r1']<args['r2'] and args['r']=0: args['r']=-1
if args['g1']<args['g2'] and args['g']=0: args['g']=-1
if args['b1']<args['b2'] and args['b']=0: args['b']=-1
args['u']=1
:cicle
if args[6]=0 or args[6]=1: *p '<font color=#'+$func('#dec-col#',args['r1'])+$func('#dec-col#',args['g1'])+$func('#dec-col#',args['b1'])+' size=+'+str(args[5])+'><b>'+$mid($args[0],args['u'],1)+'</b></font>'
if args[6]=0 or args[6]=2: p '<font color=#'+$func('#dec-col#',args['r1'])+$func('#dec-col#',args['g1'])+$func('#dec-col#',args['b1'])+' size=+'+str(args[5])+'><b>'+$mid($args[0],args['u'],1)+'</b></font>'
args['u']+=1
args['i']-=1
args['r1']-=args['r']
args['g1']-=args['g']
args['b1']-=args['b']
if args['r1']<0: args['r1']=0
if args['g1']<0: args['g1']=0
if args['b1']<0: args['b1']=0
if args['r1']>255: args['r1']=255
if args['g1']>255: args['g1']=255
if args['b1']>255: args['b1']=255
if $mid($args[0],args['u'],1)='': args['u']=1
wait args[1]
if args['i']>-1: jump 'cicle'
--- waiting.string ---------------------------------

# int.loc.interface
! интерпретатор интерфейса локации
$args[0] = $args[0]	&	!	id локации
$args[1] = $args[1]	&	!	тип локации
$args['\r\n']="
"

if $SQUARE['SQUARE.loc.type'] = 'место':
! Тип локации определён, как нормальная локация места, значит вызываем структуру для локации места:
	if $light_array[$args[0]]='темно': $args['цветовые настройки']='темно'
	$args['в основное описание']=$func('interface.place',$args[0])
	if $GAME_INTERFACE['show.stat']='show': $args['в дополнительное описание']=$SQUARE['SQUARE.stat']
	if $GAME_INTERFACE['show.acts']='show':
		$args['в действия']+=$args['\r\n']+$SQUARE['SQUARE.loc.curacts']+$args['\r\n']
		$args['в действия']+=$SQUARE['SQUARE.loc.acts.inActs']
		$args['в действия']+=$SQUARE['SQUARE.location.obj.inActs']
	end
elseif $SQUARE['SQUARE.loc.type'] = 'хранилище':
	$args['в основное описание']=$func('interface.chest',$args[0])
	if $GAME_INTERFACE['show.stat']='show': $args['в дополнительное описание']=$SQUARE['SQUARE.stat']
	if $GAME_INTERFACE['show.acts']='show':
		$args['в действия']=''
		! Внимание!!! При любом режиме хранилище показывается в виде с отключенными действиями.
	end
elseif $SQUARE['SQUARE.loc.type'] = 'кузница':
	$args['в основное описание']=$func('interface.smith',$args[0])
else
	$args['в основное описание']+=$SQUARE['SQUARE.loc.maintxt']			&	!	базовое описание выводится в первую очередь
	$args['в основное описание']+=$SQUARE['SQUARE.loc.hallow']			&	!	следующим по порядку идёт приветствие
	$args['в основное описание']+=$SQUARE['SQUARE.loc.fromSource']		&	!	описание из исходника
	$args['в основное описание']+=$SQUARE['SQUARE.loc.plustext']			&	!	добавочный текст
	$args['в основное описание']+=$SQUARE['SQUARE.loc.dvar']
	if $GAME_INTERFACE['show.stat']='show': $args['в дополнительное описание']=$SQUARE['SQUARE.stat']
	if $GAME_INTERFACE['show.acts']='show':
		$args['в действия']+=$args['\r\n']+$SQUARE['SQUARE.loc.curacts']+$args['\r\n']
		$args['в действия']+=$SQUARE['SQUARE.loc.acts.inActs']
	end
end
cls
if $args['в основное описание']<>'': *pl $func('int.din.text',$args['в основное описание'])
if $args['в дополнительное описание']<>'': pl $func('int.din.text',$args['в дополнительное описание'])
if $args['в действия']<>'': dynamic $args['в действия']
gosub 'setScreen',$SQUARE['SQUARE.loc.type'],$args['цветовые настройки']
gosub 'int.inventory'
--- int.loc.interface ---------------------------------

# interface.place
! таблица в основное описание локации места. Понадобятся значения следующих переменных:
! "общие переменные режимов
	$SQUARE['SQUARE.loc.type']
	$GAME_INTERFACE['show.stat']
	$GAME_INTERFACE['show.acts']
	$GAME_INTERFACE['maintxt']
! общие переменные интерфейса
!	$SQUARE['SQUARE.loc.maintxt']
!	$SQUARE['SQUARE.loc.fromSource']
!	$SQUARE['SQUARE.loc.hallow']
!	$SQUARE['SQUARE.loc.plustext']
!	$SQUARE['SQUARE.loc.dvar']
!	$SQUARE['SQUARE.loc.acts.inHREF']
!	$SQUARE['SQUARE.head']
!	$SQUARE['SQUARE.stat']
! переменные для локаций-мест:
!	$SQUARE['SQUARE.location.obj.inHREF']
!	$SQUARE['SQUARE.location.indark.chest']
!"
$args[0] = $args[0]	&	!	id локации
! формируем заголовок:
$args['head.text']+=$SQUARE['SQUARE.head']
! формируем дополнительное описание:
$args['stat.text']+=$SQUARE['SQUARE.stat']
! формируем действия:
$args['acts.text']+=$SQUARE['SQUARE.loc.acts.inHREF']		&	!	действия из массива $avar идут в первую очередь
$args['acts.text']+=$SQUARE['SQUARE.location.obj.inHREF']	&	!	действия <obj> <goto> <act>
! формируем основное описание:
if $light_array[$args[0]]='темно':
	$args['main.text']+=$func('b.d.t','dark')
	$args['main.text']+=$SQUARE['SQUARE.location.indark.chest']
else
	$args['main.text']+=$SQUARE['SQUARE.loc.maintxt']			&	!	базовое описание выводится в первую очередь
	$args['main.text']+=$SQUARE['SQUARE.loc.hallow']			&	!	следующим по порядку идёт приветствие
	$args['main.text']+=$SQUARE['SQUARE.loc.fromSource']		&	!	описание из исходника
	$args['main.text']+=$SQUARE['SQUARE.loc.plustext']			&	!	добавочный текст
	$args['main.text']+=$SQUARE['SQUARE.loc.dvar']				&	!	текст в накидку
end
	! начало таблицы
	$args['interface']+="<table width=100% valign=middle cellpadding=0 border=1>"
		! ячейка заголовка. Одинаковая для всех режимов.
		$args['interface']+="<tr><td align=center valign=middle>"+$args['head.text']+"</td></tr>"
		! ячейка/таблица описания/статов/действий
		$args['interface']+="<tr><td><table width=100% cellpadding=12 border=2>"
		if $GAME_INTERFACE['maintxt']='vertical':
		! вертикальная разметка. Дополнительное описание располагается рядом с основным и действиями, т.е. одной строкой
			! начало общей строки
			$args['interface']+='<tr>'
			if $GAME_INTERFACE['show.stat']='main left':
			! если статы выводятся слева, создеём отдельную ячейку
				$args['interface']+='<td align=center valign=bottom width=38%><div align=justify>'
				if $args['stat.text']<>'': $args['interface']+=$args['stat.text'] else $args['interface']+='&nbsp;'
				$args['interface']+='</div></td>'
			end
			! создаём ячейку для основного описания и действий и ещё таблицу:
			$args['interface']+='<td align=left valign=top><table width=100% cellpadding=5 border=1>'
				! строка и ячейка с основным описанием
				$args['interface']+="<tr><td width=100% valign=top align=center height=400><div align=justify>"
					if $args['main.text']<>'': $args['interface']+=$args['main.text'] else $args['interface']+='&nbsp;'
				! закрываем строку и ячейку с основным описанием
				$args['interface']+="</div></td></tr>"
				! В режиме main under дополнительное описание располагается сразу под основным
				if $GAME_INTERFACE['show.stat']='main under' and $args['stat.text']<>'':
				! строка/ячейка дополнительного описания не создаётся, если не нужна
					$args['interface']+="<tr><td width=100% valign=top align=center height=400><div align=justify>"
						$args['interface']+=$args['stat.text']
					$args['interface']+="</div></td></tr>"
				end
				! действия добавляются в таблицу только при show.acts=hide
				if $GAME_INTERFACE['show.acts']='hide' and $args['acts.text']<>'':
				! строка/ячейка действий не создаётся, если их нет
					$args['interface']+="<tr><td width=100% valign=top align=left bgcolor=#"+$GAME_INTERFACE['acts.color']+">"
						$args['interface']+='<font size=1>'+$func('b.d.t','word.acts')+':</font><br>'
						$args['interface']+=$args['acts.text']
					$args['interface']+="</td></tr>"
				end
			! закрываем таблицу и ячейку
			$args['interface']+='</table></td>'
			if $GAME_INTERFACE['show.stat']='main right':
			! если статы выводятся справа, создаём отдельную ячейку
				$args['interface']+='<td align=center valign=bottom width=38%><div align=justify>'
				if $args['stat.text']<>'': $args['interface']+=$args['stat.text'] else $args['interface']+='&nbsp;'
				$args['interface']+='</div></td>'
			end
			! конец общей строки
			$args['interface']+='</tr>'
		elseif $GAME_INTERFACE['maintxt']='horizontal':
		! горизонатльная разметка. дополнительное описание и действия располагаются под основным описанием
			! отдельной строкой и ячейкой размещаем основное описание
			$args['interface']+='<tr><td width=100% height="400 px."><div align=justify>'
				if $args['main.text']<>'': $args['interface']+=$args['main.text'] else $args['interface']+='&nbsp;'
			$args['interface']+='</div></td></tr>'
			! строка/ячейка/таблица с действиями и статами. Выводится только если хотя бы одно из окон скрыто
			if $GAME_INTERFACE['show.acts']='hide' or $GAME_INTERFACE['show.stat']<>'show':
				$args['interface']+='<tr><td width=100%><table width=100% border=1>'
					! общая строка
					$args['interface']+='<tr>'
						if $GAME_INTERFACE['show.stat']='main left' or $GAME_INTERFACE['show.stat']='main right':
							if $GAME_INTERFACE['show.acts']='hide': args["w"]=35 else args["w"]=100
							$args['stat.cell']='<td width=<<args["w"]>>% align=center valign=top><div align=justify>'
							if $args['stat.text']<>'': $args['stat.cell']+=$args['stat.text'] else $args['stat.cell']+='&nbsp;'
							$args['stat.cell']+='</div></td>'
						end
						if $GAME_INTERFACE['show.stat']='main left':	$args['interface']+=$args['stat.cell']
						if $GAME_INTERFACE['show.acts']='hide':
							if $args['acts.text']<>'':
								$args['interface']+="<td valign=top align=left bgcolor=#"+$GAME_INTERFACE['acts.color']+">"
									$args['interface']+='<font size=1>'+$func('b.d.t','word.acts')+':</font><br>'
									$args['interface']+=$args['acts.text']
								$args['interface']+="</td>"
							else
								$args['interface']+='<td>&nbsp;</td>'
							end
						end
						if $GAME_INTERFACE['show.stat']='main right':	$args['interface']+=$args['stat.cell']
					$args['interface']+='</tr>'
					! если show.stat = main under размещаем отдельной строкой
					if $GAME_INTERFACE['show.stat']='main under' and $args['stat.text']<>'':
						$args['interface']+="<tr><td width=100% valign=top align=center height=400><div align=justify>"
							$args['interface']+=$args['stat.text']
						$args['interface']+="</div></td></tr>"
					end
				$args['interface']+='</table></td></tr>'
			end
		end
		! закрываем ячейку/таблицу описания/статов/действий
		$args['interface']+='</table></td></tr>'
	! конец таблицы
	$args['interface']+="</table>"
$result = $args['interface']
--- interface.place ---------------------------------

# interface.chest
! таблица в основное описание локации места. Понадобятся значения следующих переменных:
! "общие переменные режимов
	$SQUARE['SQUARE.loc.type']
	$GAME_INTERFACE['show.stat']
	$GAME_INTERFACE['show.acts']
	$GAME_INTERFACE['maintxt']
! общие переменные интерфейса
!	$SQUARE['SQUARE.loc.maintxt']
!	$SQUARE['SQUARE.loc.fromSource']
!	$SQUARE['SQUARE.loc.hallow']
!	$SQUARE['SQUARE.loc.plustext']
!	$SQUARE['SQUARE.loc.dvar']
!	$SQUARE['SQUARE.loc.acts.inHREF']
!	$SQUARE['SQUARE.head']
!	$SQUARE['SQUARE.stat']
! переменные для хранилищ/кузниц/алтарей/проч...
!	$SQUARE['SQUARE.chest.closeAct']
! переменные для хранилища
!	$SQUARE['SQUARE.chest.obj.inHREF']
!"
$args[0] = $args[0]	&	!	id локации
! формируем заголовок:
$args['head.text']+=$SQUARE['SQUARE.head']
! формируем дополнительное описание:
$args['stat.text']+=$SQUARE['SQUARE.stat']
! формируем действия:
$args['acts.text']+=$SQUARE['SQUARE.loc.acts.inHREF']		&	!	действия из массива $avar
! формируем основное описание:
$args['main.text']+=$SQUARE['SQUARE.loc.maintxt']			&	!	базовое описание выводится в первую очередь
$args['main.text']+=$SQUARE['SQUARE.loc.hallow']			&	!	следующим по порядку идёт приветствие
$args['main.text']+=$SQUARE['SQUARE.loc.fromSource']		&	!	описание из исходника
$args['main.text']+=$SQUARE['SQUARE.loc.plustext']			&	!	добавочный текст
$args['main.text']+=$SQUARE['SQUARE.loc.dvar']				&	!	текст в накидку
if $args['acts.text']<>'' and $args['acts.text']<>'': $args['main.text']+='<br>'
$args['main.text']+=$args['acts.text']						&	!	действия на локации в основном описании

	! начало таблицы
	$args['interface']+='<table width=100% valign=middle cellpadding=8 border=3>'
		! строка заголовка. Одинаковая для всех режимов:
		$args['interface']+="<tr><td align=center valign=middle>"+$args['head.text']+"</td></tr>"
		! основной текст вертикальный:
		if $GAME_INTERFACE['maintxt']='vertical':
			! если режим статов main under отдельной строкой пишется основное описание
			if $GAME_INTERFACE['show.stat']="main under" and $args['main.text']<>'':
				! начало строки и ячейки
				$args['interface']+="<tr><td align=left valign=top><div align=justify>"
				! содержимое основного описания:
					$args['interface']+=$args['main.text']
				! конец строки и ячейки
				$args['interface']+="</div></td></tr>"
			end
			! если режим статов main under отдельной строкой пишется дополнительное описание
			if $GAME_INTERFACE['show.stat']="main under" and $args['stat.text']<>'':
				! начало строки и ячейки
				$args['interface']+="<tr><td align=left valign=top><div align=justify>"
				! содержимое основного описания:
					$args['interface']+=$args['stat.text']
				! конец строки и ячейки
				$args['interface']+="</div></td></tr>"
			end
			! начало строки/ячейки/таблицы со списком предметов/мэйном/статом
			$args['interface']+="<tr><td align=center valign=top><table width=100% cellpadding=5 border=2>"
				! ячейка/таблица мэйн/стат начало
				$args['main|stat']+='<td width=35%><table width=100% border=1>'
					! строка/ячейка - основное опписание начало
					$args['main|stat']+='<tr><td>'
						if $args['main.text']<>'': $args['main|stat']+=$args['main.text'] else $args['main|stat']+='&nbsp;'
					! строка/ячейка - основное опписание конец
					$args['main|stat']+='</td></tr>'
					if $args['stat.text']<>'':
					! строка ячейка доп описания
						$args['main|stat']+='<tr><td>'
						$args['main|stat']+=$args['stat.text']
						$args['main|stat']+='</td></tr>'
					end
				! ячейка/таблица мэйн/стат конец
				$args['main|stat']+='</table></td>'
				if $GAME_INTERFACE['show.stat']="main left": $args['interface']+=$args['main|stat']
				! ячейка с предметами начало
				$args['interface']+='<td align=left valign=bottom>'
					$args['interface']+=$SQUARE['SQUARE.chest.obj.inHREF']
					$args['interface']+='<br>'+$SQUARE['SQUARE.chest.closeAct']
				!ячейка с предметами конец
				$args['interface']+='</td>'
				if $GAME_INTERFACE['show.stat']="main right": $args['interface']+=$args['main|stat']
			! конец строки/ячецки/таблицы со списокм/мэйном/статом
			$args['interface']+='</table></td></tr>'
		elseif $GAME_INTERFACE['maintxt']='horizontal':
			! начало строки/ячейки с мэйном
			$args['interface']+='<tr><td width=100%>'
				$args['interface']+=$args['main.text']
			! конец строки/ячейки с мэйном
			$args['interface']+='</td></tr>'
			! начало строки/ячейки таблицы со сброшенными предметами и статом
			$args['interface']+='<tr><td><table width=100% border=2 cellspacing=5><tr>'
				! ячейка стат
				if $args['stat.text']<>'':
				! строка ячейка доп описания
					$args['main|stat']+='<td width=35% align=left valign=top>'
					$args['main|stat']+=$args['stat.text']
					$args['main|stat']+='</td>'
				end
				if $GAME_INTERFACE['show.stat']="main left" and $args['main|stat']<>'': $args['interface']+=$args['main|stat']
				! ячейка сброшенных предметов
				$args['interface']+='<td valign=top align=left>'
					$args['interface']+=$SQUARE['SQUARE.chest.closeAct']+'<br>'
					$args['interface']+=$SQUARE['SQUARE.chest.obj.inHREF']
				$args['interface']+='</td>'
				if $GAME_INTERFACE['show.stat']="main right" and $args['main|stat']<>'': $args['interface']+=$args['main|stat']
			! конец строки/ячейки таблицы со сброшенными предметами и статом
			$args['interface']+='</tr></table></td></tr>'
			! строка ячейка статов при main under
			if $args['stat.text']<>'' and $GAME_INTERFACE['show.stat']="main under":
				$args['interface']+='<tr><td align=left valign=top>'
					$args['interface']+=$args['stat.text']
				$args['interface']+='</td></tr>'
			end
		end
	! конец таблицы
	$args['interface']+="</table>"
	
$result = $args['interface']
--- interface.chest ---------------------------------

# interface.smith
! "таблица в основное описание локации кузницы. Понадобятся значения следующих переменных:
$GAME_INTERFACE['show.stat']
$GAME_INTERFACE['show.acts']
$GAME_INTERFACE['maintxt']
! $SQUARE['SQUARE.loc.maintxt']
! $SQUARE['SQUARE.loc.fromSource']
! $SQUARE['SQUARE.loc.hallow']
! $SQUARE['SQUARE.loc.plustext']
! $SQUARE['SQUARE.loc.dvar']
! $SQUARE['SQUARE.loc.acts.inHREF']
! $SQUARE['SQUARE.head']
! $SQUARE['SQUARE.stat']
$SQUARE['SQUARE.chest.closeAct']

$SQUARE['SQUARE.smithing.craftObjs']
!"
$args[0] = $args[0]	&	!	id локации
! формируем заголовок:
$args['head.text']+=$SQUARE['SQUARE.head']
! формируем дополнительное описание:
$args['stat.text']+=$SQUARE['SQUARE.stat']
! формируем действия:
$args['acts.text']+=$SQUARE['SQUARE.loc.acts.inHREF']		&	!	действия из массива $avar идут в первую очередь
! формируем основное описание:
$args['main.text']+=$SQUARE['SQUARE.smithing.craftObjs']		&	!	в основное описание в первую очередь добавляется список создаваемых предметов
$args['main.text']+=$SQUARE['SQUARE.loc.maintxt']			&	!	базовое описание
$args['main.text']+=$SQUARE['SQUARE.loc.hallow']			&	!	следующим по порядку идёт приветствие
$args['main.text']+=$SQUARE['SQUARE.loc.fromSource']		&	!	описание из исходника
$args['main.text']+=$SQUARE['SQUARE.loc.plustext']			&	!	добавочный текст
$args['main.text']+=$SQUARE['SQUARE.loc.dvar']				&	!	текст в накидку

--- interface.smith ---------------------------------

# hero.health
! Отвечает за подсчёт здоровья героя
args[0]	=	args[0]	&	!	на сколько изменяется здоровье
$args[1]	=	$args[1]	&	!	в какую сторону изменяется
if $args[2]='': $args[2]='all' else $args[2] = $args[2] & ! all - текущий запас max - максимальный уровень
$args[3] = $args[3]	&	!	дополнительный текст
if args[0]!0:
	args['last_max']=property['hero.health.max']
	if $args[1]='' or $args[1]='del' or $args[1]='-':
		property['hero.health.'+$args[2]]-=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','009.3','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','009.4','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	elseif $args[1]='+' or $args[1]='add':
		property['hero.health.'+$args[2]]+=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','009.1','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','009.2','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	end
	if property['hero.health.max']<>args['last_max']: property['hero.health.all']=property['hero.health.all']+(property['hero.health.max']-args['last_max'])
	if property['hero.health.all']>property['hero.health.max']: property['hero.health.all']=property['hero.health.max']
	if property['hero.health.all']<1:
		GOTO '[death]'
	end
	$print['hero.health']+='<font size=-1>'+$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:health:\]'))+'</font>'
end
--- hero.health ---------------------------------

# hero.mana
! Отвечает за подсчёт духовных сил героя
args[0]	=	args[0]	&	!	на сколько изменяется мана
$args[1]	=	$args[1]	&	!	в какую сторону изменяется
if $args[2]='': $args[2]='all' else $args[2] = $args[2] & ! all - текущий запас max - максимальный уровень
$args[3] = $args[3]	&	!	дополнительный текст
if args[0]!0:
	args['last_max']=property['hero.mana.max']
	if $args[1]='' or $args[1]='del' or $args[1]='-':
		property['hero.mana.'+$args[2]]-=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','012.3','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','012.4','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	elseif $args[1]='+' or $args[1]='add':
		property['hero.mana.'+$args[2]]+=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','012.1','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','012.2','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	end
	if property['hero.mana.max']<>args['last_max']: property['hero.mana.all']=property['hero.mana.all']+(property['hero.mana.max']-args['last_max'])
	if property['hero.mana.all']>property['hero.mana.max']: property['hero.mana.all']=property['hero.mana.max']
	if property['hero.mana.all']<0: property['hero.mana.all']=0
	$print['hero.health']+='<font size=-1>'+$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:mana:\]'))+'</font>'
end
--- hero.mana ---------------------------------

# hero.force
! Отвечает за подсчёт запаса бодрости/выносливость
args[0]	=	args[0]	&	!	на сколько изменяется бодрость
$args[1]	=	$args[1]	&	!	в какую сторону изменяется
if $args[2]='': $args[2]='all' else $args[2] = $args[2] & ! all - текущий запас max - максимальный уровень
$args[3] = $args[3]	&	!	дополнительный текст
if args[0]!0:
	args['last_max']=property['hero.force.max']
	if $args[1]='' or $args[1]='del' or $args[1]='-':
		property['hero.force.'+$args[2]]-=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','026.3','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','026.4','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	elseif $args[1]='+' or $args[1]='add':
		property['hero.force.'+$args[2]]+=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','026.1','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','026.2','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	end
	if property['hero.force.max']<>args['last_max']: property['hero.force.all']=property['hero.force.all']+(property['hero.force.max']-args['last_max'])
	if property['hero.force.all']>property['hero.force.max']: property['hero.force.all']=property['hero.force.max']
	if property['hero.force.all']<0: property['hero.force.all']=0
	$print['hero.health']+='<font size=-1>'+$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:force:\]'))+'</font>'
end
--- hero.force ---------------------------------

# hero.luck
! Отвечает за подсчёт удачи сил героя
args[0]	=	args[0]	&	!	на сколько изменяется
$args[1]	=	$args[1]	&	!	в какую сторону изменяется
if $args[2]='': $args[2]='all' else $args[2] = $args[2] & ! all - текущий запас max - максимальный уровень
$args[3] = $args[3]	&	!	дополнительный текст
if args[0]!0:
	args['last_max']=property['hero.luck.max']
	if ($args[1]='' or $args[1]='del' or $args[1]='-') and (($args[2]='max' and (property['hero.luck.max']-args[0])>4) or $args[2]<>'max'):
	! удача не может упасть ниже 5 единиц.
		property['hero.luck.'+$args[2]]-=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','025.3','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','025.4','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	elseif $args[1]='+' or $args[1]='add':
		property['hero.luck.'+$args[2]]+=args[0]
		if $args[2]='all': $print['hero.health']+=$func('base.word.screen','025.1','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
		if $args[2]='max': $print['hero.health']+=$func('base.word.screen','025.2','[колво:'+str(args[0])+'] [txt:<<$args[3]>>:txt]')
	end
	if property['hero.luck.max']<>args['last_max']: property['hero.luck.all']=property['hero.luck.all']+(property['hero.luck.max']-args['last_max'])
	! Удача может превышать максимальный уровень.
	if property['hero.luck.all']<5: property['hero.luck.all']=5
	$print['hero.health']+='<font size=-2>'+$func('int.hero.property',$func('get.id.obj','<property>[\s\S]*\[:luck:\]'))+'</font>'
end
--- hero.luck ---------------------------------

# hero.level
! отвечает за подсчёт опыта героя и уровня.
args[0] = args[0]	&	!	сколько очков добавится.
$args['id'] = $func('get.id.obj','<property>[\s\S]*\[:level:\]')
$args['obj']=$object_array[arrpos('$id_array',$args['id'])]
$args['l']=$func('get.tag.cont',$args['obj'],'l')
if $args['l']='': $args['l']='уровень|уровня|уровню|уровень|уровнем|уровне'
point_count['hero.level.level'] = point_count['hero.level.level']	&	!	уровень
point_count['hero.level.point'] = point_count['hero.level.point']	&	!	непосредственно очки опыта
point_count['hero.level.marker']= point_count['hero.level.marker']	&	!	пороговое значение
point_count['hero.level.point']+=args[0]
if point_count['hero.level.point']>=point_count['hero.level.marker']:
! если мы достигли порогового значения, значит прибаляем уровень, выставляем следующее значение
	point_count['hero.level.level']+=1
	point_count['hero.level.marker']+=100*point_count['hero.level.level']
	! с прибавлением уровня увеличиваются очки обучения
	point_count['hero.teaching.point']+=point_count['hero.teaching.up']+property['hero.teaching']
	$print['counters']+='<br>'+$func('int.din.text','<font color=#00ccff><b>Ты (достиг/достигла) </b>'+str(point_count['hero.level.level'])+' <b>'+$func('get.word.padez',$args['l'],'Р')+'.</b></font>')
	$print['counters']+="<br><font color=#005588><b>Получено</b> <<point_count['hero.teaching.up']+property['hero.teaching']>> <b>"+$func('get.word.end',point_count['hero.teaching.up']+property['hero.teaching'],'очко|очка|очков')+" обучения.</b></font>"
end
--- hero.level ---------------------------------

# int.run
! локация преобразует набор строк в текст и выполняет динамический код.
$args[0] = $args[0]	&	!	строка вида r1: :r1 ... rN: :rN
args['i']=1
:for
if $strfind($args[0],'r[\d]+:[\s\S]*:r[\d]+')!'':
	$args['string']=$func('get.tag.cont',$args[0],"r<<args['i']>>")
	$args[0]=TRIM($replace($args[0],"r<<args['i']>>:"+$args['string']+":r<<args['i']>>"))
	$args['res.021213']=$args['string']+'
'
	args['i']+=1
	jump 'for'
end
dynamic $args['res.021213']
--- int.run ---------------------------------

# int.influence.scripts
! Здесь производится запуск и обработка подпрограмм влияний и воздействий
$args[0] = $args[0]	&	!	управляющая конструкция
$args[1] = $args[1]	&	!	разные значения
! свойства и влияния на героя
$args['hero'] = $func('get.id.obj','<hero>')
$args['unerror']=$func('get.daughter.obj',$args['hero'],'<property>','$temp_hero')
:for_me
if arrsize('$temp_hero')>0:
	args['pit']=arrpos('$id_array',$temp_hero[0])
	if $run_array[args['pit']]!'':
		gs 'run.dynamic.script',$args[0],$temp_hero[0],$temp_hero[0],$args[1]
	end
	killvar '$temp_hero',0
	jump 'for_me'
end
--- int.influence.scripts ---------------------------------

# run.dynamic.script
$args[0] = $args[0]	&	!	управляющая конструкция
$args[1] = $args[1]	&	!	ай-ди предмета, который обрабатываем, новый предмет
$args[2] = $args[2]	&	!	ай-ди предмета, который обрабатываем, старый предмет
$args[3] = $args[3]	&	!	прочая информация
args['pit']=arrpos('$id_array',$args[1])
$args['dynamic']='$args[9] = $args[9]	&	!	строка инициализирующая аргументы
'+$run_array[args['pit']]
$args['rds']=DYNEVAL($args['dynamic'],$args[0],$args[1],$args[2],$args[3])
$result=$args['rds']
--- run.dynamic.script ---------------------------------

# int.altar
! Интерпретатор алтаря.
$args[0] = $args[0]	&	!	ай-ди локации
! получаем заголовок локации
$args['loc.head']=$func('get.obj.id',$args[0])
! получаем список предметов, сброшенных на локации.
$args['предметы на алтаре']=$func('int.loc.obj',$args[0],'','href','[count][take:take][spirit]')

! ---------------- получаем идентификатор предмета, установленный на подзарядку -----------------------
	$args['onAltar']=$func('get.daughter.obj',$args[0],'','$id_obj_IAO')
	args['size.MASS']=arrsize('$id_obj_IAO')
	if $args['onAltar']='true':
		:Really_Unimaginable_Stories
		if arrsize('$id_obj_IAO')>0:
			if $strfind($run_array[arrpos('$id_array',$id_obj_IAO[0])],'!<onALTAR>')<>'':
				$args['onAltar.ID']=$id_obj_IAO[0]
			else
				killvar '$id_obj_IAO',0
				jump 'Really_Unimaginable_Stories'
			end
		end
	end
	killvar '$id_obj_IAO'
! ---------------- получаем идентификатор предмета, установленный на подзарядку -----------------------

! если такой прдмет имеется
if $args['onAltar.ID']<>'':
	! получаем ссылку етого предмета
	$args['ссылка етого предмета']=$strfind($args['предметы на алтаре'],'<a class="plain" href="exec:gs ''take.obj'','''+$args['onAltar.ID']+''' & GS ''true.goto.curloc'',''\[chest\]''"><font color=#[A-Fa-f0-9]{6}>[^<]+</font></a><br>')
	$args['obj.qwerty']=$object_array[arrpos('$id_array',$args['onAltar.ID'])]
	$args['name.qwerty']=$func('get.word.padez',$func('get.tag.cont',$args['obj.qwerty'],'name'),'В')
	$args['color.qwerty']=$func('get.tag.num',$args['obj.qwerty'],'color')
	$args['заряжаемый']='<b><a class="plain" href="exec:gs ''take.obj'','''+$args['onAltar.ID']+''' & GS ''true.goto.curloc'',''[chest]''"><font color=#'+$args['color.qwerty']+'>'+$func('b.d.t','altar.remove',$args['name.qwerty'])+'</font></a></b>'
	$args['жертвенник']+='<font size=-1>'+$func('b.d.t','altar.credence')+':</font><br>'
	$args['жертвенник']+=$replace($args['предметы на алтаре'],'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+$args['ссылка етого предмета'])
else
	$args['жертвенник']='<font size=-1>'+$func('b.d.t','altar.credence')+':</font><br>'+$args['предметы на алтаре']
end
! Если локация отведена определённому божеству, можно сгенерировать это божество
$args['god.altar']=TRIM($func('get.tag.cont',$args['loc.head'],'god'))
$args['god.id']=$func('get.id.obj','(<god>[\s\S]*\[god:'+$args['god.altar']+':god\]|\[god:'+$args['god.altar']+':god\][\s\S]*<god>)')
if $args['god.id']='false':
	$args['god.id']=$func('add.new.obj','<god> [god:'+$args['god.altar']+':god] [name:'+$args['god.altar']+':name]','','GOD')
end
$args['карма+']=$func('#indiv#',kolvo_array[arrpos('$id_array',$args['god.id'])],100,10)

! ------------------------------- выборка заряда --------------------------------
if kolvo_array[arrpos('$id_array',$args['god.id'])]/100!0 and $args['onAltar.ID']<>'':
	! здесь следует вычислять текущую стоимость
	$args['зарядить+']='<a class="plain" href="exec:gs ''altar.charge.obj'',''<<$args[0]>>'',''<<$args[''onAltar.ID'']>>'' & gs ''true.goto.curloc'',$curloc"><b><font color=#996600>'+$func('b.d.t','altar.charge')+'</font></b></a>'
else
	$args['зарядить+']='<font color=#888888>'+$func('b.d.t','altar.charge')+'</font>'
end
! ------------------------------- выборка заряда --------------------------------

if ($args['onAltar.ID']<>'' and args['size.MASS']>1) or (args['size.MASS']>0 and $args['onAltar.ID']=''):
	$args['действие+']+='<a class="plain" href="exec:gs ''altar.sacrifice'',''<<$args[0]>>'' & gs ''true.goto.curloc'',$curloc"><b><font color=#996600>'+$func('b.d.t','altar.sacrifice')+'</font></b></a>'
else
	$args['действие+']+='<font color=#888888>'+$func('b.d.t','altar.sacrifice')+'</font>'
end
! создаём нужное
$args['описание локации']+='<table border=0 width=100% cellpadding=5>'
$args['описание локации']+='<tr><td align=right valign=middle>'+$func('b.d.t','altar.karma')+': </td><td align=left valign=middle width=35%><<$args["карма+"]>></td></tr>'
$args['описание локации']+='<tr><td align=left valign=middle>'+$args['заряжаемый']+'</td><td align=center valign=middle width=35%>'+$args['зарядить+']+'</td></tr>'
$args['описание локации']+='<tr><td align=left valign=top>'+$args['жертвенник']+'</td><td align=center valign=bottom width=35%>'+$args['действие+']+'</td></tr>'
$args['описание локации']+='</table>'
$result = $args['описание локации']
killvar '$id_obj_IAO'
--- int.altar ---------------------------------

# altar.sacrifice
! приносит предметы в жертву
$args[0] = $args[0]	&	!	id локации
$args['loc.head']=$func('get.obj.id',$args[0])
! получаем список предметов, сброшенных на локации.
$args['предметы на алтаре']=$func('int.loc.obj',$args[0])
! получаем предмет, установленный на подзарядку
$args['altar.obj']=$func('get.daughter.obj',$args[0],'','$id_obj_AS')
if $args['altar.obj']='true':
	:for
	if arrsize('$id_obj_AS')!0:
		args['pit'] = arrpos('$id_array',$id_obj_AS[0])
		if instr($run_array[args['pit']],'!<onALTAR>')=0:
			args['+к карме']+=func('get.spirit',$id_obj_AS[0])
			args['+к молитвам']+=1
			gosub 'del.obj',$id_obj_AS[0]
		end
		killvar '$id_obj_AS',0
		jump 'for'
	end
end
$args['god.altar']=$func('get.tag.cont',$args['loc.head'],'god')
$args['god.id']=$func('get.id.obj','(<god>[\s\S]*\[god:'+$args['god.altar']+':god\]|\[god:'+$args['god.altar']+':god\][\s\S]*<god>)')
kolvo_array[arrpos('$id_array',$args['god.id'])]	+=	args['+к карме']
charge_array[arrpos('$id_array',$args['god.id'])]	+=	args['+к молитвам']
$print['charge.altar']+=$func('b.w.s','altar.sacrifice',args['+к молитвам'])
--- altar.sacrifice ---------------------------------

# altar.charge.obj
! локация производит заряд предмета от кармической энергии, если это возможно.
$args[0] = $args[0]	&	!	идентификатор локации
$args[1] = $args[1]	&	!	идентификатор предмета
! получаем заголовок локации
$args['loc.head']=$func('get.obj.id',$args[0])
! получаем заряжаемый предмет:
if $args[1]<>'':
	! если предмет помещён в жертвенник
	$args['onAltar']=$args[1]
	! получаем позицию в базе и тело предмета
	args['pit']=arrpos('$id_array',$args['onAltar'])
	$args['obj']=$object_array[args['pit']]
	! получаем максимальный заряд предмета и текущий заряд предмета
	args['max_charge']=func('get.tag.num',$args['obj'],'maxchrg')	&	!	5000 (500000)
	args['charge']=charge_array[args['pit']]	&	!	300 (30000)
	args['full']=args['max_charge']-args['charge']	&	!	сколько требуется до полной зарядки 4700 (470000)
	if args['full']=0:
		$print['charge.altar']+=$func('b.w.s','altar.charge','dont')
		exit
	end
	! получаем ай-ди божества
	$args['god.altar']=TRIM($func('get.tag.cont',$args['loc.head'],'god'))
	$args['god.id']=$func('get.id.obj','(<god>[\s\S]*\[god:'+$args['god.altar']+':god\]|\[god:'+$args['god.altar']+':god\][\s\S]*<god>)')
	args['god.pit']=arrpos('$id_array',$args['god.id'])
	! получаем кармическую энергию, переданную божеству
	args['карма+']=kolvo_array[args['god.pit']]	&	!	7333 (733300)
	! одна единица заряда предмета (100) потребляет определённое количество кармической энергии 5(500) по умолчанию.
	args['кармы на единицу заряда']=500	&	!	ЗДЕСЬ ДОЛЖНО ПРОИСХОДИТЬ ОБРАЩЕНИЕ К ФОРМУЛЕ, ВЫЧИСЛЯЮЩЕЙ СТОИМОСТЬ ЕДИНИЦЫ ЗАРЯДА В КАРМИЧЕСКОЙ ЭНЕРГИИ
	! сколько заряда максимум мы можем из этого выжать
	args['сколько можно получить']=(args['карма+']*100)/args['кармы на единицу заряда']
	if args['сколько можно получить']>=args['full']:
	! если количество заряда, который можно получить, достаточно для заряда всего посоха, заряжаем весь
		charge_array[args['pit']]+=args['full']
		! уменьшаем количество кармической энергии
		kolvo_array[args['god.pit']]-=args['full']*args['кармы на единицу заряда']/100
		$print['charge.altar']+=$func('b.w.s','altar.charge','full')
	else
	! если количество заряда, который можно получить, достаточно только для части посоха, заряжаем часть
		charge_array[args['pit']]+=args['сколько можно получить']
		! уменьшаем количество кармической энергии
		kolvo_array[args['god.pit']]-=args['сколько можно получить']*args['кармы на единицу заряда']/100
		$print['charge.altar']+=$func('b.w.s','altar.charge','part',$args['onAltar'])
	end
end
--- altar.charge.obj ---------------------------------

# get.spirit
! функция получает "духовную стоимость" предмета. Духовную ценность можно указывать для определённого божества.
$args[0] = $args[0]	&	!	ай-ди предмета
$args[1] = $args[1]	&	!	ай-ди локации
$args['obj']=$func('get.obj.id',$args[0])
args['pit'] = arrpos('$id_array',$args[0])
$args['loc']=$func('get.obj.id',$args[1])
! получаем имя бога, которому должно делаться жертвоприношение
$args['god.name']=$func('get.tag.cont',$args['loc'],'god')
! получаем духовную ценность предмета для этого конкретного бога
args['spirit.god.name']=func('get.tag.num',$func('get.tag.cont',$args['obj'],'spirit'),$args['god.name'])
! если духовная ценность для этого конкретно божества не указана, получаем духовную ценность для "пустого" бога
if args['spirit.god.name']=0:
	args['spirit']=func('get.tag.num',$args['obj'],'spirit')
else
	args['spirit']=args['spirit.god.name']
end
! если и на этот раз мы не обнаружили духовную ценность, вычисляем духовную ценность из всяких свойств предмета:
if args['spirit']=0:
	args['spirit']=func('get.tag.num',$args['obj'],'stoim')/5
end
if args['spirit']=0:
	args['spirit']=func('get.tag.num',$args['obj'],'weight')/50

	$args['spirit.type']=$func('get.tag.cont',$args['obj'],'np')
	! поправить коэффициенты согласно балансу
	if instr($args['spirit.type'],'[оружие]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[двуручное]')!0: args['spirit']+=80
	if instr($args['spirit.type'],'[одноручное]')!0: args['spirit']+=60
	if instr($args['spirit.type'],'[топор]')!0: args['spirit']+=40
	if instr($args['spirit.type'],'[молот]')!0: args['spirit']+=40
	if instr($args['spirit.type'],'[меч]')!0: args['spirit']+=60
	if instr($args['spirit.type'],'[лук]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[посох]')!0: args['spirit']+=500
	if instr($args['spirit.type'],'[огнестрельное]')!0: args['spirit']+=200
	if instr($args['spirit.type'],'[нож]')!0: args['spirit']+=20
	if instr($args['spirit.type'],'[булава]')!0: args['spirit']+=40
	if instr($args['spirit.type'],'[кинжал]')!0: args['spirit']+=40
	if instr($args['spirit.type'],'[доспех]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[шлем]')!0: args['spirit']+=20
	if instr($args['spirit.type'],'[наплечни]')!0: args['spirit']+=80
	if instr($args['spirit.type'],'[кираса]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[перчатки]')!0: args['spirit']+=20
	if instr($args['spirit.type'],'[поножи]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[обувь]')!0: args['spirit']+=80
	if instr($args['spirit.type'],'[амулет]')!0: args['spirit']+=500
	if instr($args['spirit.type'],'[щит]')!0: args['spirit']+=100
	if instr($args['spirit.type'],'[снаряды]')!0: args['spirit']+=50
	if instr($args['spirit.type'],'[болты]')!0: args['spirit']+=2
	if instr($args['spirit.type'],'[стрелы]')!0: args['spirit']+=1
	if instr($args['spirit.type'],'[снаряд метательный]')!0: args['spirit']+=5
	if instr($args['spirit.type'],'[ингредиент]')!0: args['spirit']+=15
	if instr($args['spirit.type'],'[еда]')!0: args['spirit']+=5
	if instr($args['spirit.type'],'[свиток]')!0: args['spirit']+=75
	if instr($args['spirit.type'],'[книга]')!0: args['spirit']+=50
	if instr($args['spirit.type'],'[шкатулка]')!0: args['spirit']+=25
	if instr($args['spirit.type'],'[материал]')!0: args['spirit']+=1
	if instr($args['spirit.type'],'[меновой]')!0: args['spirit']+=1
end
result = args['spirit'] * kolvo_array[args['pit']]
--- get.spirit ---------------------------------

# menu.obj.put.onAltar
! надстройка для сброса предмета.  Эта метка мешает алтарю уничтожить предмет как жертвенный
if $args[0]='': $args[0]=$OOS['oid']
$run_array[arrpos('$id_array',$args[0])]+={!<onALTAR>
$args[0] = $args[0]
$args[1] = $args[1]
$args[2] = $args[2]
if $args[0]='!passed!':	$print['put.altar']+=$func('b.w.s','put.altar',$args[1])
if $args[0]='!taked!':
	args['pit']=arrpos('$id_array',$args[1])
	$args['run.onAltar']=$strfind($run_array[args['pit']],'!<'+'onALTAR'+'>[\s\S]*!<\/'+'onALTAR'+'>')
	$run_array[args['pit']]=$replace($run_array[args['pit']],$args['run.onAltar'])
end
!</onALTAR>
}
gs 'menu.obj.put',$args[0],1
--- menu.obj.put.onAltar ---------------------------------

