# Конвертер `qsp_to_qsps.py`

> формат TXT2GAM и qsps — это одно и то же. Это текстовые файлы с особым форматом записи QSP-кода.

Скрипт основан на JS-скрипте Werewolf'а для конвертирования QSP-файлов в qsps-формат: [https://codepen.io/srg-kostyrko/full/QWqdwxv](https://codepen.io/srg-kostyrko/full/QWqdwxv)

## Конвертирование файла

Конвертирование одного файла QSP в qsps делается следующим образом:

1. Создаём экземпляр класса `QspToQsps`, не указывая параметров.
2. Для созданного объекта вызываем метод `convert_file()`, указав в качестве параметра путь к конвертируемому файлу QSP.

Пример:

Сконвертирует в qsps-формат файл `tooloz.qsp`:

```python
qsp_to_qsps = QspToQsps()
qsp_to_qsps.convert_file('tooloz.qsp')
```

Далее можно работать с данными в экземпляре класса, используя другие методы.

### Результат работы

Рядом с исходным файлом создаётся одноимённый файл qsps. Первые три строки этого файла выглядят примерно так:

```qsp
QSP-Game Game-File-Name
Число локаций: 134
Пароль на исходном файле: Pass
```

, где:

* "Game-File-Name" — название исходного файла;
* "134" — число получившихся локаций в конечном файле (для сравнения с числом локаций в исходном);
* "Pass" — пароль на исходном файле. Если стоит слово "No", пароль не установлен.

## Декодирование фрагмента текста

В класс встроены статические методы, которые позволяют декодировать строку текста в формате QSP в обычную строку. Это может быть необходимо, если вы хотите декодировать, например, только пароль игры.

```python
print(QspToQsps.decode_string(f'зоеиZлпеЭZвпццсфеЭ'))
```

## Общее декодирование

Вам может потребоваться более гибкая работа при декодировании игры, например, сконвертировать одну локацию, или исключить несколько. Для этого в конвертере предусмотрены различные методы обработки данных.

В момент создания экземпляр класса пуст и не хранит никаких данных.

### Создание экземпляра класса

```python
qsp_to_qsps = QspToQsps()
```

### .conver_file()

Конвертирует указанный файл в файл qsps.

```python
.convert_file(input_file:str) -> output_file:str
```

Параметры:

- `input_file` — путь к конвертируемому файлу (обязательный).

Возвращает:

- путь к полученному файлу.

### .read_from_file()

Считывает данные с указанного файла и записывает в экземпляр класса.

```python
.read_from_file(input_file:str=None) -> None
```

Параметры:

- `input_file` — путь к считываемому файлу. Если указан, на основе этого пути [устанавливаются параметры различных путей](#.set_input_file()) в экземпляре класса. Если не указан, данные считываются из файла, который уже был прописан в поле экземпляра класса.

### .save_to_file()

Записывает данные сконвертированной игры из экземпляра класса в указанный файл.

```python
.save_to_file(output_file:str=None) -> None
```

Параметры:

- `output_file` — путь к записываемому файлу. Если не указан, используется путь к выходному файлу, прописанный в экземпляре класса.

### .set_input_file()

Устанавливает в экземпляре класса различные пути: путь к исходному файлу, путь к записываемому файлу, путь к выходной папке и чистое имя файла без расширения.

```python
.set_input_file(input_file:str) -> None
```

Параметры:

- `input_file` — путь к исходному файлу. Обязателен.

### .set_qsp_source_text()

Добавляет в экземпляр класса исходные данные для конвертирования.

```python
.set_qsp_source_text(qsp_source_text:str) -> None
```

Параметры:

- `qsp_source_text` — данные для конвертирования в формате QSP. Например, считанные другими методами из QSP-файла Обязателен.

### .split_qsp()

Разделяет исходные данные формата QSP на отдельные локации и конвертирует всю информацию, которую можно конвертировать, сохраняя её в экземпляре класса.

```python
.split_qsp() -> None
```

### .to_qsps()

Конвертирует все собранные на предыдущих этапах данные в qsps-формат.

```python
.to_qsps() -> qsps_text:str
```

Возвращает:

- текст игры в формате qsps.

### .get_locations()

Возвращает список [локаций](#Локации). Параметры не указываются.

### .get_location()

Возвращает локацию из экземпляра класса по индексу.

```python
.get_location(index:int) -> location:dict
```

Параметры:

- `index` — номер локации в списке локаций в экземпляре класса.

Возвращает:

- [локацию](#Локации) в виде словаря.

### .get_location_by_name()

Возвращает локацию из экземпляра класса по названию. Данная функция использует для поиска локации цикл.

```python
.get_location_by_name(name:str) -> location:dict
```

Параметры:

- `name` — название локации.

Возвращает:

- [локацию](#Локации) в виде словаря. Если в игре будут присутствовать более, чем одна локация с указанным названием, возвращена будет только первая.

### .convert_location()

Конвертирует локацию, переданную в виде словаря, в qsps-формат. Статический метод.

```python
.convert_location(location:dict) -> qsps_text:str
```

Параметры:

- `location` — [локация](#Локации) в виде словаря.

Возвращает:

-  Локацию в формате qsps в виде текста.

### .base_is_exist()

Проверяет наличие на локации базового описания или действий. Статический метод.

```python
.base_is_exist(location:dict) -> bool
```

Параметры:

- `location` — [локация](#Локации) в виде словаря.

Возвращает:

-  `True` если на локации есть базовое описание или базовые действия.

### .convert_description()

Конвертирует локацию, переданную в виде словаря, в qsps-формат. Статический метод.

```python
.convert_description(description:str) -> qsps_text:str
```

Параметры:

- `description` — описание локации. Представляет собой хотя и декодированную, но сырую строку текста, которую необходимо преобразовать в код QSP.

Возвращает:

-  Базовое описание локации в формате QSP.

### .convert_actions()

Конвертирует список действий в текст в формате qsps. Статический метод.

```python
.convert_actions(actions:list) -> qsps_text:str
```

Параметры:

- `actions` — список [базовых действий локации](#Действия).

Возвращает:

-  Базовые действия локации в виде QSP-кода (текст в формате qsps).

### .convert_action()

Конвертирует действие в текст в формате qsps. Статический метод.

```python
.convert_action(action:dict) -> qsps_text:str
```

Параметры:

- `action` — [базовое действие локации](#Действия) в виде словаря.

Возвращает:

-  Базовое действие локации в виде QSP-кода (текст в формате qsps).

### .escape_qsp_string()

В строке дублирует апострофы.  Таким образом осуществляется экранирование от кода QSP. Статический метод.

```python
.escape_qsp_string(input_string:str) -> output_string:str
```

Параметры:

- `input_string` — строка к обработке.

Возвращает:

-  строку, в которой все апострофы заменены двумя апострофами.

### .decode_int()

Декодирует QSP-строку и преобразует в целое число. Служит в моментах, когда нужно декодировать строку и получить число локаций или действий. Статический метод.

```python
.decode_int(qsp_line:str) -> int
```

Параметры:

- `qsp_line` — строка к обработке.

Возвращает:

-  целое число. Например, число локаций в файле.

### .decode_string()

Декодирует QSP-строку. Статический метод.

```python
.decode_string(qsp_line:str) -> str
```

Параметры:

- `qsp_line` — строка к обработке.

Возвращает:

-  человеко-читаемая строка для формата qsps.

### .decode_qsp_line()

Декодирует QSP-строку. Статический метод.

```python
.decode_qsp_line(qsp_line:str) -> str
```

Параметры:

- `qsp_line` — строка к обработке.

Возвращает:

-  человеко-читаемая строка для формата qsps.

## Структура данных экземпляра класса

### Локации

Локации внутри экземпляра класса представляют из себя словари подобного вида:

```python
{
	"name": location_name:str, # название локации
	"description": location_desc:str, # базовое описание локации
	"code": location_code:str, # код локации (выполнить при посещении)
	"actions": actions:list[dict] # список базовых действий локации
}
```

### Действия

Действия внутри экземпляра класса представляют из себя словари подобного вида:

```python
{
	"image": action_image:str, # изображение для действия
	"name": action_name:str, # название действия
	"code": action_code:str # код действия
}
```

### Пути

- `self.input_file` — путь ко входному QSP-файлу. Файл-исходник. 
- `self.output_folder` — путь к выходной папке. Такой путь обычно совпадает с папкой входного файла.
- `self.file_name` — имя файла без расширения.
- `self.output_file` — путь к выходному qsps-файлу.

### Другие поля

- `self.location_count` — число локаций, извлечённых из исходника.
- `self.locations` — список локаций, извлечённых из исходника.
- `self.qsp_source_text` — исходный текст, формат QSP файла.
- `self.qsps_text` — текст формата qsps (он же TXT2GAM) для всего файла.
- `self.pasword` — извлечённый из исходного файла пароль