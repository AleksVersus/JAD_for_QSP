# Конвертер `qsps_to_qsp.py`

> формат TXT2GAM и qsps — это одно и то же. Это текстовые файлы с особым форматом записи QSP-кода.

Скрипт основан на JS-скрипте Werewolf'а для конвертирования текстовых файлов формата qsps в файлы QSP: [https://codepen.io/srg-kostyrko/full/QWqdwxv](https://codepen.io/srg-kostyrko/full/QWqdwxv)

## Конвертирование файла

Конвертирование одного файла qsps в QSP делается следующим образом:

1. Создаём экземпляр класса `NewQspsFile`, не указывая параметров.
2. Для созданного объекта вызываем метод `convert_file()`, указав в качестве параметра путь к конвертируемому файлу qsps.

Пример:

Сконвертирует в QSP-формат файл `tooloz.qsps`:

```python
qsps_to_qsp = NewQspsFile()
qsps_to_qsp.convert_file('tooloz.qsps')
```

Далее можно работать с данными в экземпляре класса, используя другие методы.

### Результат работы

Рядом с исходным файлом создаётся одноимённый QSP-файл. Первые три строки этого файла выглядят примерно так:

```qsp
QSPGAME
qsps_to_qsp SublimeText QSP Package
Ij
```

Подробнее о том, что значат эти строки можно почитать в [описании формата QSP](https://github.com/QSPFoundation/qsp/blob/master/help/gam_desc.txt).

## Работа с экземпляром класса NewQspsFile

Вам может потребоваться более гибкая работа при конвертировании игры, например, сконвертировать одну локацию, или исключить несколько. Для этого в конвертере предусмотрены различные методы обработки данных.

В момент создания экземпляр класса пуст и не хранит никаких данных.

### Создание экземпляра класса

```python
qsps_to_qsp = NewQspsFile()
```

### .conver_file()

Конвертирует указанный файл в файл QSP.

```python
.convert_file(input_file:str) -> output_file:str
```

Параметры:

- `input_file` — путь к конвертируемому файлу (обязательный).

Возвращает:

- путь к полученному файлу.

### .read_from_file()

Считывает данные с указанного файла и записывает в экземпляр класса.

```python
.read_from_file(input_file:str=None) -> None
```

Параметры:

- `input_file` — путь к считываемому файлу. Если указан, на основе этого пути [устанавливаются параметры различных путей](#.set_input_file()) в экземпляре класса. Если не указан, данные считываются из файла, который уже был прописан в поле экземпляра класса.

### .save_to_file()

Записывает данные сконвертированной игры из экземпляра класса в указанный файл.

```python
.save_to_file(output_file:str=None) -> None
```

Параметры:

- `output_file` — путь к записываемому файлу. Если не указан, используется путь к выходному файлу, прописанный в экземпляре класса.

### .set_input_file()

Устанавливает в экземпляре класса различные пути: путь к исходному файлу, путь к записываемому файлу, путь к выходной папке и чистое имя файла без расширения.

```python
.set_input_file(input_file:str) -> None
```

Параметры:

- `input_file` — путь к исходному файлу. Обязателен.

### .set_file_source()

Добавляет в экземпляр класса исходные данные для конвертирования.

```python
.set_file_source(file_Strings:list) -> None
```

Параметры:

- `file_strings` — данные для конвертирования в формате qsps. Например, считанные другими методами из qsps-файла Обязателен. Данные представляют собой список строк обычного текстового файла.

### .split_to_locations()

Разделяет исходные данные формата qsps на отдельные [локации](#Локации).

```python
.split_qsp() -> None
```

### .append_location()

Добавляет локацию в список локаций.

```python
.append_location(location:NewQspLocation) -> None
```

Параметры:

- `location` — локация в виде экземпляра класса [NewQspLocation](#Локации).

### .to_qsp()

Конвертирует все собранные на предыдущих этапах данные в QSP-формат.

```python
.to_qsp() -> None
```

Функция ничего не возвращает, однако сконвертированные строки помещаются в поле `converted_strings` экземпляра класса.

### .get_qsplocs()

Возвращает список списков, состоящих из названия локации и региона в файле, где это название прописано.

```python
.get_qsplocs() -> list[location_name:str, locname_region:tuple]
```

Возвращает:

- Список списков, первый элемент в которых — имя [локации](#Локации), а второй элемент — регион в файле, в котором находится это имя.

### .parse_string()

Парсит открытие строк в коде локаций, или в других местах, чтобы своевременно переключать режимы и допускать внутри строк паттерны токенов, размечающих содержимое игры.

```python
.parse_string(qsps_line:str, mode:dict) -> None
```

Параметры:

- `qsps_line` — строка к обработке.
- `mode` — [словарь режимов](#словарь%20режимов).

Результат распарсивания строк записывается в словарь режимов `mode`.

### .decode_qsps_line()

Кодирует qsps-строку. Статический метод.

```python
.decode_qsps_line(qsps_line:str) -> str
```

Параметры:

- `qsps_line` — строка к обработке.

Возвращает:

-  зашифрованная строка, необходимая для записи в файл QSP.

## Структура данных экземпляра класса

### Локации

Локации внутри экземпляра класса представляют из себя словари подобного вида:

```python
{
	"name": location_name:str, # название локации
	"description": location_desc:str, # базовое описание локации
	"code": location_code:str, # код локации (выполнить при посещении)
	"actions": actions:list[dict] # список базовых действий локации
}
```

### Действия

Действия внутри экземпляра класса представляют из себя словари подобного вида:

```python
{
	"image": action_image:str, # изображение для действия
	"name": action_name:str, # название действия
	"code": action_code:str # код действия
}
```

### словарь режимов

Это словарь, в котором перечислены режимы, необходимые для распарсивания текущего исходного кода.

```python
{
	'open-string': '', # содержит символы открытия строки по порядку кавычки, апострофы, фигурные скобки
	
}
```

### Пути

- `self.input_file` — путь ко входному QSP-файлу. Файл-исходник. 
- `self.output_folder` — путь к выходной папке. Такой путь обычно совпадает с папкой входного файла.
- `self.file_name` — имя файла без расширения.
- `self.output_file` — путь к выходному qsps-файлу.

### Другие поля

- `self.location_count` — число локаций, извлечённых из исходника.
- `self.locations` — список локаций, извлечённых из исходника.
- `self.qsp_source_text` — исходный текст, формат QSP файла.
- `self.qsps_text` — текст формата qsps (он же TXT2GAM) для всего файла.
- `self.pasword` — извлечённый из исходного файла пароль