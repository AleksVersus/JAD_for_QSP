# Препроцессор

Препроцессор - это набор команд предобработки исходного текста программы перед компиляцией. В нашем случае, до того, как мы сконвертируем файлы проекта в конечные файлы .qsp мы можем исключить из этих файлов некоторые строки. Препроцессор этот я пишу с нуля и вручную, поэтому будут баги и логические ошибки в работе команд. Я ни разу не пользовался сторонними препроцессорами, поэтому могу изобрести велосипед там, где все гоняют на Kawasaki z900.

Препроцессор не должен обладать полноценным языком программирования, он - лишь вспомогательный инструмент.

## Правила:

1. Команды препроцессора всегда записываются в одну строку.
2. Все команды, имена меток, переменных и т.д. пишутся в нижнем регистре.
3. Все команды препроцессора при включенном препроцессинге удаляются из конечного файла.

## Включение препроцессора

1. Включить препроцессор сразу для всего проекта можно, указав в "`project.json`" значение:
	```json
		"preprocessor":"On",
	```
	При этом абсолютно все файлы будут подвергаться препроцессингу, в т.ч. исходники модулей. Всё, что собирается проектом, будет обработано перед сборкой. Исключение составляют файлы, для которых препроцессинг отключается командой `!@pp:off`.

2. Включить препроцессор только для одного файла можно командой:
	```
		!@pp:on
	```
	Эту команду необходимо указать первой или второй строкой в обрабатываемом файле.

## Выключение препроцессора

1. Для всего проекта можно использовать значение в "`project.json`":
	```json
		"preprocessor":"Off",
	```
	Данное значение является значением по умолчанию, поэтому его можно не указывать. При этом файлы, поставленные в обработку командой `!@pp:on`, всё равно будут обрабатываться препроцессором.

2. Другое значение, полностью исключающее препроцессинг проекта:
	```json
		"preprocessor":"Hard-off",
	```
	Данное значение отключает препроцесинг абсолютно для всех файлов, даже если в файлах проставлены команды `!@pp:on`.

3. Из препроцессинга исключаются файлы, содержащие команду:
	```
		!@pp:off
	```
	Эту команду необходимо указать первой или второй строкой в обрабатываемом файле. Даже при включенном режиме обработки абсолютно всех файлов, эта команда исключит файл из обработки.

## Команды и инструкции

`!@pp:on` — включает препроцессинг для текущего файла. Данная команда должна идти первой или второй строкой в файле.
`!@pp:off` — выключает препроцессинг для текущего файла. Данная команда должна идти первой или второй строкой в файле.

`!@ ` — комментарий, начинающийся с такого сочетания символов, будет удалён при препроцессинге. Инструкция.
`!@<` — комментарий, начинающийся с такого сочетания символов, а так же строка, в которой стоит этот комментарий, будут удалены при препроцессинге. Инструкция.

`!@pp:savecomm` - данная команда отключает удаление комментариев, начинающихся с `!@ ` и `!@<`. Действует до конца файла, либо пока не встретится нижеследующая команда.
`!@pp:nosavecomm` - данная команда включает удаление комментариев, начинающихся с `!@ ` и `!@<`.

`!@pp:var(name=123)` - данная команда объявляет переменную *name* со значением **123**.

`!@pp:if(name==123):exclude` - данная команда проверяет, выполняется ли условие в скобках (содержит ли переменная *name* значение **123**), и если условие выполняется, исключает нижеследующие строки кода из конечного файла. Вместо слова `exclude` можно использовать другие ключевые слова:

`exclude` — исключить последующие строки из конечного файла при выполнении условия. Если условие не будет выполнено, строки будут обработаны препроцессором и включены в конечный файл.
`include` — последующие строки должны быть включены в конечный файл при выполнении условия, при этом строки будут обработаны препроцессором. Если условие не будет выполнено, строки не будут включены в конечный файл.
`nopp` — не обрабатывать строки препроцессором при выполнении условия.

Можно комбинировать `exclude nopp` и `include nopp`. При этом будет отключаться обработка препроцессором соответственно при невыполнении и выполнении условия.

`!@pp:endif` - данная команда указывает окончание блока условия.

## примеры:

```qsp
	!@pp:on
	!@pp:var(layer=1)
	# start
		"Текст, который мы увидим на локации."
		!@pp:if(layer==1):include
			"Этот текст будет включён в конечный файл" & !@ а этот комментарий будет удалён
			"Этот текст будет удалён" & !@< вместе с комментарием, потому что препроцессор работает
		!@pp:endif
		!@pp:if(layer==1):exclude
			"Этот текст будет исключён из конечного файла" & ! и комментарий тоже
		!@pp:endif
	- start
```

```qsp
	!@pp:on
	!@pp:var(layer=0)
	# start
		"Текст, который мы увидим на локации."
		!@pp:if(layer==1):include
			"Этот текст не будет включён в конечный файл"
		!@pp:endif
		!@pp:if(layer==1):exclude
			"Этот текст не будет исключён из конечного файла" & ! и комментарий тоже
			name=123 & !@< а вот эта строка кода будет удалена
		!@pp:endif
	- start
```